<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iOS Theme Studio</title>
    <link rel="stylesheet" href="style.css">
<style>
/* --- 基础样式 --- */
:root { --app-font-size: 11px; --bg-color: #f2f2f7; --separator-color: #c6c6c8; --blue: #007aff; --red: #ff3b30; --green: #34c759; --orange: #ff9500; --purple: #af52de; --teal: #5ac8fa; }
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background-color: #000;
    height: 100vh; width: 100vw; overflow: hidden;
    display: flex; justify-content: center;
}

/* --- SVG 图标通用类 --- */
.svg-icon { width: 24px; height: 24px; fill: currentColor; }

/* --- 屏幕容器 --- */
.screen {
    width: 100%; height: 100%;
    background: linear-gradient(180deg, #2c3e50 0%, #4ca1af 100%);
    background-size: cover; background-position: center;
    position: relative; display: flex; flex-direction: column; justify-content: space-between;
    padding-top: env(safe-area-inset-top, 44px);
    padding-bottom: env(safe-area-inset-bottom, 20px);
    transition: background 0.3s ease;
}

.status-bar-placeholder { height: 20px; width: 100%; flex-shrink: 0; }

/* --- 桌面布局 --- */
.home-grid {
    flex: 1; display: grid;
    grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(7, 1fr);
    gap: 15px 10px; padding: 20px 20px 0 20px;
    justify-items: center; align-items: start;
}

/* --- 小组件样式 --- */
.widget-item {
    grid-column: 1 / span 4; grid-row: 1 / span 2;
    width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    display: flex; justify-content: space-between; align-items: center;
    padding: 20px; color: white; position: relative;
    background-size: cover; background-position: center; cursor: pointer; overflow: hidden;
}
.widget-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.2); z-index: 0; pointer-events: none; }
.widget-left { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; z-index: 1; width: 40%; }
.widget-avatar {
    width: 60px; height: 60px; border-radius: 50%;
    background-color: rgba(255,255,255,0.3);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E");
    background-size: 60%; background-repeat: no-repeat; background-position: center;
    border: 2px solid rgba(255,255,255,0.6); cursor: pointer;
}
.widget-text {
    font-size: 14px; font-weight: 500; text-align: center;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 8px;
    cursor: pointer; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.widget-right { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; z-index: 1; text-align: right; }
.widget-time { font-size: 42px; font-weight: 300; line-height: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
.widget-date { font-size: 14px; font-weight: 500; margin-top: 5px; opacity: 0.9; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }

/* --- APP 样式 --- */
.grid-cell { width: 100%; height: 100%; display: flex; justify-content: center; align-items: flex-start; position: relative; }
.app-item { display: flex; flex-direction: column; align-items: center; width: 100%; cursor: pointer; position: relative; z-index: 1; }
.app-item.dragging { opacity: 0.5; }
.app-ghost { position: fixed; pointer-events: none; z-index: 9999; width: 70px; height: 70px; opacity: 0.9; transform: scale(1.1); display: flex; flex-direction: column; align-items: center; }
.app-ghost .app-icon { box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
.app-ghost .app-name { display: none; }

.app-icon {
    width: 60px; height: 60px;
    background-color: #f0f0f0; background-size: cover; background-position: center;
    border-radius: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 5px; transition: transform 0.1s; position: relative;
    display: flex; align-items: center; justify-content: center;
}
.app-icon:active { filter: brightness(0.8); transform: scale(0.95); }
.app-name {
    color: white; font-size: var(--app-font-size);
    text-shadow: 0 1px 2px rgba(0,0,0,0.5); text-align: center;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;
    transition: font-size 0.1s; pointer-events: none;
}
.default-icon-svg { width: 32px; height: 32px; fill: #8e8e93; }
.app-icon[style*="url"] .default-icon-svg { display: none; }

/* --- Dock 栏 --- */
.dock-container { padding: 15px 15px 30px 15px; width: 100%; display: flex; justify-content: center; flex-shrink: 0; }
.dock {
    width: 100%; height: 90px;
    background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
    border-radius: 35px; display: flex; justify-content: space-around; align-items: center; padding: 0 15px;
}
.dock .app-item { width: auto; }
.dock .app-icon { margin-bottom: 0; }
@media (min-width: 400px) { .app-icon { width: 68px; height: 68px; border-radius: 16px; } }

/* --- 模态框通用 --- */
.settings-modal {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-color: var(--bg-color); z-index: 1000;
    transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
    display: flex; flex-direction: column; padding-top: env(safe-area-inset-top, 20px);
}
.settings-modal.open { transform: translateY(0); }

/* 子页面 (从右侧滑入) */
.settings-modal.sub-page { transform: translateX(100%); z-index: 1100; }
.settings-modal.sub-page.open { transform: translateX(0); }

.settings-header {
    padding: 0 15px; background: #fff; display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid #e5e5e5; height: 50px; flex-shrink: 0;
}
.header-left, .header-right { width: 80px; display: flex; align-items: center; }
.header-right { justify-content: flex-end; }
.header-title { font-weight: 600; font-size: 17px; flex: 1; text-align: center; }
.nav-btn { color: var(--blue); background: none; border: none; font-size: 17px; cursor: pointer; padding: 10px 0; display: flex; align-items: center; }
.back-svg { width: 20px; height: 20px; fill: var(--blue); margin-right: 2px; }

.settings-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; position: relative; }

/* --- Theme Studio 样式 --- */
.tab-content { display: none; animation: fadeIn 0.3s ease; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
.settings-tab-bar {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 60px;
    background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);
    border-top: 1px solid #c6c6c8;
    display: flex; justify-content: space-around; align-items: center;
    padding-bottom: env(safe-area-inset-bottom, 10px); z-index: 10;
}
.tab-item { flex: 1; display: flex; align-items: center; justify-content: center; height: 100%; color: #999; font-size: 16px; font-weight: 600; cursor: pointer; flex-direction: column; gap: 4px; }
.tab-item.active { color: var(--blue); }
.tab-icon { width: 24px; height: 24px; fill: currentColor; }
.tab-label { font-size: 10px; }

.settings-group { background: #fff; border-radius: 10px; margin-bottom: 20px; padding: 0 15px; overflow: hidden; }
.settings-title { font-size: 13px; color: #6d6d72; margin-bottom: 8px; margin-left: 15px; text-transform: uppercase; }
.settings-row { padding: 12px 0; border-bottom: 1px solid #e5e5e5; display: flex; flex-direction: column; gap: 8px; }
.settings-row:last-child { border-bottom: none; }
.row-label { font-size: 15px; font-weight: 500; }

/* iOS 风格输入框通用样式 */
input[type="text"], input[type="password"], select, textarea { 
    width: 100%; padding: 10px; border: 1px solid #e5e5e5; border-radius: 8px; 
    font-size: 16px; background: #f9f9f9; -webkit-appearance: none; font-family: inherit; 
}

/* 特殊 iOS 风格圆角输入框 (用于 Select 和 Textarea) */
.ios-select, .ios-textarea {
    background-color: #f2f2f7;
    border: none;
    border-radius: 10px;
    padding: 12px;
    font-size: 16px;
    color: #000;
    width: 100%;
    -webkit-appearance: none;
    appearance: none;
}
.ios-select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='%238e8e93'%3E%3Cpath d='M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 30px;
}
.ios-textarea {
    min-height: 120px;
    resize: none;
}

textarea { resize: vertical; min-height: 100px; }
input[type="range"] { width: 100%; margin: 10px 0; accent-color: var(--blue); }
button.action-btn { width: 100%; padding: 12px; background-color: var(--blue); color: white; border: none; border-radius: 10px; font-size: 15px; cursor: pointer; font-weight: 600; margin-top: 5px; }
button.action-btn.secondary { background-color: #e5e5ea; color: #000; }
button.action-btn.destructive { background-color: #ff3b30; color: white; margin-top: 10px; }

/* 壁纸网格 & 预设 */
.wallpaper-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px 0; }
.wallpaper-item { aspect-ratio: 9/16; border-radius: 8px; background-size: cover; background-position: center; position: relative; cursor: pointer; border: 2px solid transparent; overflow: hidden; }
.wallpaper-delete { position: absolute; top: 0; right: 0; width: 30px; height: 30px; background: rgba(0,0,0,0.5); color: white; border-bottom-left-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; z-index: 2; }
.preset-list { display: flex; flex-wrap: wrap; gap: 10px; min-height: 30px; }
.preset-tag { background: var(--blue); color: white; padding: 0; border-radius: 18px; font-size: 13px; display: flex; align-items: stretch; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; }
.preset-name { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; }
.preset-delete { background: rgba(0,0,0,0.15); width: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; font-weight: bold; border-left: 1px solid rgba(255,255,255,0.1); }

/* App 编辑 */
.app-edit-item { display: flex; align-items: center; gap: 15px; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
.hidden-file-input { display: none; }
.app-edit-preview { width: 54px; height: 54px; background-color: #f0f0f0; border-radius: 12px; background-size: cover; background-position: center; flex-shrink: 0; cursor: pointer; position: relative; border: 1px solid #e5e5e5; display: flex; align-items: center; justify-content: center; }
.camera-icon { width: 24px; height: 24px; fill: #999; opacity: 0.5; }
.app-edit-preview[style*="url"] .camera-icon { display: none; }
.app-edit-inputs { flex: 1; display: flex; flex-direction: column; gap: 8px; }

/* --- iOS 设置页面样式 --- */
.ios-settings-content { padding: 0; background-color: #f2f2f7; }
.ios-search-bar { padding: 10px 16px; background: #f2f2f7; }
.ios-search-input { width: 100%; background: #e3e3e8; border: none; border-radius: 10px; padding: 8px 12px; font-size: 16px; color: #000; text-align: center; }

.ios-profile-card { display: flex; align-items: center; background: #fff; padding: 12px 16px; margin-bottom: 20px; cursor: pointer; }
.ios-profile-card:active { background-color: #e5e5e5; }
.ios-profile-avatar { width: 60px; height: 60px; border-radius: 50%; background: #e5e5ea; margin-right: 15px; display: flex; align-items: center; justify-content: center; color: #8e8e93; font-size: 24px; font-weight: 500; background-size: cover; background-position: center; overflow: hidden; }
.ios-profile-info { flex: 1; }
.ios-profile-info h3 { font-size: 19px; font-weight: 400; margin-bottom: 4px; }
.ios-profile-info p { font-size: 13px; color: #333; }

.ios-list-group { background: #fff; margin-bottom: 20px; border-top: 1px solid #e5e5e5; border-bottom: 1px solid #e5e5e5; }
@media (min-width: 400px) { .ios-list-group { border-radius: 10px; margin: 0 16px 20px 16px; border: none; } }

.ios-list-item { display: flex; align-items: center; padding-left: 16px; min-height: 44px; cursor: pointer; }
.ios-list-item:active { background-color: #e5e5e5; }
.ios-icon-box { width: 29px; height: 29px; border-radius: 7px; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0; }
.ios-icon-box svg { width: 18px; height: 18px; fill: white; }

.ios-item-content { flex: 1; display: flex; align-items: center; justify-content: space-between; padding-right: 16px; padding-top: 11px; padding-bottom: 11px; border-bottom: 1px solid #e5e5e5; height: 100%; }
.ios-list-item:last-child .ios-item-content { border-bottom: none; }

.ios-item-label { font-size: 16px; color: #000; }
.ios-item-right { display: flex; align-items: center; color: #8e8e93; font-size: 16px; }
.chevron-right { width: 14px; height: 14px; fill: #c7c7cc; margin-left: 6px; opacity: 0.7; }

/* --- Apple ID 页面专用样式 --- */
.profile-header {
    display: flex; flex-direction: column; align-items: center; padding: 30px 0; background: #fff; border-bottom: 1px solid #e5e5e5;
}
.profile-header-avatar {
    width: 80px; height: 80px; border-radius: 50%; background: #e5e5ea; margin-bottom: 15px;
    background-size: cover; background-position: center; position: relative; cursor: pointer;
    display: flex; align-items: center; justify-content: center; font-size: 32px; color: #8e8e93;
}
.profile-edit-badge {
    position: absolute; bottom: 0; right: 0; background: var(--blue); color: white;
    font-size: 10px; padding: 2px 6px; border-radius: 10px; border: 2px solid #fff;
}
.profile-header-name { font-size: 22px; font-weight: 600; margin-bottom: 5px; cursor: pointer; }
.profile-header-email { font-size: 14px; color: #8e8e93; }

/* --- 存储分析弹窗样式 --- */
.storage-chart-container {
    display: flex; flex-direction: column; align-items: center; padding: 20px;
}
.chart-wrapper { position: relative; width: 180px; height: 180px; margin-bottom: 20px; }
.chart-canvas { width: 100%; height: 100%; transform: rotate(-90deg); }
.chart-center-text {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    text-align: center;
}
.chart-total { font-size: 24px; font-weight: 600; color: #000; }
.chart-label { font-size: 12px; color: #8e8e93; }

.chart-legend { width: 100%; display: flex; flex-direction: column; gap: 8px; }
.legend-item { display: flex; align-items: center; font-size: 14px; }
.legend-color { width: 12px; height: 12px; border-radius: 3px; margin-right: 10px; }
.legend-name { flex: 1; }
.legend-value { color: #8e8e93; }

/* --- 世界书 (Worldbook) 样式 --- */
.wb-view-container {
    display: flex; width: 200%; height: 100%;
    transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
}
.wb-view-page { width: 50%; height: 100%; overflow-y: auto; position: relative; padding-bottom: 80px; }

.wb-list-container { background: #fff; border-top: 1px solid #e5e5e5; border-bottom: 1px solid #e5e5e5; }
.wb-list-item-wrapper { position: relative; overflow: hidden; border-bottom: 1px solid #e5e5e5; height: 60px; }
.wb-list-item-wrapper:last-child { border-bottom: none; }

/* 滑动容器 */
.wb-swipe-box {
    display: flex; width: 100%; height: 100%;
    transition: transform 0.2s ease-out;
    will-change: transform;
}

.wb-list-item {
    width: 100%; flex-shrink: 0; background: #fff;
    display: flex; align-items: center; padding: 0 16px;
    cursor: pointer;
}
.wb-list-item:active { background-color: #f2f2f7; }

.wb-item-info { flex: 1; overflow: hidden; }
.wb-item-title { font-size: 17px; font-weight: 600; color: #000; margin-bottom: 4px; }
.wb-item-desc { font-size: 13px; color: #8e8e93; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.wb-item-type { font-size: 12px; color: var(--blue); background: rgba(0,122,255,0.1); padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }

.wb-delete-btn {
    width: 80px; height: 100%; background: var(--red); color: white;
    display: flex; align-items: center; justify-content: center;
    font-weight: 600; font-size: 15px; flex-shrink: 0;
}

/* 分组视图样式 */
.wb-group-item { background: #fff; border-bottom: 1px solid #e5e5e5; }

/* 分组头部滑动容器 */
.wb-group-swipe-wrapper { position: relative; overflow: hidden; height: 50px; background: #fff; }

.wb-group-header {
    padding: 0 16px; display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; background: #fff; width: 100%; height: 100%; flex-shrink: 0;
}
.wb-group-header:active { background: #f2f2f7; }
.wb-group-name { font-size: 17px; font-weight: 600; }
.wb-group-count { color: #8e8e93; font-size: 15px; }

.wb-group-content {
    max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;
    background: #f9f9f9;
}
.wb-group-content.expanded { max-height: 1000px; transition: max-height 0.5s ease-in; }

/* 分组内条目紧凑样式 */
.wb-group-content .wb-list-item-wrapper { 
    border-bottom: 1px solid #e5e5e5; 
    padding-left: 16px; 
    height: 44px; /* 紧凑高度 */
}
.wb-group-content .wb-list-item { 
    background: #f9f9f9; 
    padding: 10px 16px 10px 0; /* 10px Padding */
    height: 100%;
}
.wb-group-content .wb-item-title { font-size: 15px; margin-bottom: 0; }
.wb-group-content .wb-item-desc { display: none; } /* 紧凑模式隐藏描述 */
.wb-group-content .wb-item-type { display: none; } /* 紧凑模式隐藏类型标签 */

.wb-add-group-btn {
    margin: 20px 16px; padding: 12px; background: #e5e5ea; color: var(--blue);
    text-align: center; border-radius: 10px; font-weight: 600; cursor: pointer;
}

/* --- 通用弹窗 --- */
.custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
.custom-modal-overlay.active { opacity: 1; pointer-events: auto; }
.custom-modal { background: rgba(245, 245, 245, 0.95); backdrop-filter: blur(10px); width: 280px; border-radius: 14px; overflow: hidden; text-align: center; transform: scale(1.1); transition: transform 0.2s; }
.custom-modal-overlay.active .custom-modal { transform: scale(1); }
.modal-title { padding: 20px 15px 5px 15px; font-weight: 600; font-size: 17px; }
.modal-desc { padding: 0 15px 15px 15px; font-size: 13px; color: #666; }
.modal-input-container { padding: 0 15px 15px 15px; display: none; }
.modal-input-container.show { display: block; }
.modal-input-container input { background: #fff; border: 1px solid #ccc; text-align: left; }
.modal-buttons { display: flex; border-top: 1px solid #ccc; }
.modal-btn { flex: 1; padding: 12px; background: transparent; border: none; font-size: 17px; cursor: pointer; color: var(--blue); border-right: 1px solid #ccc; }
.modal-btn:last-child { border-right: none; font-weight: 600; }
.modal-btn.destructive { color: #ff3b30; }
.modal-btn:active { background: rgba(0,0,0,0.05); }

/* ========================================== */
/* WeChat App 样式 (前缀隔离 wc-) */
/* ========================================== */
#wechat-root {
    --wc-bg-color: #F2F2F7;
    --wc-chat-bg: #EDEDED;
    --wc-card-color: #FFFFFF;
    --wc-text-primary: #000000;
    --wc-text-secondary: #8E8E93;
    --wc-accent-blue: #007AFF;
    --wc-accent-green: #34C759;
    --wc-danger-red: #FF3B30;
    --wc-pin-gray: #C7C7CC;
    --wc-transfer-orange: #FA9D3B;
    --wc-separator: #C6C6C8;
    --wc-safe-area-top: env(safe-area-inset-top, 20px);
    --wc-safe-area-bottom: env(safe-area-inset-bottom, 20px);
    --wc-input-height: 56px;
    --wc-panel-height: 300px;
    --wc-navbar-height: 54px;

    width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
    background-color: var(--wc-bg-color);
    color: var(--wc-text-primary);
    display: flex;
    flex-direction: column;
}

#wechat-root * {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
    outline: none;
    user-select: none;
}

#wechat-root input, #wechat-root textarea {
    user-select: auto;
}

/* SVG Icons Class */
.wc-icon {
    width: 24px;
    height: 24px;
    stroke: currentColor;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
    fill: none;
}
.wc-icon-fill {
    fill: currentColor;
    stroke: none;
}

/* Navbar */
.wc-navbar {
    height: calc(var(--wc-navbar-height) + var(--wc-safe-area-top));
    padding-top: var(--wc-safe-area-top);
    background: rgba(242, 242, 247, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-left: 16px;
    padding-right: 16px;
    position: absolute;
    top: 0;
    width: 100%;
    z-index: 1300;
    border-bottom: 0.5px solid rgba(0,0,0,0.1);
}

.wc-nav-left, .wc-nav-right {
    width: 80px;
    display: flex;
    align-items: center;
}

.wc-nav-right {
    justify-content: flex-end;
    gap: 15px;
}

.wc-nav-title {
    font-weight: 600;
    font-size: 18px;
    flex: 1;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.wc-nav-btn {
    background: none;
    border: none;
    color: var(--wc-text-primary);
    font-size: 16px;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
}

/* Main Content */
.wc-main-content {
    flex: 1;
    overflow-y: auto;
    padding-top: calc(var(--wc-navbar-height) + var(--wc-safe-area-top));
    padding-bottom: 80px;
    -webkit-overflow-scrolling: touch;
}

.wc-page {
    display: none;
    padding: 16px;
    min-height: 100%;
}

.wc-page.active {
    display: block;
    animation: wcFadeIn 0.2s ease;
}

/* Chat Detail Page */
#wc-view-chat-detail {
    padding: 0;
    background-color: var(--wc-chat-bg);
    display: none;
    flex-direction: column;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1100;
}

#wc-view-chat-detail.active {
    display: flex;
}

.wc-chat-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    opacity: 1;
    z-index: -1;
}

.wc-chat-scroll-area {
    flex: 1;
    overflow-y: auto;
    padding: calc(var(--wc-navbar-height) + var(--wc-safe-area-top) + 10px) 16px calc(var(--wc-input-height) + var(--wc-safe-area-bottom) + 40px) 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    transition: padding-bottom 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
    position: relative;
    z-index: 1;
    overscroll-behavior: none;
}

.wc-chat-scroll-area.panel-open {
    padding-bottom: calc(var(--wc-input-height) + var(--wc-panel-height) + var(--wc-safe-area-bottom) + 40px);
}

/* Message Rows */
.wc-message-row {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    max-width: 100%;
    position: relative;
}

.wc-message-row.me {
    flex-direction: row-reverse;
}

.wc-message-row.system {
    justify-content: center;
    flex-direction: row;
    align-items: center;
    margin: 10px 0;
}

.wc-chat-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
    border: 0.5px solid rgba(0,0,0,0.1);
}

/* Checkbox for Multi-select */
.wc-msg-checkbox {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid #C6C6C8;
    margin-right: 10px;
    display: none;
    flex-shrink: 0;
    align-self: center;
}

.wc-msg-checkbox.checked {
    background: var(--wc-accent-blue);
    border-color: var(--wc-accent-blue);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
    background-size: 70%;
    background-position: center;
    background-repeat: no-repeat;
}

.multi-select-mode .wc-msg-checkbox {
    display: block;
}

/* Bubbles */
.wc-bubble-container {
    display: flex;
    flex-direction: column;
    max-width: 75%;
}

.wc-message-row.me .wc-bubble-container {
    align-items: flex-end;
}

.wc-bubble {
    padding: 3px 15px;
    border-radius: 10px;
    font-size: 16px;
    line-height: 1.5;
    word-wrap: break-word;
    position: relative;
    user-select: text;
    min-height: 32px;
    display: flex;
    align-items: center;
}

.wc-bubble.them {
    background: #F2F2F7;
    color: #000;
    border: none;
}

.wc-bubble.me {
    background: #FFFFFF;
    color: #000;
    border: 0.5px solid rgba(0,0,0,0.05);
}

.wc-bubble-sticker {
    background: transparent !important;
    border: none !important;
    padding: 0;
}

.wc-sticker-img {
    max-width: 120px;
    max-height: 120px;
    border-radius: 4px;
}

.wc-bubble-img {
    max-width: 100%;
    border-radius: 10px;
    display: block;
}

.wc-quote-block {
    font-size: 12px;
    color: #666;
    background: rgba(0,0,0,0.05);
    padding: 2px 8px;
    border-left: 3px solid #C6C6C8;
    margin-bottom: 2px;
    border-radius: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}

/* QQ Style Voice Bubble */
.wc-bubble.voice {
    display: flex;
    align-items: center;
    gap: 4px;
    min-width: 60px;
    cursor: pointer;
    height: 36px;
    padding: 0 12px;
}

.wc-bubble.voice.me { flex-direction: row-reverse; }

.wc-voice-bars {
    display: flex;
    align-items: center;
    gap: 3px;
    height: 16px;
}

.wc-voice-bar {
    width: 3px;
    background-color: #000;
    border-radius: 2px;
    animation: wcVoiceWave 1s infinite ease-in-out;
    animation-play-state: paused;
}

.wc-bubble.voice:active .wc-voice-bar {
    animation-play-state: running;
}

.wc-voice-bar:nth-child(1) { height: 8px; animation-delay: 0s; }
.wc-voice-bar:nth-child(2) { height: 16px; animation-delay: 0.2s; }
.wc-voice-bar:nth-child(3) { height: 10px; animation-delay: 0.4s; }

@keyframes wcVoiceWave {
    0%, 100% { height: 6px; }
    50% { height: 16px; }
}

.wc-bubble.transfer {
    padding: 0;
    background: var(--wc-transfer-orange);
    border: none;
    width: 240px;
    max-width: 100%;
    border-radius: 10px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    cursor: pointer;
}

.wc-bubble.transfer.received {
    background: #F7D6A8;
}

.wc-transfer-content {
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.wc-transfer-icon-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
}

.wc-transfer-info {
    display: flex;
    flex-direction: column;
    color: #fff;
}

.wc-transfer-amount {
    font-size: 16px;
    font-weight: 500;
}

.wc-transfer-desc {
    font-size: 13px;
    opacity: 0.9;
}

.wc-system-msg-text {
    background: rgba(0,0,0,0.1);
    color: #fff;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    text-align: center;
    max-width: 80%;
}

.wc-system-msg-text.transparent {
    background: transparent;
    color: #8E8E93;
}

.wc-msg-timestamp-outside {
    font-size: 10px;
    color: #8E8E93;
    margin: 0 4px;
    white-space: nowrap;
    align-self: flex-end;
    margin-bottom: 2px;
}

/* Context Menu */
#wc-context-menu {
    position: absolute;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 2000;
    display: none;
    flex-direction: column;
    min-width: 150px;
    overflow: hidden;
    animation: wcPopIn 0.1s ease-out;
}

.wc-ctx-item {
    padding: 12px 16px;
    font-size: 14px;
    border-bottom: 0.5px solid rgba(0,0,0,0.1);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
}

.wc-ctx-item:last-child { border-bottom: none; }
.wc-ctx-item:active { background: #F2F2F7; }

/* Chat Footer */
.wc-chat-footer {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #F7F7F7;
    border-top: 0.5px solid #C6C6C8;
    padding: 8px 12px calc(8px + var(--wc-safe-area-bottom)) 12px;
    display: flex;
    align-items: flex-end;
    gap: 10px;
    z-index: 1200;
    transition: bottom 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
}

.wc-chat-footer.panel-active {
    bottom: var(--wc-panel-height);
    padding-bottom: 8px;
}

#wc-quote-preview-area {
    position: absolute;
    top: -40px;
    left: 0;
    width: 100%;
    height: 40px;
    background: rgba(247, 247, 247, 0.95);
    border-top: 0.5px solid #C6C6C8;
    display: none;
    align-items: center;
    padding: 0 12px;
    font-size: 13px;
    color: #666;
    justify-content: space-between;
}

.wc-chat-input {
    flex: 1;
    background: #FFFFFF;
    border: none;
    border-radius: 4px;
    padding: 10px;
    font-size: 16px;
    max-height: 100px;
    min-height: 40px;
    resize: none;
}

.wc-footer-icon {
    width: 28px;
    height: 28px;
    color: #1C1C1E;
    cursor: pointer;
    flex-shrink: 0;
    margin-bottom: 6px;
}

.wc-btn-ai-reply {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    color: var(--wc-accent-blue);
    margin-bottom: 6px;
}

.wc-btn-ai-reply svg {
    width: 28px;
    height: 28px;
    fill: currentColor;
}

/* Multi-select Footer */
#wc-multi-select-footer {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: calc(60px + var(--wc-safe-area-bottom));
    background: #F7F7F7;
    border-top: 0.5px solid #C6C6C8;
    display: none;
    align-items: center;
    justify-content: center;
    gap: 16px;
    z-index: 1250;
    padding-bottom: var(--wc-safe-area-bottom);
}

/* Panel Container */
.wc-panel-container {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: var(--wc-panel-height);
    background: #F2F2F7;
    z-index: 1150;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
    display: flex;
    flex-direction: column;
    border-top: 1px solid #C6C6C8;
    padding-bottom: var(--wc-safe-area-bottom);
}

.wc-panel-container.active {
    transform: translateY(0);
}

/* Sticker Specifics */
.wc-sticker-grid-area {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-auto-rows: max-content;
    gap: 12px;
}

.wc-sticker-tab-bar {
    height: 45px;
    background: #fff;
    display: flex;
    align-items: center;
    border-top: 0.5px solid #E5E5EA;
    overflow-x: auto;
}

.wc-sticker-add-btn {
    width: 50px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    border-right: 0.5px solid #E5E5EA;
    background: #fff;
    flex-shrink: 0;
    cursor: pointer;
}

.wc-sticker-tabs-scroll {
    flex: 1;
    display: flex;
    height: 100%;
    overflow-x: auto;
}

.wc-sticker-tab-item {
    padding: 0 16px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: var(--wc-text-secondary);
    cursor: pointer;
    white-space: nowrap;
    background: #fff;
}

.wc-sticker-tab-item.active {
    background: #F2F2F7;
    color: var(--wc-text-primary);
    font-weight: 500;
}

.wc-sticker-item {
    aspect-ratio: 1;
    background: #fff;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
}

.wc-sticker-item img {
    width: 80%;
    height: 80%;
    object-fit: contain;
}

.wc-sticker-delete-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    width: 20px;
    height: 20px;
    background: var(--wc-danger-red);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    z-index: 2;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.wc-sticker-item.shake {
    animation: wcShake 0.2s infinite;
}

@keyframes wcShake {
    0% { transform: rotate(0deg); }
    25% { transform: rotate(1deg); }
    50% { transform: rotate(0deg); }
    75% { transform: rotate(-1deg); }
    100% { transform: rotate(0deg); }
}

/* More Panel Specifics */
.wc-more-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    padding: 24px;
}

.wc-more-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.wc-more-icon-box {
    width: 60px;
    height: 60px;
    background: #fff;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
    border: 1px solid #E5E5EA;
}

.wc-more-label {
    font-size: 12px;
    color: var(--wc-text-secondary);
    text-align: center;
}

/* --- Modals (iOS Style) --- */
.wc-modal {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.4);
    z-index: 2000;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 1;
    transition: opacity 0.2s;
}

.wc-modal.hidden {
    display: none;
    opacity: 0;
    pointer-events: none;
}

.wc-modal-content {
    background: #fff;
    width: 90%;
    max-width: 400px;
    border-radius: 14px;
    overflow: hidden;
    animation: wcPopIn 0.2s ease-out;
}

/* Full Width Bottom Sheet Modals */
#wc-modal-add-char .wc-modal-content,
#wc-modal-edit-mask .wc-modal-content,
#wc-modal-masks .wc-modal-content {
    width: 100%;
    max-width: 100%;
    border-radius: 16px 16px 0 0;
    position: absolute;
    bottom: 0;
    margin: 0;
    animation: wcSlideUpModal 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
}

/* Action Sheet Style Modal Content */
.wc-modal[style*="align-items: flex-end"] .wc-modal-content {
    width: 100%;
    max-width: 100%;
    border-radius: 12px 12px 0 0;
    margin: 0;
    animation: wcSlideUpModal 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
}

@keyframes wcPopIn {
    from { transform: scale(0.95); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

@keyframes wcSlideUpModal {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

.wc-modal-header {
    padding: 16px;
    border-bottom: 0.5px solid #E5E5EA;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.wc-modal-header h3 {
    margin: 0;
    font-size: 17px;
    font-weight: 600;
}

.wc-close-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: #8E8E93;
    cursor: pointer;
    padding: 0;
    line-height: 1;
}

.wc-modal-body {
    padding: 20px;
    max-height: 80vh;
    overflow-y: auto;
}

.wc-setting-group {
    margin-bottom: 16px;
}

.wc-setting-group label {
    display: block;
    font-size: 14px;
    color: #8E8E93;
    margin-bottom: 8px;
}

.wc-setting-group input, .wc-setting-group textarea, .wc-setting-group select {
    width: 100%;
    padding: 12px;
    background: #F2F2F7;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    appearance: none;
}

.wc-ios-btn-block {
    width: 100%;
    padding: 14px;
    background: var(--wc-accent-blue);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 17px;
    font-weight: 600;
    cursor: pointer;
}

.wc-ios-btn-block.wc-btn-secondary {
    background: #E5E5EA;
    color: #000;
}

.wc-ios-list-group {
    background: rgba(242, 242, 247, 0.8);
    backdrop-filter: blur(10px);
}

.wc-list-item.center-content {
    justify-content: center;
    cursor: pointer;
}

.wc-list-item.center-content:active {
    background-color: #E5E5EA !important;
}

/* --- Wallet Page Styles --- */
.wc-wallet-header {
    background: var(--wc-card-color);
    padding: 40px 20px;
    text-align: center;
    margin-bottom: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.wc-wallet-icon-lg {
    width: 60px;
    height: 60px;
    color: var(--wc-transfer-orange);
    margin-bottom: 16px;
}

.wc-wallet-balance-label {
    font-size: 14px;
    color: var(--wc-text-secondary);
    margin-bottom: 8px;
}

.wc-wallet-balance-num {
    font-size: 36px;
    font-weight: 700;
    color: #000;
    margin-bottom: 24px;
}

.wc-wallet-btn-row {
    display: flex;
    gap: 16px;
    width: 100%;
    max-width: 300px;
}

.wc-transaction-item {
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 0.5px solid var(--wc-separator);
    background: var(--wc-card-color);
}

.wc-trans-info {
    display: flex;
    flex-direction: column;
}

.wc-trans-title {
    font-size: 16px;
    margin-bottom: 4px;
}

.wc-trans-time {
    font-size: 12px;
    color: var(--wc-text-secondary);
}

.wc-trans-amount {
    font-size: 17px;
    font-weight: 600;
}

.wc-amount-in { color: var(--wc-accent-green); }
.wc-amount-out { color: #000; }

/* --- Memory Page Styles (Full Screen) --- */
#wc-view-memory {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #F2F2F7;
    z-index: 1400;
    display: none;
    flex-direction: column;
}

#wc-view-memory.active {
    display: flex;
    animation: wcSlideInRight 0.3s ease;
}

@keyframes wcSlideInRight {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

.wc-memory-card {
    background: #fff;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    position: relative;
}
.wc-memory-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 12px;
    color: #8E8E93;
    padding-right: 20px;
}
.wc-memory-content {
    font-size: 15px;
    line-height: 1.5;
    color: #333;
}
.wc-memory-delete-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    color: #FF3B30;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
}

/* --- Contact Card (Character Detail) Styles --- */
#wc-modal-char-detail .wc-modal-content {
    width: 320px;
    height: 450px;
    border-radius: 20px;
    position: relative;
    bottom: auto;
    margin: auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0;
    background: #fff;
}

.wc-contact-card-header {
    width: 100%;
    height: 240px;
    position: relative;
}

.wc-contact-card-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 20px 20px 0 0;
}

.wc-contact-card-info {
    flex: 1;
    width: 100%;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.wc-contact-card-name {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 4px;
}

.wc-contact-card-note {
    font-size: 14px;
    color: #8E8E93;
    margin-bottom: 20px;
}

.wc-contact-card-edit-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    background: rgba(0,0,0,0.3);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    cursor: pointer;
    backdrop-filter: blur(4px);
}

.wc-contact-card-close-btn {
    position: absolute;
    top: 16px;
    left: 16px;
    background: rgba(0,0,0,0.3);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    cursor: pointer;
    backdrop-filter: blur(4px);
    z-index: 10;
}

/* --- Phone Simulator Styles --- */
#wc-view-phone-sim {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #000;
    z-index: 1500;
    display: none;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

#wc-view-phone-sim.active {
    display: flex;
    animation: wcFadeIn 0.3s ease;
}

.wc-phone-bezel {
    width: 100%;
    max-width: 360px;
    height: 100%;
    max-height: 750px;
    background: #000;
    border-radius: 40px;
    border: 12px solid #1c1c1e;
    box-shadow: 0 0 0 2px #333, 0 20px 50px rgba(0,0,0,0.5);
    overflow: hidden;
    position: relative;
    display: flex;
    flex-direction: column;
}

/* Notch (Liu Hai) */
.wc-phone-notch {
    width: 120px;
    height: 30px;
    background: #000;
    border-bottom-left-radius: 15px;
    border-bottom-right-radius: 15px;
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    cursor: pointer;
}

/* Home Indicator */
.wc-phone-home-indicator {
    width: 120px;
    height: 5px;
    background: #fff;
    border-radius: 3px;
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

.wc-phone-screen {
    flex: 1;
    background-size: cover;
    background-position: center;
    display: flex;
    flex-direction: column;
    padding-top: 30px; /* Status bar area */
    position: relative;
}

.wc-phone-sim-navbar {
    height: 44px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 16px;
    color: white;
    z-index: 10;
}

.wc-ios-desktop {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(6, 1fr);
    gap: 15px;
    padding: 20px;
    align-content: start;
}

.wc-ios-widget-clock {
    grid-column: span 4;
    grid-row: span 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.wc-ios-clock-time {
    font-size: 60px;
    font-weight: 200;
    line-height: 1;
}

.wc-ios-clock-date {
    font-size: 16px;
    margin-top: 5px;
    font-weight: 500;
}

.wc-ios-app-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    cursor: pointer;
}

.wc-ios-app-icon {
    width: 100%;
    aspect-ratio: 1;
    background: rgba(255,255,255,0.9);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.wc-ios-app-icon img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.wc-ios-app-name {
    font-size: 11px;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
}

/* --- Phone Message App Styles --- */
.wc-phone-app-view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #F2F2F7;
    z-index: 20;
    display: flex;
    flex-direction: column;
    animation: wcPopIn 0.2s ease-out;
}

.wc-phone-app-content {
    flex: 1;
    overflow-y: auto;
    padding-top: 44px; /* Status bar */
    padding-bottom: 50px; /* Tab bar */
}

.wc-phone-app-tabbar {
    height: 50px;
    background: #F7F7F7;
    border-top: 0.5px solid #C6C6C8;
    display: flex;
    justify-content: space-around;
    align-items: center;
    position: absolute;
    bottom: 0;
    width: 100%;
}

.wc-phone-tab-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 10px;
    color: #8E8E93;
    cursor: pointer;
}

.wc-phone-tab-item.active {
    color: #007AFF;
}

/* --- Swipe Actions for Chat List (Pin Only) --- */
.wc-chat-swipe-container {
    position: relative;
    overflow: hidden;
    background: var(--wc-card-color);
    margin: 8px 16px;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.wc-chat-swipe-actions {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    display: flex;
    z-index: 1;
}

.wc-chat-action-btn {
    width: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 14px;
}

.wc-btn-pin { background-color: var(--wc-pin-gray); }

.wc-chat-swipe-content {
    position: relative;
    z-index: 2;
    background: var(--wc-card-color);
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    padding: 12px 16px;
    transition: transform 0.2s ease-out;
}

.wc-pinned-chat {
    background-color: #FFFFFF !important; 
}

.wc-list-separator {
    text-align: center;
    color: #C7C7CC;
    font-size: 12px;
    padding: 5px 0;
    background: var(--wc-bg-color);
}

@keyframes wcFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* TabBar */
.wc-tabbar-container {
    position: absolute;
    bottom: 30px;
    left: 0;
    width: 100%;
    display: flex;
    justify-content: center;
    z-index: 1000;
    pointer-events: none;
}

.wc-tabbar {
    width: 320px;
    height: 64px;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    border-radius: 32px;
    display: flex;
    justify-content: space-around;
    align-items: center;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    pointer-events: auto;
}

.wc-tab-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--wc-text-secondary);
    font-size: 10px;
    width: 60px;
    cursor: pointer;
    transition: color 0.2s;
}

.wc-tab-item.active {
    color: var(--wc-text-primary);
}

.wc-tab-item svg {
    margin-bottom: 4px;
}

/* Common UI Elements */
.wc-card {
    background: var(--wc-card-color);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
}

.wc-list-group {
    background: var(--wc-card-color);
    border-radius: 16px;
    overflow: hidden;
}

.wc-list-item {
    padding: 12px 16px;
    display: flex;
    align-items: center;
    border-bottom: 0.5px solid var(--wc-separator);
    background: var(--wc-card-color);
    position: relative;
    transition: transform 0.2s ease-out;
    cursor: pointer;
}

.wc-list-item:last-child {
    border-bottom: none;
}

.wc-avatar {
    width: 48px;
    height: 48px;
    border-radius: 6px;
    background-color: #E5E5EA;
    object-fit: cover;
    margin-right: 12px;
    flex-shrink: 0;
}

.wc-item-content {
    flex: 1;
    overflow: hidden;
}

.wc-item-title {
    font-weight: 600;
    font-size: 16px;
    margin-bottom: 4px;
}

.wc-item-subtitle {
    color: var(--wc-text-secondary);
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Contacts Swipe Delete */
.wc-swipe-container {
    position: relative;
    overflow: hidden;
    background: var(--wc-danger-red);
    border-radius: 0;
}

.wc-swipe-container:first-child { border-top-left-radius: 16px; border-top-right-radius: 16px; }
.wc-swipe-container:last-child { border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; }

.wc-swipe-actions {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 80px;
    background-color: var(--wc-danger-red);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    z-index: 0;
}

.wc-swipe-content {
    position: relative;
    z-index: 1;
    background: var(--wc-card-color);
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    padding: 12px 16px;
    transition: transform 0.2s ease-out;
    border-bottom: 0.5px solid var(--wc-separator);
}

/* Moments Styles */
.wc-moments-header {
    position: relative;
    margin-bottom: 40px;
}

.wc-moments-cover {
    width: 100%;
    height: 240px;
    background-color: #333;
    object-fit: cover;
    cursor: pointer;
}

.wc-moments-user-avatar {
    position: absolute;
    bottom: -30px;
    right: 20px;
    width: 80px;
    height: 80px;
    border-radius: 12px;
    border: 3px solid #fff;
    background-color: #ccc;
    object-fit: cover;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.wc-moment-card {
    padding: 16px;
    border-bottom: 0.5px solid var(--wc-separator);
    background: transparent;
    display: flex;
    align-items: flex-start;
}

.wc-moment-content {
    margin-left: 10px;
    flex: 1;
}

.wc-moment-name {
    color: #576B95;
    font-weight: 600;
    margin-bottom: 6px;
}

.wc-moment-text {
    font-size: 15px;
    line-height: 1.4;
    margin-bottom: 8px;
}

.wc-moment-image {
    width: 100%;
    max-width: 200px;
    height: auto;
    border-radius: 4px;
    margin-bottom: 8px;
    display: block;
}

.wc-moment-image-placeholder {
    width: 100%;
    max-width: 240px;
    background: #F2F2F7;
    border: 1px solid #E5E5EA;
    border-radius: 4px;
    padding: 12px;
    margin-bottom: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--wc-text-secondary);
    font-size: 13px;
    text-align: center;
}

.wc-moment-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
}

.wc-moment-likes-comments {
    background: #F2F2F7;
    border-radius: 4px;
    margin-top: 8px;
    padding: 8px;
    font-size: 13px;
}

.wc-moment-like-row {
    color: #576B95;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
}

.wc-moment-comment-row {
    margin-bottom: 2px;
}

.wc-moment-comment-name {
    color: #576B95;
    font-weight: 600;
}

.wc-comment-input-box {
    display: flex;
    margin-top: 8px;
    gap: 8px;
}

.wc-comment-input {
    flex: 1;
    border: 1px solid #E5E5EA;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 14px;
}

/* User Center */
.wc-user-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 30px 0;
}

.wc-user-avatar-lg {
    width: 100px;
    height: 100px;
    border-radius: 12px;
    margin-bottom: 16px;
    object-fit: cover;
    border: 1px solid #E5E5EA;
}

/* Modals (General) */
.wc-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    z-index: 2000;
    display: none;
    justify-content: center;
    align-items: flex-end;
}

.wc-modal-overlay.active {
    display: flex;
}

.wc-form-group {
    margin-bottom: 16px;
}

.wc-form-label {
    display: block;
    font-size: 14px;
    color: var(--wc-text-secondary);
    margin-bottom: 8px;
}

.wc-form-input, .wc-form-textarea {
    width: 100%;
    padding: 12px;
    background: #F2F2F7;
    border: none;
    border-radius: 10px;
    font-size: 16px;
}

.wc-form-textarea {
    height: 100px;
    resize: none;
}

.wc-btn-primary {
    width: 100%;
    padding: 14px;
    background: var(--wc-text-primary);
    color: #fff;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    margin-top: 10px;
}

.wc-btn-secondary {
    background: #E5E5EA;
    color: var(--wc-text-primary);
    margin-top: 10px;
}

.wc-btn-danger {
    background: var(--wc-danger-red);
    color: white;
    margin-top: 10px;
}

.wc-segmented-control {
    display: flex;
    background: #F2F2F7;
    border-radius: 8px;
    padding: 2px;
    margin-bottom: 16px;
}

.wc-segment-btn {
    flex: 1;
    padding: 8px;
    text-align: center;
    font-size: 14px;
    border-radius: 6px;
    cursor: pointer;
    color: var(--wc-text-secondary);
    transition: all 0.2s;
}

.wc-segment-btn.active {
    background: #fff;
    color: #000;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    font-weight: 500;
}

.wc-upload-placeholder {
    width: 80px;
    height: 80px;
    background: #F2F2F7;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
    color: var(--wc-text-secondary);
    cursor: pointer;
    overflow: hidden;
}

.wc-upload-rect-placeholder {
    width: 100px;
    height: 100px;
    background: #F2F2F7;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--wc-text-secondary);
    cursor: pointer;
    margin-bottom: 10px;
    overflow: hidden;
}

/* Chat Settings Modal Specifics */
#wc-modal-chat-settings .wc-modal-content {
    width: 100%;
    height: 100%;
    max-width: 100%;
    border-radius: 0;
    display: flex;
    flex-direction: column;
}

.wc-settings-section {
    background: #fff;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.wc-settings-section-title {
    font-size: 13px;
    color: #8E8E93;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.wc-avatar-row {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
}

.wc-avatar-edit {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    background: #eee;
    object-fit: cover;
    cursor: pointer;
}

/* 新增：多选列表样式 */
.wc-checkbox-list {
    max-height: 150px;
    overflow-y: auto;
    background: #F2F2F7;
    border-radius: 10px;
    padding: 8px 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.wc-checkbox-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 15px;
    color: #000;
    cursor: pointer;
}

.wc-checkbox-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin: 0;
    accent-color: var(--wc-accent-blue);
}
</style>
</head>
<body>

    <!-- 隐藏的文件输入框 -->
    <input type="file" id="widgetBgInput" class="hidden-file-input" accept="image/*" onchange="handleWidgetBgUpload(this)">
    <input type="file" id="widgetAvatarInput" class="hidden-file-input" accept="image/*" onchange="handleWidgetAvatarUpload(this)">
    <input type="file" id="appleAvatarInput" class="hidden-file-input" accept="image/*" onchange="handleAppleAvatarUpload(this)">
    <input type="file" id="backupImportInput" class="hidden-file-input" accept=".json" onchange="importData(this)">

    <!-- 主屏幕 -->
    <div class="screen" id="mainScreen">
        <div class="status-bar-placeholder"></div>

        <!-- 桌面区域 -->
        <div class="home-grid" id="homeGrid">
            <!-- 小组件 -->
            <div class="widget-item" id="mainWidget" onclick="triggerWidgetBgUpload()">
                <div class="widget-overlay"></div>
                <div class="widget-left">
                    <div class="widget-avatar" id="widgetAvatar" onclick="event.stopPropagation(); triggerAvatarUpload()"></div>
                    <div class="widget-text" id="widgetText" onclick="event.stopPropagation(); editWidgetText()">点击编辑文本</div>
                </div>
                <div class="widget-right">
                    <div class="widget-time" id="widgetTime">12:00</div>
                    <div class="widget-date" id="widgetDate">2026/02/14</div>
                </div>
            </div>
            <!-- JS 生成剩余格子 -->
        </div>

        <!-- Dock 区域 -->
        <div class="dock-container">
            <div class="dock">
                <!-- App 4: Theme Studio -->
                <div class="app-item" id="app-4" onclick="openSettings()">
                    <div class="app-icon" id="icon-4">
                        <svg class="default-icon-svg" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
                    </div>
                    <div class="app-name" id="name-4" style="display:none">Theme</div>
                </div>
                
                <!-- App 5: iOS Settings -->
                <div class="app-item" id="app-5" onclick="openIOSSettings()">
                    <div class="app-icon" id="icon-5">
                        <svg class="default-icon-svg" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                    </div>
                    <div class="app-name" id="name-5" style="display:none">Settings</div>
                </div>

                <!-- App 6: Worldbook -->
                <div class="app-item" id="app-6" onclick="openWorldbook()">
                    <div class="app-icon" id="icon-6">
                        <svg class="default-icon-svg" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                    </div>
                    <div class="app-name" id="name-6" style="display:none">世界书</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Theme Studio 设置面板 -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-header">
            <div class="header-left">
                <button class="nav-btn" onclick="closeSettings()">
                    <svg class="back-svg" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </button>
            </div>
            <div class="header-title" id="headerTitle">壁纸设置</div>
            <div class="header-right">
                <button class="nav-btn" onclick="closeSettings()">完成</button>
            </div>
        </div>
        
        <div class="settings-content">
            <!-- Tab 1: 壁纸 -->
            <div id="tab-wallpaper" class="tab-content active">
                <div class="settings-title">更换壁纸</div>
                <div class="settings-group">
                    <div class="settings-row">
                        <div class="row-label">图片 URL</div>
                        <input type="text" id="bgUrlInput" placeholder="https://example.com/image.jpg">
                        <button class="action-btn" onclick="setWallpaperFromUrl()">应用并保存</button>
                    </div>
                    <div class="settings-row">
                        <div class="row-label">本地相册</div>
                        <input type="file" id="bgFileInput" accept="image/*" style="display:none">
                        <button class="action-btn secondary" onclick="document.getElementById('bgFileInput').click()">选择图片...</button>
                    </div>
                    <div class="settings-row">
                        <button class="action-btn destructive" onclick="resetWallpaper()">恢复默认壁纸</button>
                    </div>
                </div>
                <div class="settings-title">壁纸库 (点击应用)</div>
                <div class="settings-group">
                    <div class="settings-row">
                        <div class="wallpaper-grid" id="wallpaperGrid">
                            <div style="color:#999; font-size:13px; grid-column:span 3; text-align:center; padding:20px;">暂无保存的壁纸</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: 图标 -->
            <div id="tab-icons" class="tab-content">
                <div class="settings-title">图标方案管理</div>
                <div class="settings-group">
                    <div class="settings-row">
                        <button class="action-btn" type="button" onclick="openNameModal('icon')">保存当前所有图标为预设</button>
                    </div>
                    <div class="settings-row">
                        <div class="row-label">已保存方案</div>
                        <div class="preset-list" id="iconPresetList">
                            <div style="color:#999; font-size:13px; padding:5px;">暂无预设</div>
                        </div>
                    </div>
                    <div class="settings-row">
                        <button class="action-btn destructive" onclick="resetIcons()">恢复默认图标</button>
                    </div>
                </div>
                <div class="settings-title">编辑单个 APP (点击图标上传)</div>
                <div class="settings-group" id="appEditorList"></div>
            </div>

            <!-- Tab 3: 字体 -->
            <div id="tab-fonts" class="tab-content">
                <div class="settings-title">全局字体设置</div>
                <div class="settings-group">
                    <div class="settings-row">
                        <div class="row-label" style="display:flex; justify-content:space-between;">
                            <span>字体大小</span>
                            <span id="fontSizeDisplay" style="color:#888; font-weight:normal;">11px</span>
                        </div>
                        <input type="range" id="fontSizeSlider" min="9" max="16" step="0.5" value="11" oninput="changeFontSize(this.value)">
                    </div>
                    <div class="settings-row">
                        <div class="row-label">字体 URL (WOFF/TTF)</div>
                        <input type="text" id="fontUrlInput" placeholder="https://.../font.woff2">
                        <button class="action-btn" onclick="applyFont()">应用字体</button>
                        <button class="action-btn secondary" onclick="openNameModal('font')">保存为预设</button>
                    </div>
                    <div class="settings-row">
                        <button class="action-btn destructive" onclick="resetFonts()">恢复默认字体</button>
                    </div>
                    <div class="settings-row" id="fontPresetsContainer" style="display:none;">
                        <div class="row-label">字体预设</div>
                        <div class="preset-list" id="fontPresetList"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-tab-bar">
            <div class="tab-item active" onclick="switchTab('wallpaper', this)">壁纸</div>
            <div class="tab-item" onclick="switchTab('icons', this)">图标</div>
            <div class="tab-item" onclick="switchTab('fonts', this)">字体</div>
        </div>
    </div>

    <!-- iOS 仿真设置页面 -->
    <div class="settings-modal" id="iosSettingsModal">
        <div class="settings-header">
            <div class="header-left">
                <button class="nav-btn" onclick="closeIOSSettings()">
                    <svg class="back-svg" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    <span>设置</span>
                </button>
            </div>
            <div class="header-title">设置</div>
            <div class="header-right"></div>
        </div>

        <div class="settings-content ios-settings-content">
            <div class="ios-search-bar">
                <input type="text" class="ios-search-input" placeholder="搜索" readonly>
            </div>

            <div class="ios-profile-card" onclick="openAppleIdSettings()">
                <div class="ios-profile-avatar" id="appleIdAvatar">A</div>
                <div class="ios-profile-info">
                    <h3 id="appleIdName">Apple ID</h3>
                    <p id="appleIdSubtext">Apple ID、iCloud、媒体与购买项目</p>
                </div>
                <svg class="chevron-right" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            </div>

            <div class="ios-list-group">
                <div class="ios-list-item" onclick="openApiSettings()">
                    <div class="ios-icon-box" style="background:#007aff"><svg viewBox="0 0 24 24"><path d="M12.01 21.49L23.64 7c-.45-.34-4.93-4-11.64-4C5.28 3 .81 6.66.36 7l11.63 14.49.01.01.01-.01z"/></svg></div>
                    <div class="ios-item-content">
                        <span class="ios-item-label">Wi-Fi</span>
                        <div class="ios-item-right">API 配置<svg class="chevron-right" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></div>
                    </div>
                </div>
            </div>
             <div class="ios-list-group">
                <div class="ios-list-item">
                    <div class="ios-icon-box" style="background:#ff3b30"><svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg></div>
                    <div class="ios-item-content">
                        <span class="ios-item-label">通知</span>
                        <div class="ios-item-right"><svg class="chevron-right" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></div>
                    </div>
                </div>
                <div class="ios-list-item">
                    <div class="ios-icon-box" style="background:#ff2d55"><svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg></div>
                    <div class="ios-item-content">
                        <span class="ios-item-label">声音与触感</span>
                        <div class="ios-item-right"><svg class="chevron-right" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></div>
                    </div>
                </div>
            </div>

            <div class="ios-list-group">
                <div class="ios-list-item">
                    <div class="ios-icon-box" style="background:#8e8e93"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg></div>
                    <div class="ios-item-content">
                        <span class="ios-item-label">通用</span>
                        <div class="ios-item-right"><svg class="chevron-right" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></div>
                    </div>
                </div>
                <div class="ios-list-item">
                    <div class="ios-icon-box" style="background:#8e8e93"><svg viewBox="0 0 24 24"><path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/></svg></div>
                    <div class="ios-item-content">
                        <span class="ios-item-label">控制中心</span>
                        <div class="ios-item-right"><svg class="chevron-right" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Apple ID 详细设置页面 -->
    <div class="settings-modal sub-page" id="appleIdSettingsModal">
        <div class="settings-header">
            <div class="header-left">
                <button class="nav-btn" onclick="closeAppleIdSettings()">
                    <svg class="back-svg" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    <span>设置</span>
                </button>
            </div>
            <div class="header-title">Apple ID</div>
            <div class="header-right"></div>
        </div>

        <div class="settings-content ios-settings-content">
            <div class="profile-header">
                <div class="profile-header-avatar" id="appleIdDetailAvatar" onclick="triggerAppleAvatarUpload()">
                    A
                    <div class="profile-edit-badge">编辑</div>
                </div>
                <div class="profile-header-name" id="appleIdDetailName" onclick="editAppleIdText()">Apple ID</div>
                <div class="profile-header-email">name@example.com</div>
            </div>

            <div class="settings-title">存储空间</div>
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="openStorageAnalysis()">
                    <div class="ios-item-content">
                        <span class="ios-item-label">iCloud 存储空间</span>
                        <div class="ios-item-right"><svg class="chevron-right" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></div>
                    </div>
                </div>
            </div>

            <div class="settings-title">数据管理</div>
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="exportData()">
                    <div class="ios-item-content">
                        <span class="ios-item-label" style="color:var(--blue)">备份数据 (导出)</span>
                    </div>
                </div>
                <div class="ios-list-item" onclick="document.getElementById('backupImportInput').click()">
                    <div class="ios-item-content">
                        <span class="ios-item-label" style="color:var(--blue)">恢复数据 (导入)</span>
                    </div>
                </div>
            </div>

            <div class="ios-list-group">
                <div class="ios-list-item" onclick="clearAllData()">
                    <div class="ios-item-content" style="justify-content: center;">
                        <span class="ios-item-label" style="color:var(--red); font-weight:600;">清空所有数据</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API 设置页面 -->
    <div class="settings-modal sub-page" id="apiSettingsModal">
        <div class="settings-header">
            <div class="header-left">
                <button class="nav-btn" onclick="closeApiSettings()">
                    <svg class="back-svg" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    <span>设置</span>
                </button>
            </div>
            <div class="header-title">API 配置</div>
            <div class="header-right">
                <button class="nav-btn" onclick="saveApiConfig()">保存</button>
            </div>
        </div>

        <div class="settings-content ios-settings-content">
            <div class="settings-title" style="margin-top:20px;">配置预设</div>
            <div class="ios-list-group" style="padding:10px;">
                <div class="preset-list" id="apiPresetList">
                    <div style="color:#999; font-size:13px; padding:5px;">暂无预设</div>
                </div>
                <button class="action-btn secondary" onclick="openNameModal('api')" style="margin-top:10px;">保存当前配置为预设</button>
            </div>

            <div class="settings-title">连接设置</div>
            <div class="ios-list-group" style="padding: 0 16px;">
                <div class="settings-row">
                    <div class="row-label">API 地址 (Base URL)</div>
                    <input type="text" id="apiBaseUrl" placeholder="https://api.openai.com/v1">
                    <div style="font-size:11px; color:#888; margin-top:4px;">请确保反代服务器支持 CORS (跨域访问)</div>
                </div>
                <div class="settings-row">
                    <div class="row-label">API 密钥 (Key)</div>
                    <input type="password" id="apiKey" placeholder="sk-...">
                </div>
            </div>

            <div class="settings-title">模型选择</div>
            <div class="ios-list-group" style="padding: 0 16px;">
                <div class="settings-row">
                    <button class="action-btn" onclick="fetchModels()" id="fetchBtn">拉取模型列表</button>
                </div>
                <div class="settings-row">
                    <div class="row-label">选择模型</div>
                    <select id="modelSelect" class="ios-select">
                        <option value="" disabled selected>请先拉取模型</option>
                    </select>
                </div>
            </div>

            <div class="settings-title">参数设置</div>
            <div class="ios-list-group" style="padding: 0 16px;">
                <div class="settings-row">
                    <div class="row-label" style="display:flex; justify-content:space-between;">
                        <span>温度 (Temperature)</span>
                        <span id="tempDisplay" style="color:#888;">0.7</span>
                    </div>
                    <input type="range" id="tempSlider" min="0" max="2" step="0.1" value="0.7" oninput="document.getElementById('tempDisplay').innerText = this.value">
                </div>
            </div>
        </div>
    </div>

    <!-- 世界书 (Worldbook) 主页面 -->
    <div class="settings-modal" id="worldbookModal">
        <div class="settings-header">
            <div class="header-left">
                <button class="nav-btn" onclick="closeWorldbook()">
                    <svg class="back-svg" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    <span>返回</span>
                </button>
            </div>
            <div class="header-title" id="wbHeaderTitle">所有条目</div>
            <div class="header-right">
                <button class="nav-btn" onclick="openWorldbookEditor()">
                    <svg class="svg-icon" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                </button>
            </div>
        </div>

        <div class="settings-content ios-settings-content" style="padding-bottom: 60px; overflow: hidden;">
            <div class="ios-search-bar">
                <input type="text" class="ios-search-input" placeholder="搜索条目" oninput="filterWorldbook(this.value)">
            </div>
            
            <div class="wb-view-container" id="wbViewContainer">
                <!-- 视图 1: 所有条目 -->
                <div class="wb-view-page" id="wbViewAll">
                    <div class="wb-list-container" id="worldbookList">
                        <div style="padding: 20px; text-align: center; color: #999;">暂无条目，点击右上角添加</div>
                    </div>
                </div>
                
                <!-- 视图 2: 分组视图 -->
                <div class="wb-view-page" id="wbViewGroup">
                    <div class="wb-list-container" id="worldbookGroupList">
                        <!-- 分组列表由 JS 生成 -->
                    </div>
                    <div class="wb-add-group-btn" onclick="addNewGroup()">+ 添加分组</div>
                </div>
            </div>
        </div>

        <div class="settings-tab-bar">
            <div class="tab-item active" id="tab-wb-all" onclick="switchWorldbookView('all')">
                <svg class="tab-icon" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                <span class="tab-label">所有条目</span>
            </div>
            <div class="tab-item" id="tab-wb-group" onclick="switchWorldbookView('group')">
                <svg class="tab-icon" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
                <span class="tab-label">分组视图</span>
            </div>
        </div>
    </div>

    <!-- 世界书编辑器 -->
    <div class="settings-modal sub-page" id="worldbookEditorModal">
        <div class="settings-header">
            <div class="header-left">
                <button class="nav-btn" onclick="closeWorldbookEditor()">取消</button>
            </div>
            <div class="header-title" id="wbEditorTitle">新建条目</div>
            <div class="header-right">
                <button class="nav-btn" onclick="saveWorldbookEntry()">保存</button>
            </div>
        </div>

        <div class="settings-content ios-settings-content">
            <div class="settings-title">基本信息</div>
            <div class="ios-list-group" style="padding: 0 16px;">
                <div class="settings-row">
                    <div class="row-label">Title (名称)</div>
                    <input type="text" id="wbTitleInput" placeholder="例如：艾莉丝">
                </div>
                <div class="settings-row">
                    <div class="row-label">Type (分组)</div>
                    <select id="wbTypeInput" class="ios-select"></select>
                </div>
            </div>

            <div class="settings-title">触发条件</div>
            <div class="ios-list-group" style="padding: 0 16px;">
                <div class="settings-row">
                    <div class="row-label">Key (触发词，逗号分隔)</div>
                    <input type="text" id="wbKeyInput" placeholder="例如：Alice, 艾莉丝, 女主">
                </div>
            </div>

            <div class="settings-title">详细设定</div>
            <div class="ios-list-group" style="padding: 0 16px;">
                <div class="settings-row">
                    <textarea id="wbDescInput" class="ios-textarea" placeholder="在此输入详细描述..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- 通用弹窗 -->
    <div class="custom-modal-overlay" id="modalOverlay">
        <div class="custom-modal">
            <div class="modal-title" id="modalTitle">标题</div>
            <div class="modal-desc" id="modalDesc">描述文本</div>
            <div class="modal-input-container" id="modalInputContainer">
                <input type="text" id="modalInput" placeholder="请输入...">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeModal()">取消</button>
                <button class="modal-btn" id="modalConfirmBtn" onclick="">确定</button>
            </div>
        </div>
    </div>

    <!-- 存储分析弹窗 -->
    <div class="custom-modal-overlay" id="storageModalOverlay">
        <div class="custom-modal" style="width: 320px; padding-bottom: 0;">
            <div class="modal-title">存储空间</div>
            <div class="storage-chart-container">
                <div class="chart-wrapper">
                    <canvas id="storageChart" class="chart-canvas" width="360" height="360"></canvas>
                    <div class="chart-center-text">
                        <div class="chart-total" id="storageTotal">0 KB</div>
                        <div class="chart-label">已使用</div>
                    </div>
                </div>
                <div class="chart-legend" id="storageLegend"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeStorageModal()" style="font-weight: 600;">关闭</button>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- WeChat App 容器 (App 1) -->
    <!-- ========================================== -->
    <div class="settings-modal" id="wechatModal" style="padding: 0; z-index: 3000; background: #F2F2F7;">
        <div id="wechat-root">
            <!-- Navbar -->
            <nav class="wc-navbar">
                <div class="wc-nav-left">
                    <button class="wc-nav-btn" id="wc-btn-exit" onclick="closeWechat()">
                        <svg class="wc-icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        退出
                    </button>
                    <button class="wc-nav-btn" id="wc-btn-back" onclick="wcHandleBack()" style="display: none;">
                        <svg class="wc-icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        返回
                    </button>
                </div>
                <div class="wc-nav-title" id="wc-nav-title">Chat</div>
                <div class="wc-nav-right" id="wc-nav-right-container">
                    <!-- Dynamic Buttons -->
                </div>
            </nav>

            <!-- Main Content -->
            <main class="wc-main-content">
                
                <!-- Chat List Page -->
                <div id="wc-view-chat" class="wc-page active">
                    <div class="wc-list-group" id="wc-chat-list" style="background: transparent;"></div>
                </div>

                <!-- Chat Detail Page (WeChat Style) -->
                <div id="wc-view-chat-detail">
                    <div id="wc-chat-background-layer" class="wc-chat-background"></div>
                    <div class="wc-chat-scroll-area" id="wc-chat-messages">
                        <!-- Messages injected here -->
                    </div>
                    
                    <!-- Context Menu (Long Press) -->
                    <div id="wc-context-menu">
                        <div class="wc-ctx-item" onclick="wcHandleReply()">引用</div>
                        <div class="wc-ctx-item" onclick="wcHandleEdit()">编辑</div>
                        <div class="wc-ctx-item" onclick="wcHandleDelete()">删除</div>
                        <div class="wc-ctx-item" onclick="wcHandleMultiSelect()">多选</div>
                    </div>

                    <!-- Sticker Panel Container -->
                    <div id="wc-sticker-panel" class="wc-panel-container">
                        <div class="wc-sticker-grid-area" id="wc-sticker-grid">
                            <!-- Stickers injected via JS -->
                        </div>
                        <div class="wc-sticker-tab-bar">
                            <div class="wc-sticker-add-btn" onclick="wcOpenStickerOptions(event)">
                                <svg class="wc-icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            </div>
                            <div class="wc-sticker-tabs-scroll" id="wc-sticker-tabs">
                                <!-- Tabs injected via JS -->
                            </div>
                        </div>
                    </div>

                    <!-- More Actions Panel -->
                    <div id="wc-more-panel" class="wc-panel-container">
                        <div class="wc-more-grid">
                            <div class="wc-more-item" onclick="wcActionRoll()">
                                <div class="wc-more-icon-box">
                                    <svg class="wc-icon" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                                </div>
                                <span class="wc-more-label">重Roll</span>
                            </div>
                            <div class="wc-more-item" onclick="wcActionVoice()">
                                <div class="wc-more-icon-box">
                                    <svg class="wc-icon" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                                </div>
                                <span class="wc-more-label">语音</span>
                            </div>
                            <div class="wc-more-item" onclick="wcOpenModal('wc-modal-image-type')">
                                <div class="wc-more-icon-box">
                                    <svg class="wc-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                                </div>
                                <span class="wc-more-label">图片</span>
                            </div>
                            <div class="wc-more-item" onclick="wcOpenTransferModal()">
                                <div class="wc-more-icon-box">
                                    <svg class="wc-icon" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                                </div>
                                <span class="wc-more-label">转账</span>
                            </div>
                            <div class="wc-more-item" onclick="wcActionMemory()">
                                <div class="wc-more-icon-box">
                                    <svg class="wc-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                </div>
                                <span class="wc-more-label">回忆总结</span>
                            </div>                           
                        </div>
                    </div>

                    <!-- Chat Footer -->
                    <div class="wc-chat-footer" id="wc-chat-footer">
                        <!-- Quote Preview -->
                        <div id="wc-quote-preview-area">
                            <span id="wc-quote-text-content">引用内容...</span>
                            <span onclick="wcCancelQuote()" style="color: #007AFF; cursor: pointer;">&times;</span>
                        </div>

                        <!-- More Icon -->
                        <svg class="wc-icon wc-footer-icon" onclick="wcToggleMorePanel()" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                        
                        <textarea id="wc-chat-input" class="wc-chat-input" placeholder="" onkeydown="wcHandleEnter(event)" onfocus="wcCloseAllPanels()" rows="1"></textarea>
                        
                        <!-- Sticker Icon -->
                        <svg class="wc-icon wc-footer-icon" onclick="wcToggleStickerPanel()" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                        
                        <!-- AI Reply Button (Paper Plane) -->
                        <button class="wc-btn-ai-reply" onclick="wcTriggerAI()">
                            <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </div>

                    <!-- Multi-select Footer -->
                    <div id="wc-multi-select-footer">
                        <button class="wc-ios-btn-block wc-btn-secondary" style="width: 40%;" onclick="wcExitMultiSelectMode()">取消</button>
                        <button class="wc-ios-btn-block" style="width: 40%; background: var(--wc-danger-red);" onclick="wcHandleMultiDeleteAction()">删除选中</button>
                    </div>
                </div>

                <!-- Contacts Page -->
                <div id="wc-view-contacts" class="wc-page">
                    <div class="wc-list-group" id="wc-contacts-list"></div>
                </div>

                <!-- Moments Page -->
                <div id="wc-view-moments" class="wc-page" style="padding: 0;">
                    <div class="wc-moments-header">
                        <img id="wc-moments-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="wc-moments-cover" onclick="wcTriggerUpload('cover')">
                        <img id="wc-moments-user-avatar" src="" class="wc-moments-user-avatar">
                    </div>
                    <div id="wc-moments-feed"></div>
                </div>

                <!-- User Page -->
                <div id="wc-view-user" class="wc-page">
                    <div class="wc-user-header">
                        <img id="wc-user-center-avatar" src="" class="wc-user-avatar-lg" onclick="wcTriggerUpload('user')">
                        <h2 id="wc-user-name-display">User</h2>
                    </div>
                    
                    <div class="wc-list-group">
                        <div class="wc-list-item" onclick="wcOpenWallet()">
                            <svg class="wc-icon" style="margin-right: 10px;" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                            <div class="wc-item-content">
                                <div class="wc-item-title">钱包</div>
                            </div>
                            <svg class="wc-icon" style="color: #C7C7CC; width: 20px;" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                        <div class="wc-list-item" onclick="wcOpenMasksModal()">
                            <svg class="wc-icon" style="margin-right: 10px;" viewBox="0 0 24 24"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            <div class="wc-item-content">
                                <div class="wc-item-title">面具 (Masks)</div>
                                <div class="wc-item-subtitle">切换身份与人设</div>
                            </div>
                            <svg class="wc-icon" style="color: #C7C7CC; width: 20px;" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                    </div>
                </div>

                <!-- Wallet Page -->
                <div id="wc-view-wallet" class="wc-page" style="padding: 0;">
                    <div class="wc-wallet-header">
                        <svg class="wc-icon wc-wallet-icon-lg" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                        <div class="wc-wallet-balance-label">当前余额 (元)</div>
                        <div class="wc-wallet-balance-num" id="wc-wallet-balance-display">0.00</div>
                        <div class="wc-wallet-btn-row">
                            <button class="wc-ios-btn-block" style="background: var(--wc-accent-green);" onclick="wcOpenRechargeModal()">充值</button>
                        </div>
                    </div>
                    <div class="wc-list-group-title" style="padding: 0 16px 8px; color: var(--wc-text-secondary); font-size: 13px;">交易记录</div>
                    <div id="wc-wallet-history-list" style="background: #fff;">
                        <!-- Transactions injected here -->
                    </div>
                </div>

                <!-- Memory Full Page (New Full Screen) -->
                <div id="wc-view-memory">
                    <div class="wc-navbar">
                        <div class="wc-nav-left">
                            <button class="wc-nav-btn" onclick="wcCloseMemoryPage()">
                                <svg class="wc-icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
                                返回
                            </button>
                        </div>
                        <div class="wc-nav-title">回忆总结</div>
                        <div class="wc-nav-right">
                            <!-- 设置按钮：关联世界书 & 自动总结条数 -->
                            <button class="wc-nav-btn" onclick="wcOpenMemorySettingsModal()">
                                <svg class="wc-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                            </button>
                            <!-- 更多操作：手动添加/生成 -->
                            <button class="wc-nav-btn" onclick="wcOpenModal('wc-modal-memory-actions')">
                                <svg class="wc-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                            </button>
                        </div>
                    </div>
                    <div class="wc-main-content" style="padding-top: 64px; background: #F2F2F7;">
                        <div id="wc-memory-list-container" style="padding: 16px;">
                            <!-- Memories injected here -->
                        </div>
                    </div>
                </div>

                <!-- Phone Simulator View -->
                <div id="wc-view-phone-sim">
                    <div class="wc-phone-bezel">
                        <div class="wc-phone-notch" onclick="wcOpenPhoneSettings()"></div>
                        
                        <div class="wc-phone-screen" id="wc-phone-screen-bg">
                            <div class="wc-phone-sim-navbar">
                                <div style="width: 40px;"></div>
                                <div style="width: 40px;"></div>
                            </div>

                            <!-- iOS Desktop -->
                            <div class="wc-ios-desktop">
                                <!-- Row 1 & 2: Clock Widget -->
                                <div class="wc-ios-widget-clock">
                                    <div class="wc-ios-clock-time" id="wc-sim-clock-time">12:00</div>
                                    <div class="wc-ios-clock-date" id="wc-sim-clock-date">10月24日 星期二</div>
                                </div>
                                
                                <!-- Row 3: Apps -->
                                <div class="wc-ios-app-item" onclick="wcOpenPhoneApp('message')">
                                    <div class="wc-ios-app-icon" id="wc-icon-message">
                                        <svg class="wc-icon" viewBox="0 0 24 24" style="color: #34C759; width: 32px; height: 32px;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                                    </div>
                                    <div class="wc-ios-app-name">微信</div>
                                </div>
                                <div class="wc-ios-app-item" onclick="alert('Browser App')">
                                    <div class="wc-ios-app-icon" id="wc-icon-browser">
                                        <svg class="wc-icon" viewBox="0 0 24 24" style="color: #007AFF; width: 32px; height: 32px;"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                                    </div>
                                    <div class="wc-ios-app-name">Browser</div>
                                </div>
                                <div class="wc-ios-app-item" onclick="alert('Cart App')">
                                    <div class="wc-ios-app-icon" id="wc-icon-cart">
                                        <svg class="wc-icon" viewBox="0 0 24 24" style="color: #FF9500; width: 32px; height: 32px;"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                                    </div>
                                    <div class="wc-ios-app-name">Cart</div>
                                </div>
                                <div class="wc-ios-app-item" onclick="alert('Settings App')">
                                    <div class="wc-ios-app-icon" id="wc-icon-settings">
                                        <svg class="wc-icon" viewBox="0 0 24 24" style="color: #8E8E93; width: 32px; height: 32px;"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                                    </div>
                                    <div class="wc-ios-app-name">Settings</div>
                                </div>
                            </div>

                            <!-- Phone App: Message (微信内部) -->
                            <div id="wc-phone-app-message" class="wc-phone-app-view" style="display: none;">
                                <!-- 动态 Header -->
                                <div class="wc-phone-sim-navbar" id="wc-phone-app-header" style="background: #F7F7F7; color: #000; border-bottom: 0.5px solid #C6C6C8; justify-content: space-between; padding: 0 10px;">
                                    <!-- 左侧按钮 (JS 动态注入) -->
                                    <div id="wc-phone-header-left"></div>
                                    <!-- 标题 -->
                                    <div style="font-weight: 600;" id="wc-phone-header-title">微信</div>
                                    <!-- 右侧关闭 -->
                                    <div onclick="wcClosePhoneApp()" style="cursor: pointer; font-size: 14px;">关闭</div>
                                </div>
                                
                                <!-- 内容区域 -->
                                <div class="wc-phone-app-content" id="wc-phone-app-content" style="background: #fff;"></div>

                                <!-- 底部 Tab -->
                                <div class="wc-phone-app-tabbar">
                                    <div class="wc-phone-tab-item active" id="wc-phone-tab-chat" onclick="wcSwitchPhoneTab('chat')">
                                        <svg class="wc-icon" style="width: 20px; height: 20px;" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                                        <span>微信</span>
                                    </div>
                                    <div class="wc-phone-tab-item" id="wc-phone-tab-contacts" onclick="wcSwitchPhoneTab('contacts')">
                                        <svg class="wc-icon" style="width: 20px; height: 20px;" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                                        <span>通讯录</span>
                                    </div>
                                    <div class="wc-phone-tab-item" id="wc-phone-tab-me" onclick="wcSwitchPhoneTab('me')">
                                        <svg class="wc-icon" style="width: 20px; height: 20px;" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                        <span>我</span>
                                    </div>
                                </div>
                                
                                <!-- 模拟聊天详情页 (修改：增加底部输入框) -->
                                <div id="wc-phone-sim-chat-detail" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #F2F2F7; z-index: 10; display: none; flex-direction: column;">
                                    <div class="wc-phone-sim-navbar" style="background: #F7F7F7; border-bottom: 0.5px solid #C6C6C8; flex-shrink: 0;">
                                        <div onclick="wcCloseSimChatDetail()" style="cursor: pointer; font-size: 14px; display:flex; align-items:center;">
                                            <svg class="wc-icon" viewBox="0 0 24 24" style="width:20px;height:20px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
                                            微信
                                        </div>
                                        <div style="font-weight: 600;" id="wc-sim-chat-title">Name</div>
                                        <div style="width: 40px;"></div> <!-- 占位 -->
                                    </div>
                                    
                                    <div id="wc-sim-chat-history" style="flex: 1; overflow-y: auto; padding: 10px;"></div>
                                    
                                    <!-- 底部输入框 (新增) -->
                                    <div id="wc-sim-chat-footer" style="padding: 8px 10px; background: #F7F7F7; border-top: 0.5px solid #C6C6C8; display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                                        <input type="text" id="wc-sim-chat-input" style="flex: 1; height: 36px; border-radius: 4px; border: 1px solid #ddd; padding: 0 8px; font-size: 14px;" placeholder="替 TA 回复...">
                                        <button onclick="wcSimSendMsg()" style="background: #07C160; color: white; border: none; border-radius: 4px; padding: 0 12px; height: 36px; font-size: 14px;">发送</button>
                                        <button onclick="wcSimTriggerAI()" style="background: #EDEDED; color: #000; border: none; border-radius: 4px; padding: 0 12px; height: 36px; font-size: 14px;">AI回复</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="wc-phone-home-indicator" onclick="wcClosePhoneSim()"></div>
                    </div>
                </div>

            </main>

            <!-- TabBar -->
            <div class="wc-tabbar-container" id="wc-main-tabbar">
                <div class="wc-tabbar">
                    <div class="wc-tab-item active" onclick="wcSwitchTab('chat')">
                        <svg class="wc-icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        <span>Chat</span>
                    </div>
                    <div class="wc-tab-item" onclick="wcSwitchTab('contacts')">
                        <svg class="wc-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        <span>Contacts</span>
                    </div>
                    <div class="wc-tab-item" onclick="wcSwitchTab('moments')">
                        <svg class="wc-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="14.31" y1="8" x2="20.05" y2="17.94"></line><line x1="9.69" y1="8" x2="21.17" y2="8"></line><line x1="7.38" y1="12" x2="13.12" y2="2.06"></line><line x1="9.69" y1="16" x2="3.95" y2="6.06"></line><line x1="14.31" y1="16" x2="2.83" y2="16"></line><line x1="16.62" y1="12" x2="10.88" y2="21.94"></line></svg>
                        <span>Moments</span>
                    </div>
                    <div class="wc-tab-item" onclick="wcSwitchTab('user')">
                        <svg class="wc-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        <span>User</span>
                    </div>
                </div>
            </div>

            <!-- Modals -->
            <!-- Add Character Modal -->
            <div id="wc-modal-add-char" class="wc-modal-overlay">
                <div class="wc-modal-content">
                    <div class="wc-modal-header">
                        <h3>添加新角色</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-add-char')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-upload-placeholder" onclick="wcTriggerUpload('char')">
                            <img id="wc-preview-char-avatar" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                            <svg id="wc-icon-char-upload" class="wc-icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">名称</label>
                            <input type="text" id="wc-input-char-name" class="wc-form-input" placeholder="角色名字">
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">备注</label>
                            <input type="text" id="wc-input-char-note" class="wc-form-input" placeholder="在列表中显示的名称">
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">人设 (System Prompt)</label>
                            <textarea id="wc-input-char-prompt" class="wc-form-textarea" placeholder="你是一个..."></textarea>
                        </div>
                        <button class="wc-btn-primary" onclick="wcSaveCharacter()">保存</button>
                    </div>
                </div>
            </div>

            <!-- Character Detail Card -->
            <div id="wc-modal-char-detail" class="wc-modal-overlay">
                <div class="wc-modal-content">
                    <div class="wc-contact-card-header">
                        <img id="wc-detail-char-avatar" src="" class="wc-contact-card-img">
                        <div class="wc-contact-card-close-btn" onclick="wcCloseModal('wc-modal-char-detail')">
                            <svg class="wc-icon" style="width: 20px; height: 20px;" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </div>
                        <div class="wc-contact-card-edit-btn" onclick="wcOpenEditCharSettings()">
                            <svg class="wc-icon" style="width: 16px; height: 16px;" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </div>
                    </div>
                    <div class="wc-contact-card-info">
                        <div class="wc-contact-card-name" id="wc-detail-char-name">Name</div>
                        <div class="wc-contact-card-note" id="wc-detail-char-note">Note</div>
                        <button class="wc-ios-btn-block" onclick="wcCheckPhoneAction()">查看对方手机</button>
                    </div>
                </div>
            </div>

            <!-- Hidden Edit Modal for Character -->
            <div id="wc-modal-edit-char-settings" class="wc-modal-overlay">
                <div class="wc-modal-content" style="border-radius: 16px 16px 0 0; position: absolute; bottom: 0; width: 100%; max-width: 100%;">
                    <div class="wc-modal-header">
                        <h3>编辑资料</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-edit-char-settings')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-upload-placeholder" onclick="wcTriggerUpload('edit-char')">
                            <img id="wc-edit-char-avatar" src="" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">名称</label>
                            <input type="text" id="wc-edit-char-name" class="wc-form-input">
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">备注</label>
                            <input type="text" id="wc-edit-char-note" class="wc-form-input">
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">人设 (Prompt)</label>
                            <textarea id="wc-edit-char-prompt" class="wc-form-textarea"></textarea>
                        </div>
                        <button class="wc-btn-primary" onclick="wcUpdateCharacter()">保存修改</button>
                    </div>
                </div>
            </div>

            <!-- Phone Settings Modal -->
            <div id="wc-modal-phone-settings" class="wc-modal-overlay">
                <div class="wc-modal-content" style="border-radius: 16px 16px 0 0; position: absolute; bottom: 0; width: 100%; max-width: 100%;">
                    <div class="wc-modal-header">
                        <h3>手机装修</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-phone-settings')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-form-group">
                            <label class="wc-form-label">桌面壁纸</label>
                            <div class="wc-upload-rect-placeholder" style="width: 100%; height: 150px;" onclick="wcTriggerUpload('phone-bg')">
                                <img id="wc-preview-phone-bg" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                <span id="wc-text-phone-bg">点击上传壁纸</span>
                            </div>
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">APP 图标</label>
                            <div style="display: flex; gap: 10px; justify-content: space-between;">
                                <div class="wc-upload-placeholder" style="width: 60px; height: 60px; margin: 0;" onclick="wcTriggerUpload('icon-msg')">
                                    <img id="wc-preview-icon-msg" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                    <span style="font-size: 10px;">Msg</span>
                                </div>
                                <div class="wc-upload-placeholder" style="width: 60px; height: 60px; margin: 0;" onclick="wcTriggerUpload('icon-browser')">
                                    <img id="wc-preview-icon-browser" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                    <span style="font-size: 10px;">Web</span>
                                </div>
                                <div class="wc-upload-placeholder" style="width: 60px; height: 60px; margin: 0;" onclick="wcTriggerUpload('icon-cart')">
                                    <img id="wc-preview-icon-cart" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                    <span style="font-size: 10px;">Cart</span>
                                </div>
                                <div class="wc-upload-placeholder" style="width: 60px; height: 60px; margin: 0;" onclick="wcTriggerUpload('icon-settings')">
                                    <img id="wc-preview-icon-settings" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                    <span style="font-size: 10px;">Set</span>
                                </div>
                            </div>
                        </div>
                        <button class="wc-btn-primary" onclick="wcSavePhoneSettings()">保存装修</button>
                    </div>
                </div>
            </div>

            <!-- Post Moment Modal -->
            <div id="wc-modal-post-moment" class="wc-modal-overlay">
                <div class="wc-modal-content" style="border-radius: 14px; margin: auto; position: relative; bottom: auto;">
                    <h3>发布动态</h3>
                    <div class="wc-form-group">
                        <textarea id="wc-input-moment-text" class="wc-form-textarea" placeholder="这一刻的想法..."></textarea>
                    </div>
                    <div class="wc-segmented-control">
                        <div class="wc-segment-btn active" id="wc-seg-local" onclick="wcToggleMomentType('local')">本地图片</div>
                        <div class="wc-segment-btn" id="wc-seg-desc" onclick="wcToggleMomentType('desc')">图片描述</div>
                    </div>
                    <div id="wc-area-local-img" class="wc-form-group">
                        <div class="wc-upload-rect-placeholder" onclick="wcTriggerUpload('moment')">
                            <img id="wc-preview-moment-img" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                            <svg id="wc-icon-moment-upload" class="wc-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                        </div>
                        <label class="wc-form-label" style="text-align: center; font-size: 12px;">点击上传 (自动压缩)</label>
                    </div>
                    <div id="wc-area-desc-img" class="wc-form-group" style="display: none;">
                        <input type="text" id="wc-input-moment-desc" class="wc-form-input" placeholder="例如：一张在海边看日落的照片">
                        <label class="wc-form-label" style="text-align: center; font-size: 12px; margin-top: 5px;">将生成图片占位符</label>
                    </div>
                    <button class="wc-btn-primary" onclick="wcSaveMoment()">发布</button>
                    <button class="wc-btn-primary wc-btn-secondary" onclick="wcCloseModal('wc-modal-post-moment')">取消</button>
                </div>
            </div>

            <!-- Masks (Persona) Modal -->
            <div id="wc-modal-masks" class="wc-modal-overlay">
                <div class="wc-modal-content">
                    <div class="wc-modal-header">
                        <h3>我的面具 (Masks)</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-masks')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-list-group" id="wc-masks-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 16px;">
                            <!-- Masks injected here -->
                        </div>
                        <button class="wc-btn-primary" onclick="wcOpenEditMask()">+ 添加新面具</button>
                    </div>
                </div>
            </div>

            <!-- Edit Mask Modal -->
            <div id="wc-modal-edit-mask" class="wc-modal-overlay" style="z-index: 2100;">
                <div class="wc-modal-content">
                    <div class="wc-modal-header">
                        <h3 id="wc-mask-modal-title">编辑面具</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-edit-mask')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-upload-placeholder" onclick="wcTriggerUpload('mask')">
                            <img id="wc-preview-mask-avatar" src="" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">名称</label>
                            <input type="text" id="wc-input-mask-name" class="wc-form-input">
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">人设 (Prompt)</label>
                            <textarea id="wc-input-mask-prompt" class="wc-form-textarea" placeholder="描述这个身份的性格..."></textarea>
                        </div>
                        <button class="wc-btn-primary" onclick="wcSaveMask()">保存面具</button>
                    </div>
                </div>
            </div>

            <!-- Memory Actions Modal -->
            <div id="wc-modal-memory-actions" class="wc-modal hidden" style="z-index: 2200; align-items: flex-end;">
                <div class="wc-modal-content" style="height: auto; border-radius: 12px 12px 0 0; width: 100%; max-width: 100%; background-color: transparent;">
                    <div class="wc-ios-list-group" style="margin: 0 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcOpenMemorySummaryModal(); wcCloseModal('wc-modal-memory-actions');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">自动总结聊天</span>
                        </div>
                        <div class="wc-list-item center-content" onclick="wcOpenModal('wc-modal-memory-add'); wcCloseModal('wc-modal-memory-actions');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">手动添加记忆</span>
                        </div>
                        <div class="wc-list-item center-content" onclick="wcOpenModal('wc-modal-memory-ai-count'); wcCloseModal('wc-modal-memory-actions');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">设置AI读取条数</span>
                        </div>
                    </div>
                    <div class="wc-ios-list-group" style="margin: 10px 10px 20px 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcCloseModal('wc-modal-memory-actions')" style="background: white; height: 56px;">
                            <span style="font-size: 18px; font-weight: bold; color: #007AFF;">取消</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Memory Sub-Modals -->
            <div id="wc-modal-memory-summary" class="wc-modal hidden">
                <div class="wc-modal-content">
                    <div class="wc-modal-header">
                        <h3>生成总结</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-memory-summary')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-form-group"><label class="wc-form-label" id="wc-mem-total-count-label">当前聊天总层数: 0</label></div>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="wc-mem-start-idx" class="wc-form-input" placeholder="起始层数">
                            <input type="number" id="wc-mem-end-idx" class="wc-form-input" placeholder="结束层数">
                        </div>
                        <button id="wc-btn-generate-summary" class="wc-btn-primary" onclick="wcGenerateSummary()">开始生成</button>
                    </div>
                </div>
            </div>

            <!-- 新增：回忆设置弹窗 (包含世界书选择和自动触发条数) -->
            <div id="wc-modal-memory-settings" class="wc-modal hidden" style="z-index: 2600;">
                <div class="wc-modal-content">
                    <div class="wc-modal-header">
                        <h3>回忆设置</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-memory-settings')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-form-group">
                            <label class="wc-form-label">自动总结触发条数 (0为关闭)</label>
                            <input type="number" id="wc-mem-setting-trigger" class="wc-form-input" placeholder="例如: 20">
                            <div style="font-size: 11px; color: #888; margin-top: 4px;">每当聊天达到此数量时，自动触发总结。</div>
                        </div>
                        
                        <div class="wc-form-group">
                            <label class="wc-form-label">关联世界书 (仅用于总结)</label>
                            <div id="wc-mem-setting-wb-list" class="wc-checkbox-list" style="max-height: 200px; overflow-y: auto;">
                                <!-- JS 注入 -->
                            </div>
                        </div>
                        
                        <button class="wc-btn-primary" onclick="wcSaveMemorySettings()">保存设置</button>
                    </div>
                </div>
            </div>

            <div id="wc-modal-memory-add" class="wc-modal hidden">
                <div class="wc-modal-content">
                    <div class="wc-modal-header"><h3>添加记忆</h3><button class="wc-close-btn" onclick="wcCloseModal('wc-modal-memory-add')">&times;</button></div>
                    <div class="wc-modal-body">
                        <textarea id="wc-mem-manual-text" class="wc-form-textarea" placeholder="例如：用户喜欢吃苹果..."></textarea>
                        <button class="wc-btn-primary" onclick="wcAddManualMemory()">添加</button>
                    </div>
                </div>
            </div>
            <div id="wc-modal-memory-ai-count" class="wc-modal hidden">
                <div class="wc-modal-content">
                    <div class="wc-modal-header"><h3>AI读取记忆条数</h3><button class="wc-close-btn" onclick="wcCloseModal('wc-modal-memory-ai-count')">&times;</button></div>
                    <div class="wc-modal-body">
                        <div class="wc-form-group"><label class="wc-form-label">发送给AI的最新记忆数量</label><input type="number" id="wc-mem-ai-read-count" class="wc-form-input" placeholder="默认: 5"></div>
                        <button class="wc-btn-primary" onclick="wcSaveAiMemoryCount()">保存</button>
                    </div>
                </div>
            </div>

            <!-- 生成通讯录弹窗 -->
            <div id="wc-modal-gen-contacts" class="wc-modal hidden" style="z-index: 3000;">
                <div class="wc-modal-content">
                    <div class="wc-modal-header">
                        <h3>生成通讯录</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-gen-contacts')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-form-group">
                            <label class="wc-form-label">生成人数范围 (包含群聊)</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="wc-gen-contact-min" class="wc-form-input" placeholder="最小 (如 3)" value="3">
                                <input type="number" id="wc-gen-contact-max" class="wc-form-input" placeholder="最大 (如 8)" value="8">
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #888; margin-bottom: 10px;">
                            将根据人设和世界书生成好友、群聊以及待验证的好友请求。
                        </div>
                        <button class="wc-btn-primary" onclick="wcGeneratePhoneContacts()">开始生成</button>
                    </div>
                </div>
            </div>

            <!-- 通讯录好友详情卡片 (重构 UI) -->
            <div id="wc-modal-phone-contact-card" class="wc-modal hidden" style="z-index: 3100; align-items: center; justify-content: center; display: flex;">
                <!-- 卡片容器：固定大小 280x360 -->
                <div class="wc-modal-content" style="width: 280px; height: 360px; padding: 0; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; position: relative;">
                    
                    <!-- 关闭按钮 -->
                    <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-phone-contact-card')" style="position: absolute; top: 10px; right: 10px; z-index: 10;">&times;</button>
                    
                    <!-- 上半部分：头像和信息 -->
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; background: #fff;">
                        <div id="wc-card-contact-avatar" style="width: 80px; height: 80px; border-radius: 8px; background: #eee; margin-bottom: 15px; overflow: hidden;"></div>
                        <div class="wc-contact-card-name" id="wc-card-contact-name" style="font-size: 22px; font-weight: 600; color: #000;">Name</div>
                        <div id="wc-card-contact-desc" style="font-size: 13px; color: #888; margin-top: 8px; text-align: center; padding: 0 10px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">Desc</div>
                    </div>

                    <!-- 下半部分：操作按钮 -->
                    <div style="padding: 20px; background: #F7F7F7; border-top: 1px solid #eee; display: flex; flex-direction: column; gap: 10px;">
                        <button class="wc-ios-btn-block" style="background: #07C160; color: white; height: 40px; font-size: 14px;" onclick="wcShareContactToMain()">添加至列表</button>
                        <button class="wc-ios-btn-block" style="background: #fff; color: #000; border: 1px solid #ddd; height: 40px; font-size: 14px;" onclick="wcOpenShareCardModal()">分享名片</button>
                        <button class="wc-ios-btn-block" style="background: transparent; color: #FA5151; height: 30px; font-size: 14px; margin-top: 5px;" onclick="wcDeletePhoneContact()">删除好友</button>
                    </div>
                </div>
            </div>

            <!-- 分享名片选择列表弹窗 (新增) -->
            <div id="wc-modal-share-card-select" class="wc-modal hidden" style="z-index: 3200;">
                <div class="wc-modal-content">
                    <div class="wc-modal-header">
                        <h3>选择分享对象</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-share-card-select')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div id="wc-share-card-list" style="max-height: 300px; overflow-y: auto;">
                            <!-- JS 注入好友列表 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- General Input Modal -->
            <div id="wc-modal-general-input" class="wc-modal hidden" style="z-index: 2400;">
                <div class="wc-modal-content" style="width: 80%; max-width: 300px; border-radius: 12px;">
                    <div style="padding: 20px;">
                        <h3 style="margin-top: 0; text-align: center;" id="wc-general-input-title">输入</h3>
                        <div class="wc-form-group">
                            <input type="text" id="wc-general-input-field" class="wc-form-input" style="text-align: center;">
                        </div>
                        <button class="wc-btn-primary" id="wc-general-input-confirm">确定</button>
                        <button class="wc-btn-primary wc-btn-secondary" onclick="wcCloseModal('wc-modal-general-input')">取消</button>
                    </div>
                </div>
            </div>

            <!-- Transfer Input Modal -->
            <div id="wc-modal-transfer-input" class="wc-modal hidden" style="z-index: 2300;">
                <div class="wc-modal-content" style="width: 80%; max-width: 300px; border-radius: 12px;">
                    <div style="padding: 20px;">
                        <h3 style="margin-top: 0; text-align: center;">转账</h3>
                        <div class="wc-form-group">
                            <label class="wc-form-label">金额</label>
                            <input type="number" id="wc-transfer-amount" class="wc-form-input" placeholder="0.00" style="font-size: 24px; text-align: center;">
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">备注</label>
                            <input type="text" id="wc-transfer-note" class="wc-form-input" placeholder="转账说明">
                        </div>
                        <button class="wc-btn-primary" onclick="wcSubmitTransferDetails()">下一步</button>
                        <button class="wc-btn-primary wc-btn-secondary" onclick="wcCloseModal('wc-modal-transfer-input')">取消</button>
                    </div>
                </div>
            </div>

            <!-- Transfer Action Sheet -->
            <div id="wc-modal-transfer-action" class="wc-modal hidden" style="z-index: 2200; align-items: flex-end;">
                <div class="wc-modal-content" style="height: auto; border-radius: 12px 12px 0 0; width: 100%; max-width: 100%; background-color: transparent;">
                    <div class="wc-ios-list-group" style="margin: 0 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcConfirmTransferReceive()" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">确认收款</span>
                        </div>
                        <div class="wc-list-item center-content" onclick="wcConfirmTransferReject()" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #FF3B30;">退还</span>
                        </div>
                    </div>
                    <div class="wc-ios-list-group" style="margin: 10px 10px 20px 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcCloseModal('wc-modal-transfer-action')" style="background: white; height: 56px;">
                            <span style="font-size: 18px; font-weight: bold; color: #007AFF;">取消</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wallet Settings Modal -->
            <div id="wc-modal-wallet-settings" class="wc-modal hidden" style="z-index: 2200; align-items: flex-end;">
                <div class="wc-modal-content" style="height: auto; border-radius: 12px 12px 0 0; width: 100%; max-width: 100%; background-color: transparent;">
                    <div class="wc-ios-list-group" style="margin: 0 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcOpenSetPasswordModal(); wcCloseModal('wc-modal-wallet-settings');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">设置/修改支付密码</span>
                        </div>
                        <div class="wc-list-item center-content" onclick="wcClearTransactionHistory(); wcCloseModal('wc-modal-wallet-settings');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #FF3B30;">清空交易记录</span>
                        </div>
                    </div>
                    <div class="wc-ios-list-group" style="margin: 10px 10px 20px 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcCloseModal('wc-modal-wallet-settings')" style="background: white; height: 56px;">
                            <span style="font-size: 18px; font-weight: bold; color: #007AFF;">取消</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recharge Modal -->
            <div id="wc-modal-recharge" class="wc-modal hidden" style="z-index: 2300;">
                <div class="wc-modal-content" style="width: 80%; max-width: 300px; border-radius: 12px;">
                    <div style="padding: 20px;">
                        <h3 style="margin-top: 0; text-align: center;">充值余额</h3>
                        <div class="wc-form-group">
                            <label class="wc-form-label">金额</label>
                            <input type="number" id="wc-recharge-amount" class="wc-form-input" placeholder="0.00" style="font-size: 24px; text-align: center;">
                        </div>
                        <button class="wc-btn-primary" style="background: var(--wc-accent-green);" onclick="wcConfirmRecharge()">确认充值</button>
                        <button class="wc-btn-primary wc-btn-secondary" onclick="wcCloseModal('wc-modal-recharge')">取消</button>
                    </div>
                </div>
            </div>

            <!-- CHAT SETTINGS MODAL -->
            <div id="wc-modal-chat-settings" class="wc-modal hidden" style="z-index: 2500;">
                <div class="wc-modal-content" style="background: #F2F2F7;">
                    <div class="wc-navbar" style="position: sticky; top: 0;">
                        <div class="wc-nav-left">
                            <button class="wc-nav-btn" onclick="wcCloseModal('wc-modal-chat-settings')">关闭</button>
                        </div>
                        <div class="wc-nav-title">聊天设置</div>
                        <div class="wc-nav-right">
                            <button class="wc-nav-btn" style="color: var(--wc-accent-green); font-weight: 600;" onclick="wcSaveChatSettings()">保存</button>
                        </div>
                    </div>
                    <div class="wc-modal-body" style="padding-top: 10px; max-height: none; flex: 1;">
                        
                        <!-- Character Settings -->
                        <div class="wc-settings-section">
                            <div class="wc-settings-section-title">角色设置 (仅当前聊天)</div>
                            <div class="wc-avatar-row">
                                <img id="wc-setting-char-avatar" src="" class="wc-avatar-edit" onclick="wcTriggerUpload('setting-char')">
                                <div style="flex: 1;">
                                    <label class="wc-form-label">名称</label>
                                    <input type="text" id="wc-setting-char-name" class="wc-form-input" style="background: #F2F2F7;">
                                </div>
                            </div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">备注</label>
                                <input type="text" id="wc-setting-char-note" class="wc-form-input">
                            </div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">人设 (Prompt)</label>
                                <textarea id="wc-setting-char-prompt" class="wc-form-textarea" style="height: 80px;"></textarea>
                            </div>
                        </div>

                        <!-- User Persona Settings -->
                        <div class="wc-settings-section">
                            <div class="wc-settings-section-title">我的身份 (仅当前聊天)</div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">从面具导入</label>
                                <select id="wc-setting-user-mask-select" class="wc-form-input" onchange="wcImportMaskToChat(this.value)">
                                    <option value="">选择面具...</option>
                                </select>
                            </div>
                            <div class="wc-avatar-row">
                                <img id="wc-setting-user-avatar" src="" class="wc-avatar-edit" onclick="wcTriggerUpload('setting-user')">
                                <div style="flex: 1;">
                                    <label class="wc-form-label">名称</label>
                                    <input type="text" id="wc-setting-user-name" class="wc-form-input">
                                </div>
                            </div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">人设 (Prompt)</label>
                                <textarea id="wc-setting-user-prompt" class="wc-form-textarea" style="height: 80px;"></textarea>
                            </div>
                        </div>

                        <!-- Advanced Settings -->
                        <div class="wc-settings-section">
                            <div class="wc-settings-section-title">高级设置</div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">上下文条数限制 (0为不限制)</label>
                                <input type="number" id="wc-setting-context-limit" class="wc-form-input" value="0">
                            </div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">自动总结触发条数 (0为关闭)</label>
                                <input type="number" id="wc-setting-summary-trigger" class="wc-form-input" value="0">
                            </div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">关联世界书条目 (多选)</label>
                                <div id="wc-setting-worldbook-list" class="wc-checkbox-list">
                                    <!-- Checkboxes injected via JS -->
                                </div>
                            </div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">关联表情包分组 (多选)</label>
                                <div id="wc-setting-sticker-group-list" class="wc-checkbox-list">
                                    <!-- Checkboxes injected via JS -->
                                </div>
                            </div>
                        </div>

                        <!-- Appearance -->
                        <div class="wc-settings-section">
                            <div class="wc-settings-section-title">外观与美化</div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">聊天背景图</label>
                                <div class="wc-upload-rect-placeholder" style="width: 100%; height: 120px;" onclick="wcTriggerUpload('setting-bg')">
                                    <img id="wc-setting-bg-preview" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                    <span id="wc-setting-bg-text">点击上传背景</span>
                                </div>
                                <button class="wc-ios-btn-block wc-btn-secondary" style="padding: 8px; font-size: 14px; margin-top: 8px;" onclick="wcClearChatBackground()">清除背景</button>
                            </div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">自定义 CSS</label>
                                <textarea id="wc-setting-custom-css" class="wc-form-textarea" style="height: 150px; font-family: monospace; font-size: 12px;" placeholder="/* 输入 CSS 代码 */"></textarea>
                            </div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">CSS 预设</label>
                                <div style="display: flex; gap: 10px;">
                                    <select id="wc-setting-css-preset-select" class="wc-form-input" style="flex: 1;" onchange="wcApplyCssPreset(this.value)">
                                        <option value="">选择预设...</option>
                                    </select>
                                    <button class="wc-ios-btn-block" style="width: 80px; padding: 0;" onclick="wcSaveCssPreset()">保存</button>
                                </div>
                            </div>
                        </div>

                        <!-- Data Management -->
                        <div class="wc-settings-section">
                            <div class="wc-settings-section-title">数据管理</div>
                            <button class="wc-ios-btn-block" style="background: var(--wc-danger-red);" onclick="wcClearChatHistory()">清空聊天记录</button>
                        </div>

                        <div style="height: 50px;"></div>
                    </div>
                </div>
            </div>

            <!-- 批量导入表情包弹窗 -->
            <div id="wc-import-sticker-modal" class="wc-modal hidden" style="z-index: 3100;">
                <div class="wc-modal-content">
                    <div class="wc-modal-header">
                        <h3>导入表情包</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-import-sticker-modal')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-setting-group">
                            <label>分类名称</label>
                            <input type="text" id="wc-sticker-category-name" placeholder="例如：猫咪表情">
                        </div>
                        <div class="wc-setting-group">
                            <label>表情包列表 (格式: 描述：URL)</label>
                            <textarea id="wc-sticker-import-text" placeholder="开心：https://example.com/1.jpg&#10;难过：https://example.com/2.jpg" style="height: 200px;"></textarea>
                        </div>
                        <button id="wc-save-sticker-import-btn" class="wc-ios-btn-block" onclick="wcImportStickers()">导入</button>
                    </div>
                </div>
            </div>

            <!-- 表情包选项弹窗 -->
            <div id="wc-sticker-options-modal" class="wc-modal hidden" style="z-index: 3000; align-items: flex-end;">
                <div class="wc-modal-content" style="height: auto; border-radius: 12px 12px 0 0; width: 100%; max-width: 100%; background-color: transparent;">
                    <div class="wc-ios-list-group" style="margin: 0 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcToggleStickerDeleteMode(); wcCloseModal('wc-sticker-options-modal');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;" id="wc-btn-sticker-manage-text">管理表情 (删除)</span>
                        </div>
                        <div class="wc-list-item center-content" onclick="wcOpenModal('wc-import-sticker-modal'); wcCloseModal('wc-sticker-options-modal');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">导入表情</span>
                        </div>
                        <div class="wc-list-item center-content" onclick="wcOpenDeleteCategoriesModal(); wcCloseModal('wc-sticker-options-modal');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #FF3B30;">删除分类</span>
                        </div>
                    </div>
                    <div class="wc-ios-list-group" style="margin: 10px 10px 20px 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcCloseModal('wc-sticker-options-modal')" style="background: white; height: 56px;">
                            <span style="font-size: 18px; font-weight: bold; color: #007AFF;">取消</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 删除表情包分类弹窗 -->
            <div id="wc-sticker-delete-cats-modal" class="wc-modal hidden" style="z-index: 3100; align-items: flex-end;">
                <div class="wc-modal-content" style="height: auto; border-radius: 12px 12px 0 0; width: 100%; max-width: 100%; background-color: transparent;">
                    <div class="wc-ios-list-group" style="margin: 0 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item" style="background: white; padding: 12px 16px; font-weight: 600; justify-content: center;">选择要删除的表情包分类</div>
                        <div id="wc-sticker-delete-cats-list" style="background: #fff; display: flex; flex-direction: column; max-height: 300px; overflow-y: auto;">
                            <!-- Categories injected here -->
                        </div>
                    </div>
                    <div class="wc-ios-list-group" style="margin: 10px 10px 20px 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item" style="background: white; height: 56px; display: flex; gap: 10px; justify-content: center; align-items: center;">
                            <button class="wc-ios-btn-block" style="max-width: 160px; background: var(--wc-danger-red);" onclick="wcConfirmDeleteCategories()">删除所选</button>
                            <button class="wc-ios-btn-block wc-btn-secondary" style="max-width: 120px;" onclick="wcCloseModal('wc-sticker-delete-cats-modal')">取消</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Image Type Modal -->
            <div id="wc-modal-image-type" class="wc-modal hidden" style="z-index: 2200; align-items: flex-end;">
                <div class="wc-modal-content" style="height: auto; border-radius: 12px 12px 0 0; width: 100%; max-width: 100%; background-color: transparent;">
                    <div class="wc-ios-list-group" style="margin: 0 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcTriggerUpload('chat-img'); wcCloseModal('wc-modal-image-type');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">从相册选择</span>
                        </div>
                        <div class="wc-list-item center-content" onclick="wcActionImageDesc(); wcCloseModal('wc-modal-image-type');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">文字描述图片</span>
                        </div>
                    </div>
                    <div class="wc-ios-list-group" style="margin: 10px 10px 20px 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcCloseModal('wc-modal-image-type')" style="background: white; height: 56px;">
                            <span style="font-size: 18px; font-weight: bold; color: #007AFF;">取消</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden Inputs -->
            <input type="file" id="wc-file-input-char" accept="image/*" onchange="wcHandleFileSelect(event, 'char')" style="display:none;">
            <input type="file" id="wc-file-input-edit-char" accept="image/*" onchange="wcHandleFileSelect(event, 'edit-char')" style="display:none;">
            <input type="file" id="wc-file-input-user" accept="image/*" onchange="wcHandleFileSelect(event, 'user')" style="display:none;">
            <input type="file" id="wc-file-input-cover" accept="image/*" onchange="wcHandleFileSelect(event, 'cover')" style="display:none;">
            <input type="file" id="wc-file-input-moment" accept="image/*" onchange="wcHandleFileSelect(event, 'moment')" style="display:none;">
            <input type="file" id="wc-file-input-mask" accept="image/*" onchange="wcHandleFileSelect(event, 'mask')" style="display:none;">
            <input type="file" id="wc-file-input-chat-img" accept="image/*" onchange="wcHandleFileSelect(event, 'chat-img')" style="display:none;">
            
            <!-- Settings Inputs -->
            <input type="file" id="wc-file-input-setting-char" accept="image/*" onchange="wcHandleFileSelect(event, 'setting-char')" style="display:none;">
            <input type="file" id="wc-file-input-setting-user" accept="image/*" onchange="wcHandleFileSelect(event, 'setting-user')" style="display:none;">
            <input type="file" id="wc-file-input-setting-bg" accept="image/*" onchange="wcHandleFileSelect(event, 'setting-bg')" style="display:none;">

            <!-- Phone Sim Inputs -->
            <input type="file" id="wc-file-input-phone-bg" accept="image/*" onchange="wcHandleFileSelect(event, 'phone-bg')" style="display:none;">
            <input type="file" id="wc-file-input-icon-msg" accept="image/*" onchange="wcHandleFileSelect(event, 'icon-msg')" style="display:none;">
            <input type="file" id="wc-file-input-icon-browser" accept="image/*" onchange="wcHandleFileSelect(event, 'icon-browser')" style="display:none;">
            <input type="file" id="wc-file-input-icon-cart" accept="image/*" onchange="wcHandleFileSelect(event, 'icon-cart')" style="display:none;">
            <input type="file" id="wc-file-input-icon-settings" accept="image/*" onchange="wcHandleFileSelect(event, 'icon-settings')" style="display:none;">

            <style id="wc-custom-css-style"></style>
        </div>
    </div>

    <style id="dynamic-font-style"></style>
    <script src="script.js"></script>
<script>
// --- 全局变量 ---
const totalApps = 7;
let iconPresets = [];
let fontPresets = [];
let wallpaperPresets = [];
let apiPresets = [];

// 世界书数据 (全局共享)
let worldbookEntries = [];
let worldbookGroups = [];
let currentEditingId = null;

// 总结专用世界书选择
let tempSummaryWbIds = [];

let pendingDeleteType = ''; 
let pendingDeleteIndex = -1;
let pendingSaveType = '';

let dragItem = null;
let dragGhost = null;
let dragStartX = 0;
let dragStartY = 0;
let longPressTimer = null;
let isDragging = false;

// 手机仿真器相关全局变量
let wcActiveSimChatId = null; // 当前正在查看的模拟对话ID
let currentPhoneContact = null; // 当前正在查看的通讯录联系人

// --- IndexedDB 封装 (iOS Theme) ---
const idb = {
    dbName: 'iOSThemeStudioDB',
    storeName: 'settings',
    version: 1,
    db: null,

    async open() {
        if (this.db) return this.db;
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.version);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(this.storeName)) {
                    db.createObjectStore(this.storeName);
                }
            };
            request.onsuccess = (e) => {
                this.db = e.target.result;
                resolve(this.db);
            };
            request.onerror = (e) => reject(e);
        });
    },

    async get(key) {
        await this.open();
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readonly');
            const store = tx.objectStore(this.storeName);
            const req = store.get(key);
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    },

    async set(key, value) {
        await this.open();
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readwrite');
            const store = tx.objectStore(this.storeName);
            const req = store.put(value, key);
            req.onsuccess = () => resolve();
            req.onerror = () => reject(req.error);
        });
    },

    async clear() {
        await this.open();
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readwrite');
            const store = tx.objectStore(this.storeName);
            const req = store.clear();
            req.onsuccess = () => resolve();
            req.onerror = () => reject(req.error);
        });
    },
    
    async getAllKeys() {
        await this.open();
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(this.storeName, 'readonly');
            const store = tx.objectStore(this.storeName);
            const req = store.getAllKeys();
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    }
};

// --- 初始化 ---
window.onload = async function() {
    initGrid(); 
    loadAllData(); // 加载 IndexedDB 数据
    startClock();

    // 初始化 WeChat DB
    try {
        await wcDb.init();
        await wcLoadData();
        wcRenderAll();
        wcSwitchTab('chat');
    } catch (e) {
        console.error("WeChat DB Init failed", e);
    }
    
    // WeChat 全局点击隐藏菜单
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.wc-bubble') && !e.target.closest('#wc-context-menu')) {
            wcHideContextMenu();
        }
    });

    const bgFileInput = document.getElementById('bgFileInput');
    if (bgFileInput) {
        bgFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const url = evt.target.result;
                    document.getElementById('mainScreen').style.backgroundImage = `url('${url}')`;
                    saveThemeSettings();
                    addWallpaperToGrid(url);
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // 修复：通用输入框确认按钮事件绑定
    const generalConfirmBtn = document.getElementById('wc-general-input-confirm');
    if (generalConfirmBtn) {
        generalConfirmBtn.onclick = function() {
            const val = document.getElementById('wc-general-input-field').value;
            if (wcState.generalInputCallback) {
                wcState.generalInputCallback(val);
            }
            wcCloseModal('wc-modal-general-input');
        };
    }
};

// --- 数据加载逻辑 (异步) ---
async function loadAllData() {
    try {
        // 1. 加载小组件数据
        const widgetData = await idb.get('ios_theme_widget') || {};
        if (widgetData.bg) document.getElementById('mainWidget').style.backgroundImage = widgetData.bg;
        if (widgetData.avatar) {
            const av = document.getElementById('widgetAvatar');
            av.style.backgroundImage = widgetData.avatar;
            av.style.backgroundSize = 'cover';
        }
        if (widgetData.text) document.getElementById('widgetText').innerText = widgetData.text;

        // 2. 加载 Apple ID 数据
        const appleData = await idb.get('ios_theme_apple') || {};
        if (appleData.avatar) {
            const av = document.getElementById('appleIdAvatar');
            const avDetail = document.getElementById('appleIdDetailAvatar');
            av.style.backgroundImage = appleData.avatar;
            av.style.backgroundSize = 'cover';
            av.innerText = '';
            avDetail.style.backgroundImage = appleData.avatar;
            avDetail.style.backgroundSize = 'cover';
            avDetail.innerText = '';
        }
        if (appleData.name) {
            document.getElementById('appleIdName').innerText = appleData.name;
            document.getElementById('appleIdDetailName').innerText = appleData.name;
        }

        // 3. 加载世界书数据
        worldbookEntries = JSON.parse(await idb.get('ios_theme_wb_entries') || '[]');
        worldbookGroups = JSON.parse(await idb.get('ios_theme_wb_groups') || '[]');

        // 4. 加载主题设置 (壁纸、字体)
        const themeData = await idb.get('ios_theme_settings') || {};
        if (themeData.wallpaper) document.getElementById('mainScreen').style.backgroundImage = themeData.wallpaper;
        if (themeData.fontSize) {
            changeFontSize(themeData.fontSize);
            document.getElementById('fontSizeSlider').value = themeData.fontSize;
        }
        if (themeData.fontUrl) {
            document.getElementById('fontUrlInput').value = themeData.fontUrl;
            applyFont(themeData.fontUrl);
        }

        // 5. 加载 App 布局
        const appsData = JSON.parse(await idb.get('ios_theme_apps') || '[]');
        appsData.forEach(app => {
            const nameEl = document.getElementById(`name-${app.id}`);
            const iconEl = document.getElementById(`icon-${app.id}`);
            if (nameEl) nameEl.innerText = app.name;
            if (iconEl && app.iconBg) {
                iconEl.style.backgroundImage = app.iconBg;
                iconEl.style.backgroundColor = 'transparent';
            }
        });

        // 6. 加载预设
        const presets = await idb.get('ios_theme_presets') || {};
        iconPresets = presets.icons || [];
        fontPresets = presets.fonts || [];
        wallpaperPresets = presets.wallpapers || [];
        apiPresets = presets.apis || [];

        // 7. 加载 API 设置
        const apiConfig = await idb.get('ios_theme_api_config') || {};
        if (apiConfig.baseUrl) document.getElementById('apiBaseUrl').value = apiConfig.baseUrl;
        if (apiConfig.key) document.getElementById('apiKey').value = apiConfig.key;
        if (apiConfig.temp) {
            document.getElementById('tempSlider').value = apiConfig.temp;
            document.getElementById('tempDisplay').innerText = apiConfig.temp;
        }
        if (apiConfig.model) {
             const select = document.getElementById('modelSelect');
             if (select.options.length <= 1) {
                 const opt = document.createElement('option');
                 opt.value = apiConfig.model;
                 opt.innerText = apiConfig.model + " (已保存)";
                 opt.selected = true;
                 select.appendChild(opt);
             }
        }

        // 渲染列表
        renderAppEditors();
        renderWallpaperGrid();
        renderIconPresets();
        renderFontPresets();
        renderApiPresets();

    } catch (e) {
        console.error("IndexedDB Load Error:", e);
    }
}

// --- 数据保存逻辑 ---
async function saveWidgetData() {
    const data = {
        bg: document.getElementById('mainWidget').style.backgroundImage,
        avatar: document.getElementById('widgetAvatar').style.backgroundImage,
        text: document.getElementById('widgetText').innerText
    };
    await idb.set('ios_theme_widget', data);
}

async function saveAppleData() {
    const data = {
        avatar: document.getElementById('appleIdAvatar').style.backgroundImage,
        name: document.getElementById('appleIdName').innerText
    };
    await idb.set('ios_theme_apple', data);
}

async function saveWorldbookData() {
    await idb.set('ios_theme_wb_entries', JSON.stringify(worldbookEntries));
    await idb.set('ios_theme_wb_groups', JSON.stringify(worldbookGroups));
}

async function saveThemeSettings() {
    const data = {
        wallpaper: document.getElementById('mainScreen').style.backgroundImage,
        fontSize: document.getElementById('fontSizeSlider').value,
        fontUrl: document.getElementById('fontUrlInput').value
    };
    await idb.set('ios_theme_settings', data);
}

async function saveAppsData() {
    const apps = [];
    for (let i = 0; i < totalApps; i++) {
        const iconElem = document.getElementById(`icon-${i}`);
        let bg = window.getComputedStyle(iconElem).backgroundImage;
        if (bg === 'none') bg = '';
        apps.push({
            id: i,
            name: document.getElementById(`name-${i}`).innerText,
            iconBg: bg
        });
    }
    await idb.set('ios_theme_apps', JSON.stringify(apps));
}

async function savePresetsData() {
    const data = {
        icons: iconPresets,
        fonts: fontPresets,
        wallpapers: wallpaperPresets,
        apis: apiPresets
    };
    await idb.set('ios_theme_presets', data);
}

// --- Apple ID 页面逻辑 ---
function openAppleIdSettings() { document.getElementById('appleIdSettingsModal').classList.add('open'); }
function closeAppleIdSettings() { document.getElementById('appleIdSettingsModal').classList.remove('open'); }

// 存储分析弹窗逻辑
function openStorageAnalysis() { document.getElementById('storageModalOverlay').classList.add('active'); analyzeStorage(); }
function closeStorageModal() { document.getElementById('storageModalOverlay').classList.remove('active'); }

async function analyzeStorage() {
    const keys = {
        '世界书': ['ios_theme_wb_entries', 'ios_theme_wb_groups'],
        '图片/媒体': ['ios_theme_widget', 'ios_theme_apple', 'ios_theme_apps'],
        '预设库': ['ios_theme_presets'],
        '系统设置': ['ios_theme_settings', 'ios_theme_api_config']
    };
    const colors = { '世界书': '#007aff', '图片/媒体': '#ff9500', '预设库': '#34c759', '系统设置': '#8e8e93' };
    let usage = {};
    let totalBytes = 0;

    for (let category in keys) {
        usage[category] = 0;
        for (let key of keys[category]) {
            const val = await idb.get(key);
            if (val) {
                const str = typeof val === 'string' ? val : JSON.stringify(val);
                usage[category] += str.length;
            }
        }
        totalBytes += usage[category];
    }

    const canvas = document.getElementById('storageChart');
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = 140;
    const lineWidth = 40;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.lineWidth = lineWidth;
    ctx.lineCap = 'round';

    let startAngle = 0;
    if (totalBytes === 0) {
        ctx.beginPath(); ctx.strokeStyle = '#e5e5ea'; ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI); ctx.stroke();
    } else {
        for (let category in usage) {
            if (usage[category] > 0) {
                const sliceAngle = (usage[category] / totalBytes) * 2 * Math.PI;
                ctx.beginPath(); ctx.strokeStyle = colors[category]; ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle); ctx.stroke();
                startAngle += sliceAngle;
            }
        }
    }

    const totalKB = (totalBytes / 1024).toFixed(2);
    document.getElementById('storageTotal').innerText = totalKB + ' KB';
    const legend = document.getElementById('storageLegend');
    legend.innerHTML = '';
    for (let category in usage) {
        const kb = (usage[category] / 1024).toFixed(2);
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.innerHTML = `<div class="legend-color" style="background:${colors[category]}"></div><div class="legend-name">${category}</div><div class="legend-value">${kb} KB</div>`;
        legend.appendChild(item);
    }
}

async function exportData() {
    const data = {};
    const keys = await idb.getAllKeys();
    for (let key of keys) {
        if (key.startsWith('ios_theme_')) {
            data[key] = await idb.get(key);
        }
    }
    const exportObj = { signature: 'ios_theme_studio_backup', timestamp: Date.now(), data: data };
    const blob = new Blob([JSON.stringify(exportObj)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `ios_theme_backup_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}

function importData(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const json = JSON.parse(e.target.result);
            if (json.signature !== 'ios_theme_studio_backup') return alert("导入失败：文件格式不正确。");
            if (confirm("这将覆盖当前所有数据，确定要恢复吗？")) {
                const data = json.data;
                for (let key in data) await idb.set(key, data[key]);
                alert("数据恢复成功，页面将刷新。");
                location.reload();
            }
        } catch (err) { alert("导入失败：文件损坏。"); }
    };
    reader.readAsText(file);
    input.value = '';
}

async function clearAllData() {
    if (confirm("警告：此操作将永久删除所有数据！确定要继续吗？")) {
        if (confirm("再次确认：真的要清空所有数据吗？")) {
            await idb.clear();
            alert("数据已清空，页面将重置。");
            location.reload();
        }
    }
}

// --- 时钟与小组件 ---
function startClock() {
    function update() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const day = now.getDate();
        document.getElementById('widgetTime').innerText = `${hours}:${minutes}`;
        document.getElementById('widgetDate').innerText = `${year}/${month}/${day}`;
    }
    update();
    setInterval(update, 1000);
}

function triggerWidgetBgUpload() { document.getElementById('widgetBgInput').click(); }
function handleWidgetBgUpload(input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) { 
            document.getElementById('mainWidget').style.backgroundImage = `url('${e.target.result}')`; 
            saveWidgetData(); 
        };
        reader.readAsDataURL(file);
    }
}
function triggerAvatarUpload() { document.getElementById('widgetAvatarInput').click(); }
function handleWidgetAvatarUpload(input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) { 
            const avatar = document.getElementById('widgetAvatar');
            avatar.style.backgroundImage = `url('${e.target.result}')`; 
            avatar.style.backgroundSize = 'cover';
            saveWidgetData(); 
        };
        reader.readAsDataURL(file);
    }
}
function editWidgetText() {
    openTextEditModal("编辑签名", "请输入要显示的文本内容", document.getElementById('widgetText').innerText, (val) => {
        if(val) {
            document.getElementById('widgetText').innerText = val;
            saveWidgetData(); 
        }
    });
}

// --- Apple ID 交互 ---
function triggerAppleAvatarUpload() { document.getElementById('appleAvatarInput').click(); }
function handleAppleAvatarUpload(input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) { 
            const bg = `url('${e.target.result}')`;
            document.getElementById('appleIdAvatar').style.backgroundImage = bg; 
            document.getElementById('appleIdAvatar').innerText = ''; 
            document.getElementById('appleIdAvatar').style.backgroundSize = 'cover';
            document.getElementById('appleIdDetailAvatar').style.backgroundImage = bg;
            document.getElementById('appleIdDetailAvatar').innerText = '';
            document.getElementById('appleIdDetailAvatar').style.backgroundSize = 'cover';
            saveAppleData(); 
        };
        reader.readAsDataURL(file);
    }
}
function editAppleIdText() {
    const nameElem = document.getElementById('appleIdName');
    openTextEditModal("编辑 Apple ID", "请输入显示的名称", nameElem.innerText, (val) => {
        if(val) {
            nameElem.innerText = val;
            document.getElementById('appleIdDetailName').innerText = val;
            saveAppleData(); 
        }
    });
}

// --- 恢复默认 ---
function resetWallpaper() {
    document.getElementById('mainScreen').style.backgroundImage = '';
    document.getElementById('bgUrlInput').value = '';
    saveThemeSettings(); 
}
function resetIcons() {
    const defaultNames = ['App 1', 'App 2', 'App 3', 'App 4', 'Theme', 'Settings', '世界书'];
    for (let i = 0; i < totalApps; i++) {
        const iconDiv = document.getElementById(`icon-${i}`);
        const nameDiv = document.getElementById(`name-${i}`);
        iconDiv.style.backgroundImage = '';
        iconDiv.style.backgroundColor = '#f0f0f0';
        nameDiv.innerText = defaultNames[i];
    }
    renderAppEditors();
    saveAppsData(); 
}
function resetFonts() {
    document.getElementById('dynamic-font-style').textContent = '';
    changeFontSize(11);
    document.getElementById('fontSizeSlider').value = 11;
    document.getElementById('fontUrlInput').value = '';
    saveThemeSettings(); 
}

// --- 网格与拖拽 ---
function initGrid() {
    const grid = document.getElementById('homeGrid');
    if (!grid) return; // 修复：防止 grid 不存在时报错

    for (let i = 8; i < 28; i++) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.dataset.index = i;
        grid.appendChild(cell);
    }
    const appsData = [
        { id: 'app-0', iconId: 'icon-0', nameId: 'name-0', name: 'App 1' },
        { id: 'app-1', iconId: 'icon-1', nameId: 'name-1', name: 'App 2' },
        { id: 'app-2', iconId: 'icon-2', nameId: 'name-2', name: 'App 3' },
        { id: 'app-3', iconId: 'icon-3', nameId: 'name-3', name: 'App 4' }
    ];
    const cells = Array.from(grid.children).slice(1); 
    appsData.forEach((data, index) => {
        if (cells[index]) {
            const appDiv = document.createElement('div');
            appDiv.className = 'app-item';
            appDiv.id = data.id;
            appDiv.innerHTML = `<div class="app-icon" id="${data.iconId}"></div><div class="app-name" id="${data.nameId}">${data.name}</div>`;
            addDragListeners(appDiv);
            
            // 为 App 1 添加点击打开 WeChat 的事件
            if (data.id === 'app-0') {
                appDiv.addEventListener('click', (e) => {
                    if (!isDragging) openWechat();
                });
            }
            
            cells[index].appendChild(appDiv);
        }
    });
}

function addDragListeners(el) {
    el.addEventListener('touchstart', handleDragStart, { passive: false });
    el.addEventListener('touchmove', handleDragMove, { passive: false });
    el.addEventListener('touchend', handleDragEnd);
    el.addEventListener('mousedown', handleDragStart);
}

function handleDragStart(e) {
    if (e.target.closest('.settings-modal')) return;
    const touch = e.touches ? e.touches[0] : e;
    dragStartX = touch.clientX;
    dragStartY = touch.clientY;
    const targetApp = e.currentTarget;

    longPressTimer = setTimeout(() => {
        isDragging = true;
        dragItem = targetApp;
        dragGhost = targetApp.cloneNode(true);
        dragGhost.classList.add('app-ghost');
        document.body.appendChild(dragGhost);
        updateGhostPosition(touch.clientX, touch.clientY);
        targetApp.classList.add('dragging');
        if (navigator.vibrate) navigator.vibrate(50);
    }, 500);
}

function handleDragMove(e) {
    if (!longPressTimer) return;
    const touch = e.touches ? e.touches[0] : e;
    if (!isDragging) {
        const moveX = Math.abs(touch.clientX - dragStartX);
        const moveY = Math.abs(touch.clientY - dragStartY);
        if (moveX > 10 || moveY > 10) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
    } else {
        e.preventDefault();
        updateGhostPosition(touch.clientX, touch.clientY);
    }
}

function handleDragEnd(e) {
    clearTimeout(longPressTimer);
    longPressTimer = null;
    if (isDragging && dragItem) {
        const touch = e.changedTouches ? e.changedTouches[0] : e;
        dragGhost.style.display = 'none';
        const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
        const targetCell = elemBelow ? elemBelow.closest('.grid-cell') : null;
        if (targetCell && !targetCell.classList.contains('widget-item')) {
            const existingApp = targetCell.querySelector('.app-item');
            const originalCell = dragItem.parentElement;
            if (existingApp && existingApp !== dragItem) {
                originalCell.appendChild(existingApp);
                targetCell.appendChild(dragItem);
            } else {
                targetCell.appendChild(dragItem);
            }
        }
        dragItem.classList.remove('dragging');
        if (dragGhost) dragGhost.remove();
        dragGhost = null;
        dragItem = null;
        setTimeout(() => { isDragging = false; }, 50);
    }
    document.removeEventListener('mousemove', handleDragMove);
    document.removeEventListener('mouseup', handleDragEnd);
}

document.addEventListener('mousedown', function(e) {
    if(e.target.closest('.app-item')) {
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);
    }
});

function updateGhostPosition(x, y) {
    if (dragGhost) {
        dragGhost.style.left = (x - 35) + 'px';
        dragGhost.style.top = (y - 35) + 'px';
    }
}

// --- 界面交互 ---
function switchTab(tabName, element) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    element.classList.add('active');
    const titles = { 'wallpaper': '壁纸设置', 'icons': '图标与名称', 'fonts': '字体设置' };
    document.getElementById('headerTitle').innerText = titles[tabName];
}

function openSettings() {
    renderAppEditors();
    document.getElementById('settingsModal').classList.add('open');
}
function closeSettings() { document.getElementById('settingsModal').classList.remove('open'); }
function openIOSSettings() { document.getElementById('iosSettingsModal').classList.add('open'); }
function closeIOSSettings() { document.getElementById('iosSettingsModal').classList.remove('open'); }
function openApiSettings() { document.getElementById('apiSettingsModal').classList.add('open'); }
function closeApiSettings() { document.getElementById('apiSettingsModal').classList.remove('open'); }

// --- 世界书逻辑 ---
function openWorldbook() {
    switchWorldbookView('all'); 
    document.getElementById('worldbookModal').classList.add('open');
}
function closeWorldbook() { document.getElementById('worldbookModal').classList.remove('open'); }

function switchWorldbookView(view) {
    const container = document.getElementById('wbViewContainer');
    const tabAll = document.getElementById('tab-wb-all');
    const tabGroup = document.getElementById('tab-wb-group');
    const title = document.getElementById('wbHeaderTitle');

    if (view === 'all') {
        container.style.transform = 'translateX(0)';
        tabAll.classList.add('active');
        tabGroup.classList.remove('active');
        title.innerText = "所有条目";
        renderWorldbookList();
    } else {
        container.style.transform = 'translateX(-50%)'; 
        tabAll.classList.remove('active');
        tabGroup.classList.add('active');
        title.innerText = "分组视图";
        renderGroupView();
    }
}

function renderWorldbookList() {
    const container = document.getElementById('worldbookList');
    container.innerHTML = '';
    if (worldbookEntries.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">暂无条目，点击右上角添加</div>';
        return;
    }
    const sortedEntries = [...worldbookEntries].sort((a, b) => a.title.localeCompare(b.title));
    sortedEntries.forEach(entry => {
        container.appendChild(createEntryElement(entry));
    });
}

function renderGroupView() {
    const container = document.getElementById('worldbookGroupList');
    container.innerHTML = '';
    if (worldbookGroups.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">暂无分组，请点击下方添加</div>';
        return;
    }
    worldbookGroups.forEach(group => {
        const groupEntries = worldbookEntries.filter(e => e.type === group);
        const groupItem = document.createElement('div');
        groupItem.className = 'wb-group-item';
        const swipeWrapper = document.createElement('div');
        swipeWrapper.className = 'wb-group-swipe-wrapper';
        const swipeBox = document.createElement('div');
        swipeBox.className = 'wb-swipe-box';
        const header = document.createElement('div');
        header.className = 'wb-group-header';
        header.innerHTML = `<span class="wb-group-name">${group}</span><span class="wb-group-count">${groupEntries.length}</span>`;
        header.onclick = () => { groupItem.querySelector('.wb-group-content').classList.toggle('expanded'); };
        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'wb-delete-btn';
        deleteBtn.innerText = '删除';
        deleteBtn.onclick = (e) => { e.stopPropagation(); deleteGroup(group); };
        swipeBox.appendChild(header);
        swipeBox.appendChild(deleteBtn);
        swipeWrapper.appendChild(swipeBox);
        addSwipeLogic(swipeBox);
        const content = document.createElement('div');
        content.className = 'wb-group-content';
        if (groupEntries.length > 0) {
            groupEntries.forEach(entry => { content.appendChild(createEntryElement(entry)); });
        } else {
            content.innerHTML = '<div style="padding:10px 16px; color:#999; font-size:13px;">无条目</div>';
        }
        groupItem.appendChild(swipeWrapper);
        groupItem.appendChild(content);
        container.appendChild(groupItem);
    });
}

function deleteGroup(groupName) {
    if (confirm(`确定要删除分组 "${groupName}" 吗？\n该分组下的所有条目也将被删除！`)) {
        worldbookGroups = worldbookGroups.filter(g => g !== groupName);
        worldbookEntries = worldbookEntries.filter(e => e.type !== groupName);
        saveWorldbookData();
        renderGroupView();
    } else {
        const items = document.querySelectorAll('.wb-swipe-box');
        items.forEach(el => el.style.transform = 'translateX(0)');
    }
}

function createEntryElement(entry) {
    const wrapper = document.createElement('div');
    wrapper.className = 'wb-list-item-wrapper';
    const swipeBox = document.createElement('div');
    swipeBox.className = 'wb-swipe-box';
    const content = document.createElement('div');
    content.className = 'wb-list-item';
    content.onclick = () => openWorldbookEditor(entry.id);
    content.innerHTML = `<div class="wb-item-info"><div class="wb-item-title">${entry.title} <span class="wb-item-type">${entry.type}</span></div><div class="wb-item-desc">${entry.desc}</div></div>`;
    const deleteBtn = document.createElement('div');
    deleteBtn.className = 'wb-delete-btn';
    deleteBtn.innerText = '删除';
    deleteBtn.onclick = (e) => { e.stopPropagation(); deleteWorldbookEntry(entry.id); };
    swipeBox.appendChild(content);
    swipeBox.appendChild(deleteBtn);
    wrapper.appendChild(swipeBox);
    addSwipeLogic(swipeBox);
    return wrapper;
}

function addSwipeLogic(element) {
    let startX, currentX;
    let isSwiping = false;
    element.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; element.style.transition = 'none'; }, {passive: true});
    element.addEventListener('touchmove', (e) => {
        currentX = e.touches[0].clientX;
        let diff = currentX - startX;
        if (diff < 0 && diff > -100) { element.style.transform = `translateX(${diff}px)`; isSwiping = true; }
    }, {passive: true});
    element.addEventListener('touchend', (e) => {
        element.style.transition = 'transform 0.2s ease-out';
        let diff = currentX - startX;
        if (diff < -40) { element.style.transform = `translateX(-80px)`; } else { element.style.transform = `translateX(0)`; }
        isSwiping = false;
    });
}

function filterWorldbook(query) {
    const items = document.querySelectorAll('.wb-list-item-wrapper');
    query = query.toLowerCase();
    items.forEach(item => {
        const title = item.querySelector('.wb-item-title').innerText.toLowerCase();
        const desc = item.querySelector('.wb-item-desc').innerText.toLowerCase();
        if (title.includes(query) || desc.includes(query)) { item.style.display = 'block'; } else { item.style.display = 'none'; }
    });
}

function addNewGroup() {
    openTextEditModal("新建分组", "请输入分组名称", "", (val) => {
        if (val && !worldbookGroups.includes(val)) {
            worldbookGroups.push(val);
            saveWorldbookData(); 
            renderGroupView();
        } else if (worldbookGroups.includes(val)) {
            alert("分组已存在");
        }
    });
}

function openWorldbookEditor(id = null) {
    currentEditingId = id;
    const modal = document.getElementById('worldbookEditorModal');
    const titleElem = document.getElementById('wbEditorTitle');
    const typeSelect = document.getElementById('wbTypeInput');
    typeSelect.innerHTML = '';
    if (worldbookGroups.length === 0) {
        const opt = document.createElement('option');
        opt.value = "Default"; opt.innerText = "默认分组 (请先去添加分组)"; typeSelect.appendChild(opt);
    } else {
        worldbookGroups.forEach(g => { const opt = document.createElement('option'); opt.value = g; opt.innerText = g; typeSelect.appendChild(opt); });
    }
    if (id) {
        const entry = worldbookEntries.find(e => e.id === id);
        titleElem.innerText = "编辑条目";
        document.getElementById('wbTitleInput').value = entry.title;
        typeSelect.value = entry.type;
        document.getElementById('wbKeyInput').value = entry.keys;
        document.getElementById('wbDescInput').value = entry.desc;
    } else {
        titleElem.innerText = "新建条目";
        document.getElementById('wbTitleInput').value = '';
        if (worldbookGroups.length > 0) typeSelect.value = worldbookGroups[0];
        document.getElementById('wbKeyInput').value = '';
        document.getElementById('wbDescInput').value = '';
    }
    modal.classList.add('open');
}

function closeWorldbookEditor() { document.getElementById('worldbookEditorModal').classList.remove('open'); }

function saveWorldbookEntry() {
    const title = document.getElementById('wbTitleInput').value;
    let type = document.getElementById('wbTypeInput').value;
    const keys = document.getElementById('wbKeyInput').value;
    const desc = document.getElementById('wbDescInput').value;
    if (!title) { alert("请输入条目名称"); return; }
    if (worldbookGroups.length === 0) { type = "Default"; worldbookGroups.push("Default"); }
    if (currentEditingId) {
        const index = worldbookEntries.findIndex(e => e.id === currentEditingId);
        if (index !== -1) { worldbookEntries[index] = { id: currentEditingId, title, type, keys, desc }; }
    } else {
        const newId = Date.now();
        worldbookEntries.push({ id: newId, title, type, keys, desc });
    }
    saveWorldbookData(); 
    closeWorldbookEditor();
    if (document.getElementById('tab-wb-all').classList.contains('active')) { renderWorldbookList(); } else { renderGroupView(); }
}

function deleteWorldbookEntry(id) {
    if (confirm("确定要删除这个条目吗？")) {
        worldbookEntries = worldbookEntries.filter(e => e.id !== id);
        saveWorldbookData(); 
        if (document.getElementById('tab-wb-all').classList.contains('active')) { renderWorldbookList(); } else { renderGroupView(); }
    } else {
        const items = document.querySelectorAll('.wb-swipe-box');
        items.forEach(el => el.style.transform = 'translateX(0)');
    }
}

// --- API 设置逻辑 ---
async function saveApiConfig() {
    const config = {
        baseUrl: document.getElementById('apiBaseUrl').value,
        key: document.getElementById('apiKey').value,
        temp: document.getElementById('tempSlider').value,
        model: document.getElementById('modelSelect').value
    };
    await idb.set('ios_theme_api_config', config);
    alert("API 配置已保存");
}

async function fetchModels() {
    const baseUrl = document.getElementById('apiBaseUrl').value;
    const key = document.getElementById('apiKey').value;
    if (!baseUrl || !key) return alert("请先填写 API 地址和密钥");
    const btn = document.getElementById('fetchBtn');
    btn.innerText = "拉取中...";
    try {
        const res = await fetch(`${baseUrl}/models`, { headers: { 'Authorization': `Bearer ${key}` } });
        const data = await res.json();
        const select = document.getElementById('modelSelect');
        select.innerHTML = '';
        if (data.data && Array.isArray(data.data)) {
            data.data.forEach(m => { const opt = document.createElement('option'); opt.value = m.id; opt.innerText = m.id; select.appendChild(opt); });
            alert(`成功拉取 ${data.data.length} 个模型`);
        } else { alert("拉取失败：格式不正确"); }
    } catch (e) { alert("拉取失败：" + e.message); } finally { btn.innerText = "拉取模型列表"; }
}

function renderApiPresets() {
    const list = document.getElementById('apiPresetList');
    list.innerHTML = '';
    if (apiPresets.length === 0) { list.innerHTML = '<div style="color:#999; font-size:13px; padding:5px;">暂无预设</div>'; return; }
    apiPresets.forEach((p, idx) => {
        const tag = document.createElement('div');
        tag.className = 'preset-tag';
        tag.innerHTML = `<span class="preset-name" onclick="applyApiPreset(${idx})">${p.name}</span><span class="preset-delete" onclick="deletePreset('api', ${idx})">×</span>`;
        list.appendChild(tag);
    });
}

function applyApiPreset(idx) {
    const p = apiPresets[idx];
    if (p) {
        document.getElementById('apiBaseUrl').value = p.baseUrl;
        document.getElementById('apiKey').value = p.key;
        document.getElementById('tempSlider').value = p.temp;
        document.getElementById('tempDisplay').innerText = p.temp;
    }
}

// --- 通用模态框逻辑 ---
function openNameModal(type) {
    pendingSaveType = type;
    document.getElementById('modalTitle').innerText = "保存预设";
    document.getElementById('modalDesc').innerText = "请输入预设名称";
    document.getElementById('modalInputContainer').classList.add('show');
    document.getElementById('modalInput').value = '';
    document.getElementById('modalConfirmBtn').onclick = confirmSavePreset;
    document.getElementById('modalOverlay').classList.add('active');
}

function openTextEditModal(title, desc, initialValue, callback) {
    document.getElementById('modalTitle').innerText = title;
    document.getElementById('modalDesc').innerText = desc;
    document.getElementById('modalInputContainer').classList.add('show');
    document.getElementById('modalInput').value = initialValue || '';
    document.getElementById('modalConfirmBtn').onclick = () => { callback(document.getElementById('modalInput').value); closeModal(); };
    document.getElementById('modalOverlay').classList.add('active');
}

function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

async function confirmSavePreset() {
    const name = document.getElementById('modalInput').value;
    if (!name) return alert("请输入名称");
    if (pendingSaveType === 'icon') {
        const currentIcons = [];
        for(let i=0; i<totalApps; i++) {
            currentIcons.push({ id: i, name: document.getElementById(`name-${i}`).innerText, bg: document.getElementById(`icon-${i}`).style.backgroundImage });
        }
        iconPresets.push({ name, data: currentIcons });
        renderIconPresets();
    } else if (pendingSaveType === 'font') {
        fontPresets.push({ name, url: document.getElementById('fontUrlInput').value, size: document.getElementById('fontSizeSlider').value });
        renderFontPresets();
    } else if (pendingSaveType === 'api') {
        apiPresets.push({ name, baseUrl: document.getElementById('apiBaseUrl').value, key: document.getElementById('apiKey').value, temp: document.getElementById('tempSlider').value });
        renderApiPresets();
    }
    await savePresetsData();
    closeModal();
}

function deletePreset(type, idx) {
    if (!confirm("确定删除此预设吗？")) return;
    if (type === 'icon') { iconPresets.splice(idx, 1); renderIconPresets(); }
    else if (type === 'font') { fontPresets.splice(idx, 1); renderFontPresets(); }
    else if (type === 'api') { apiPresets.splice(idx, 1); renderApiPresets(); }
    savePresetsData();
}

function renderIconPresets() {
    const list = document.getElementById('iconPresetList');
    list.innerHTML = '';
    if (iconPresets.length === 0) { list.innerHTML = '<div style="color:#999; font-size:13px; padding:5px;">暂无预设</div>'; return; }
    iconPresets.forEach((p, idx) => {
        const tag = document.createElement('div');
        tag.className = 'preset-tag';
        tag.innerHTML = `<span class="preset-name" onclick="applyIconPreset(${idx})">${p.name}</span><span class="preset-delete" onclick="deletePreset('icon', ${idx})">×</span>`;
        list.appendChild(tag);
    });
}

function renderFontPresets() {
    const list = document.getElementById('fontPresetList');
    list.innerHTML = '';
    fontPresets.forEach((p, idx) => {
        const tag = document.createElement('div');
        tag.className = 'preset-tag';
        tag.innerHTML = `<span class="preset-name" onclick="applyFontPreset(${idx})">${p.name}</span><span class="preset-delete" onclick="deletePreset('font', ${idx})">×</span>`;
        list.appendChild(tag);
    });
    document.getElementById('fontPresetsContainer').style.display = fontPresets.length ? 'block' : 'none';
}

function applyIconPreset(idx) {
    const p = iconPresets[idx];
    if (p && p.data) {
        p.data.forEach(app => {
            const iconEl = document.getElementById(`icon-${app.id}`);
            const nameEl = document.getElementById(`name-${app.id}`);
            if (iconEl) iconEl.style.backgroundImage = app.bg;
            if (nameEl) nameEl.innerText = app.name;
        });
        renderAppEditors();
        saveAppsData();
    }
}

function applyFontPreset(idx) {
    const p = fontPresets[idx];
    if (p) {
        document.getElementById('fontUrlInput').value = p.url;
        document.getElementById('fontSizeSlider').value = p.size;
        changeFontSize(p.size);
        applyFont(p.url);
        saveThemeSettings();
    }
}

function renderAppEditors() {
    const container = document.getElementById('appEditorList');
    container.innerHTML = '';
    for (let i = 0; i < totalApps; i++) {
        const name = document.getElementById(`name-${i}`).innerText;
        const bg = document.getElementById(`icon-${i}`).style.backgroundImage;
        const div = document.createElement('div');
        div.className = 'app-edit-item';
        div.innerHTML = `
            <div class="app-edit-preview" id="edit-preview-${i}" onclick="document.getElementById('file-${i}').click()" style="background-image:${bg}">
                <svg class="camera-icon" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            </div>
            <div class="app-edit-inputs">
                <input type="text" value="${name}" oninput="updateAppName(${i}, this.value)" placeholder="App Name">
                <input type="file" id="file-${i}" class="hidden-file-input" accept="image/*" onchange="handleAppIconUpload(${i}, this)">
                <button class="action-btn secondary" style="padding:6px; font-size:12px;" onclick="resetSingleApp(${i})">重置</button>
            </div>
        `;
        container.appendChild(div);
    }
}

function updateAppName(id, val) { document.getElementById(`name-${id}`).innerText = val; saveAppsData(); }

function handleAppIconUpload(id, input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const bg = `url('${e.target.result}')`;
            document.getElementById(`icon-${id}`).style.backgroundImage = bg;
            document.getElementById(`icon-${id}`).style.backgroundColor = 'transparent';
            document.getElementById(`edit-preview-${id}`).style.backgroundImage = bg;
            saveAppsData();
        };
        reader.readAsDataURL(file);
    }
}

function resetSingleApp(id) {
    const defaultNames = ['App 1', 'App 2', 'App 3', 'App 4', 'Theme', 'Settings', '世界书'];
    document.getElementById(`name-${id}`).innerText = defaultNames[id] || `App ${id+1}`;
    document.getElementById(`icon-${id}`).style.backgroundImage = '';
    document.getElementById(`icon-${id}`).style.backgroundColor = '#f0f0f0';
    renderAppEditors();
    saveAppsData();
}

function changeFontSize(val) {
    document.documentElement.style.setProperty('--app-font-size', val + 'px');
    document.getElementById('fontSizeDisplay').innerText = val + 'px';
    saveThemeSettings();
}

function applyFont(url) {
    const finalUrl = url || document.getElementById('fontUrlInput').value;
    if (finalUrl) {
        const style = document.getElementById('dynamic-font-style');
        style.textContent = `@font-face { font-family: 'CustomFont'; src: url('${finalUrl}'); } body { font-family: 'CustomFont', -apple-system, sans-serif; }`;
        saveThemeSettings();
    }
}

function setWallpaperFromUrl() {
    const url = document.getElementById('bgUrlInput').value;
    if (url) {
        document.getElementById('mainScreen').style.backgroundImage = `url('${url}')`;
        saveThemeSettings();
        addWallpaperToGrid(url);
    }
}

function addWallpaperToGrid(url) {
    if (!wallpaperPresets.includes(url)) {
        wallpaperPresets.push(url);
        savePresetsData();
        renderWallpaperGrid();
    }
}

function renderWallpaperGrid() {
    const grid = document.getElementById('wallpaperGrid');
    grid.innerHTML = '';
    if (wallpaperPresets.length === 0) { grid.innerHTML = '<div style="color:#999; font-size:13px; grid-column:span 3; text-align:center; padding:20px;">暂无保存的壁纸</div>'; return; }
    wallpaperPresets.forEach((url, idx) => {
        const item = document.createElement('div');
        item.className = 'wallpaper-item';
        item.style.backgroundImage = `url('${url}')`;
        item.onclick = () => { document.getElementById('mainScreen').style.backgroundImage = `url('${url}')`; saveThemeSettings(); };
        const del = document.createElement('div');
        del.className = 'wallpaper-delete';
        del.innerText = '×';
        del.onclick = (e) => { e.stopPropagation(); wallpaperPresets.splice(idx, 1); savePresetsData(); renderWallpaperGrid(); };
        item.appendChild(del);
        grid.appendChild(item);
    });
}

/* ==========================================================================
   WECHAT APP LOGIC (Prefix: wc)
   ========================================================================== */

// --- WeChat DB ---
const WC_DB_NAME = 'WeChatSimDB';
const WC_DB_VERSION = 1;

const wcDb = {
    instance: null,
    init: function() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(WC_DB_NAME, WC_DB_VERSION);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('kv_store')) db.createObjectStore('kv_store');
                if (!db.objectStoreNames.contains('characters')) db.createObjectStore('characters', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('chats')) db.createObjectStore('chats', { keyPath: 'charId' });
                if (!db.objectStoreNames.contains('moments')) db.createObjectStore('moments', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('masks')) db.createObjectStore('masks', { keyPath: 'id' });
            };
            request.onsuccess = (event) => {
                this.instance = event.target.result;
                resolve();
            };
            request.onerror = (event) => reject(event.target.error);
        });
    },
    get: function(storeName, key) {
        return new Promise((resolve, reject) => {
            const transaction = this.instance.transaction([storeName], 'readonly');
            const request = transaction.objectStore(storeName).get(key);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    },
    getAll: function(storeName) {
        return new Promise((resolve, reject) => {
            const transaction = this.instance.transaction([storeName], 'readonly');
            const request = transaction.objectStore(storeName).getAll();
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    },
    put: function(storeName, value, key) {
        return new Promise((resolve, reject) => {
            const transaction = this.instance.transaction([storeName], 'readwrite');
            const request = key ? transaction.objectStore(storeName).put(value, key) : transaction.objectStore(storeName).put(value);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    },
    delete: function(storeName, key) {
        return new Promise((resolve, reject) => {
            const transaction = this.instance.transaction([storeName], 'readwrite');
            const request = transaction.objectStore(storeName).delete(key);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    },
    // 新增：批量获取
    async getAllAsync(storeName) {
        return new Promise((resolve, reject) => {
            const transaction = this.instance.transaction([storeName], 'readonly');
            const request = transaction.objectStore(storeName).getAll();
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }
};

// --- WeChat State ---
const wcState = {
    currentTab: 'chat',
    characters: [],
    chats: {}, 
    moments: [],
    user: { name: 'User', avatar: '', cover: '', persona: '' },
    wallet: { balance: 0.00, transactions: [], password: '123456' },
    masks: [], 
    stickerCategories: [{ name: "全部", list: [] }],
    cssPresets: [],
    activeStickerCategoryIndex: 0,
    tempImage: '',
    tempImageType: '',
    editingCharId: null,
    editingMaskId: null,
    momentType: 'local',
    activeChatId: null,
    isStickerPanelOpen: false,
    isMorePanelOpen: false,
    isStickerDeleteMode: false,
    isMultiSelectMode: false,
    longPressTimer: null,
    selectedMsgId: null,
    replyingToMsgId: null,
    multiSelectedIds: [],
    tempTransfer: { amount: 0, note: '' },
    activeTransferMsgId: null,
    phoneClockInterval: null,
    tempPhoneConfig: {},
    phoneAppTab: 'chat',
    generalInputCallback: null,
    tempBgCleared: false,
    replyingToComment: null // { momentId, commentIndex, name }
};

// --- WeChat Core Functions ---
function openWechat() {
    document.getElementById('wechatModal').classList.add('open');
    wcRenderAll();
}

function closeWechat() {
    document.getElementById('wechatModal').classList.remove('open');
}

async function wcLoadData() {
    try {
        const user = await wcDb.get('kv_store', 'user');
        if (user) wcState.user = user;
        else wcState.user.avatar = 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg' + ' width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="#007AFF"/></svg>');

        const wallet = await wcDb.get('kv_store', 'wallet');
        if (wallet) wcState.wallet = wallet;

        const stickers = await wcDb.get('kv_store', 'sticker_categories');
        if (stickers) wcState.stickerCategories = stickers;

        const presets = await wcDb.get('kv_store', 'css_presets');
        if (presets) wcState.cssPresets = presets;

        const chars = await wcDb.getAll('characters');
        wcState.characters = chars || [];
        
        wcState.masks = await wcDb.getAll('masks') || [];
        wcState.moments = await wcDb.getAll('moments') || [];
        
        const allChats = await wcDb.getAll('chats');
        if (allChats) {
            allChats.forEach(item => {
                wcState.chats[item.charId] = item.messages;
            });
        }
    } catch (e) {
        console.error("WeChat Data load error", e);
    }
}

async function wcSaveData() {
    try {
        await wcDb.put('kv_store', wcState.user, 'user');
        await wcDb.put('kv_store', wcState.wallet, 'wallet');
        await wcDb.put('kv_store', wcState.stickerCategories, 'sticker_categories');
        await wcDb.put('kv_store', wcState.cssPresets, 'css_presets');
        
        for (const char of wcState.characters) {
            if (char && char.id) await wcDb.put('characters', char);
        }
        for (const mask of wcState.masks) await wcDb.put('masks', mask);
        for (const moment of wcState.moments) await wcDb.put('moments', moment);
        for (const charId in wcState.chats) {
            await wcDb.put('chats', { charId: parseInt(charId), messages: wcState.chats[charId] });
        }
    } catch (e) {
        console.error("WeChat Save failed", e);
    }
}

function wcCompressImage(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 600; 
                const scaleSize = MAX_WIDTH / img.width;
                if (scaleSize < 1) {
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                } else {
                    canvas.width = img.width;
                    canvas.height = img.height;
                }
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                resolve(canvas.toDataURL('image/jpeg', 0.6));
            };
            img.onerror = (err) => reject(err);
        };
        reader.onerror = (err) => reject(err);
    });
}

// --- WeChat Navigation ---
function wcSwitchTab(tabId) {
    wcState.currentTab = tabId;
    document.querySelectorAll('.wc-tab-item').forEach(el => el.classList.remove('active'));
    document.querySelector(`.wc-tab-item[onclick="wcSwitchTab('${tabId}')"]`).classList.add('active');
    document.querySelectorAll('.wc-page').forEach(el => el.classList.remove('active'));
    document.getElementById(`wc-view-${tabId}`).classList.add('active');
    
    document.getElementById('wc-view-chat-detail').classList.remove('active');
    document.getElementById('wc-view-memory').classList.remove('active');
    document.getElementById('wc-main-tabbar').style.display = 'flex';
    document.getElementById('wc-btn-back').style.display = 'none';
    document.getElementById('wc-btn-exit').style.display = 'flex';

    const titleMap = { 'chat': 'Chat', 'contacts': 'Contacts', 'moments': 'Moments', 'user': 'User' };
    document.getElementById('wc-nav-title').innerText = titleMap[tabId];

    const rightContainer = document.getElementById('wc-nav-right-container');
    rightContainer.innerHTML = '';

    if (tabId === 'chat') {
        const btn = document.createElement('button');
        btn.className = 'wc-nav-btn';
        btn.innerHTML = '<svg class="wc-icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
        btn.onclick = () => wcOpenModal('wc-modal-add-char');
        rightContainer.appendChild(btn);
    } else if (tabId === 'moments') {
        const btn = document.createElement('button');
        btn.className = 'wc-nav-btn';
        btn.innerHTML = '<svg class="wc-icon" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>';
        btn.onclick = () => wcOpenModal('wc-modal-post-moment');
        rightContainer.appendChild(btn);
    }
}

function wcHandleBack() {
    if (document.getElementById('wc-view-memory').classList.contains('active')) {
        wcCloseMemoryPage();
        return;
    }
    if (document.getElementById('wc-view-chat-detail').classList.contains('active')) {
        document.getElementById('wc-view-chat-detail').classList.remove('active');
        document.getElementById('wc-main-tabbar').style.display = 'flex';
        document.getElementById('wc-btn-back').style.display = 'none';
        document.getElementById('wc-btn-exit').style.display = 'flex';
        document.getElementById('wc-nav-title').innerText = 'Chat';
        
        const rightContainer = document.getElementById('wc-nav-right-container');
        rightContainer.innerHTML = '';
        const btn = document.createElement('button');
        btn.className = 'wc-nav-btn';
        btn.innerHTML = '<svg class="wc-icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
        btn.onclick = () => wcOpenModal('wc-modal-add-char');
        rightContainer.appendChild(btn);

        wcState.activeChatId = null;
        wcCloseAllPanels();
        wcExitMultiSelectMode();
        
        document.getElementById('wc-chat-background-layer').style.backgroundImage = 'none';
        document.getElementById('wc-custom-css-style').innerHTML = '';
        
        wcRenderChats(); 
    }
}

// --- WeChat Chat Logic ---
function wcOpenChat(charId) {
    wcState.activeChatId = charId;
    const char = wcState.characters.find(c => c.id === charId);
    if (!char) return;

    document.getElementById('wc-view-chat-detail').classList.add('active');
    document.getElementById('wc-main-tabbar').style.display = 'none';
    document.getElementById('wc-btn-back').style.display = 'flex';
    document.getElementById('wc-btn-exit').style.display = 'none';
    
    document.getElementById('wc-nav-title').innerText = char.note || char.name;
    
    const rightContainer = document.getElementById('wc-nav-right-container');
    rightContainer.innerHTML = '';
    const btn = document.createElement('button');
    btn.className = 'wc-nav-btn';
    btn.innerHTML = '<svg class="wc-icon" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>';
    btn.onclick = () => wcOpenChatSettings();
    rightContainer.appendChild(btn);

    wcApplyChatConfig(char);
    wcRenderMessages(charId);
    wcScrollToBottom();
}

function wcApplyChatConfig(char) {
    if (!char) return; // 安全检查
    const bgLayer = document.getElementById('wc-chat-background-layer');
    if (char.chatConfig && char.chatConfig.backgroundImage) {
        bgLayer.style.backgroundImage = `url(${char.chatConfig.backgroundImage})`;
    } else {
        bgLayer.style.backgroundImage = 'none';
    }

    const cssStyle = document.getElementById('wc-custom-css-style');
    if (char.chatConfig && char.chatConfig.customCss) {
        cssStyle.innerHTML = char.chatConfig.customCss;
    } else {
        cssStyle.innerHTML = '';
    }
}

function wcFormatTime(timestamp) {
    const date = new Date(timestamp);
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
}

function wcRenderMessages(charId) {
    const container = document.getElementById('wc-chat-messages');
    container.innerHTML = '';
    const msgs = wcState.chats[charId] || [];
    const char = wcState.characters.find(c => c.id === charId);
    
    if (!char) return; // 安全检查

    let userAvatar = wcState.user.avatar;
    if (char.chatConfig && char.chatConfig.userAvatar) {
        userAvatar = char.chatConfig.userAvatar;
    }

    if (wcState.isMultiSelectMode) {
        container.classList.add('multi-select-mode');
    } else {
        container.classList.remove('multi-select-mode');
    }

    let lastTime = 0;

    msgs.forEach((msg) => {
        // 隐形系统消息逻辑：如果消息被标记为 hidden，则不渲染
        if (msg.hidden) return;

        if (msg.time - lastTime > 5 * 60 * 1000) {
            const timeDiv = document.createElement('div');
            timeDiv.className = 'wc-message-row system';
            timeDiv.innerHTML = `<div class="wc-system-msg-text transparent">${wcFormatTime(msg.time)}</div>`;
            container.appendChild(timeDiv);
            lastTime = msg.time;
        }

        const row = document.createElement('div');
        
        if (msg.type === 'system') {
            row.className = 'wc-message-row system';
            row.innerHTML = `<div class="wc-system-msg-text ${msg.style || ''}">${msg.content}</div>`;
            container.appendChild(row);
            return;
        }

        row.className = `wc-message-row ${msg.sender === 'me' ? 'me' : 'them'}`;
        const avatarUrl = msg.sender === 'me' ? userAvatar : char.avatar;
        
        let quoteHtml = '';
        if (msg.quote) {
            quoteHtml = `<div class="wc-quote-block">${msg.quote}</div>`;
        }

        let contentHtml = '';
        if (msg.type === 'sticker') {
            contentHtml = `<div class="wc-bubble wc-bubble-sticker ${msg.sender === 'me' ? 'me' : 'them'}">${quoteHtml}<img src="${msg.content}" class="wc-sticker-img"></div>`;
        } else if (msg.type === 'image') {
            contentHtml = `<div class="wc-bubble wc-bubble-sticker ${msg.sender === 'me' ? 'me' : 'them'}">${quoteHtml}<img src="${msg.content}" class="wc-bubble-img"></div>`;
        } else if (msg.type === 'voice') {
            if (msg.showText) {
                contentHtml = `<div class="wc-bubble ${msg.sender === 'me' ? 'me' : 'them'}" onclick="wcToggleVoiceText(${msg.id})">${quoteHtml}[语音转文字] ${msg.content}</div>`;
            } else {
                contentHtml = `
                    <div class="wc-bubble voice ${msg.sender === 'me' ? 'me' : 'them'}" onclick="wcToggleVoiceText(${msg.id})">
                        ${quoteHtml}
                        <div class="wc-voice-bars">
                            <div class="wc-voice-bar"></div><div class="wc-voice-bar"></div><div class="wc-voice-bar"></div>
                        </div>
                    </div>`;
            }
        } else if (msg.type === 'transfer') {
            const statusClass = (msg.status === 'received' || msg.status === 'rejected') ? 'received' : '';
            const statusText = msg.status === 'received' ? '已收款' : (msg.status === 'rejected' ? '已退还' : '转账');
            const icon = msg.status === 'received' ? '<polyline points="20 6 9 17 4 12"></polyline>' : '<rect x="2" y="6" width="20" height="12" rx="2"></rect><circle cx="12" cy="12" r="2"></circle><path d="M6 12h.01M18 12h.01"></path>';
            
            contentHtml = `
                <div class="wc-bubble transfer ${statusClass}" onclick="wcHandleTransferClick(${msg.id})">
                    ${quoteHtml}
                    <div class="wc-transfer-content">
                        <div class="wc-transfer-icon-circle">
                            <svg class="wc-icon" viewBox="0 0 24 24">${icon}</svg>
                        </div>
                        <div class="wc-transfer-info">
                            <span class="wc-transfer-amount">¥${msg.amount}</span>
                            <span class="wc-transfer-desc">${statusText}</span>
                        </div>
                    </div>
                </div>`;
        } else {
            contentHtml = `<div class="wc-bubble ${msg.sender === 'me' ? 'me' : 'them'}">${quoteHtml}${msg.content}</div>`;
        }

        const checkboxHtml = `<div class="wc-msg-checkbox ${wcState.multiSelectedIds.includes(msg.id) ? 'checked' : ''}" onclick="wcToggleMultiSelectMsg(${msg.id})"></div>`;
        const timeHtml = `<span class="wc-msg-timestamp-outside">${wcFormatTime(msg.time)}</span>`;

        const bubbleWrapper = document.createElement('div');
        bubbleWrapper.className = 'wc-bubble-container';
        bubbleWrapper.innerHTML = contentHtml;
        
        bubbleWrapper.addEventListener('touchstart', (e) => wcHandleTouchStart(e, msg.id));
        bubbleWrapper.addEventListener('touchend', wcHandleTouchEnd);
        bubbleWrapper.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            wcShowContextMenu(e.clientX, e.clientY, msg.id);
        });

        if (msg.sender === 'me') {
            row.innerHTML = `${checkboxHtml}<img src="${avatarUrl}" class="wc-chat-avatar">`;
            row.appendChild(bubbleWrapper);
            row.insertAdjacentHTML('beforeend', timeHtml);
        } else {
            row.innerHTML = `${checkboxHtml}<img src="${avatarUrl}" class="wc-chat-avatar">`;
            row.appendChild(bubbleWrapper);
            row.insertAdjacentHTML('beforeend', timeHtml);
        }

        container.appendChild(row);
    });
}

function wcScrollToBottom() {
    const area = document.getElementById('wc-chat-messages');
    setTimeout(() => { area.scrollTop = area.scrollHeight; }, 50);
}

// --- WeChat Interaction ---
function wcHandleTouchStart(e, msgId) {
    wcState.longPressTimer = setTimeout(() => {
        const touch = e.touches[0];
        wcShowContextMenu(touch.clientX, touch.clientY, msgId);
    }, 500);
}

function wcHandleTouchEnd() {
    if (wcState.longPressTimer) {
        clearTimeout(wcState.longPressTimer);
        wcState.longPressTimer = null;
    }
}

function wcShowContextMenu(x, y, msgId) {
    wcState.selectedMsgId = msgId;
    const menu = document.getElementById('wc-context-menu');
    const menuWidth = 150;
    const menuHeight = 180;
    const screenW = window.innerWidth;
    const screenH = window.innerHeight;

    if (x + menuWidth > screenW) x = screenW - menuWidth - 10;
    if (y + menuHeight > screenH) y = screenH - menuHeight - 10;

    menu.style.left = x + 'px';
    menu.style.top = y + 'px';
    menu.style.display = 'flex';
}

function wcHideContextMenu() {
    document.getElementById('wc-context-menu').style.display = 'none';
    wcState.selectedMsgId = null;
}

function wcHandleReply() {
    const msgs = wcState.chats[wcState.activeChatId];
    const msg = msgs.find(m => m.id === wcState.selectedMsgId);
    if (msg) {
        wcState.replyingToMsgId = msg.id;
        let text = msg.content;
        if (msg.type !== 'text') text = `[${msg.type}]`;
        document.getElementById('wc-quote-text-content').innerText = text;
        document.getElementById('wc-quote-preview-area').style.display = 'flex';
        document.getElementById('wc-chat-input').focus();
    }
    wcHideContextMenu();
}

function wcCancelQuote() {
    wcState.replyingToMsgId = null;
    document.getElementById('wc-quote-preview-area').style.display = 'none';
}

function wcHandleEdit() {
    const msgs = wcState.chats[wcState.activeChatId];
    const msg = msgs.find(m => m.id === wcState.selectedMsgId);
    if (msg) {
        const newText = prompt("编辑消息内容:", msg.content);
        if (newText !== null && newText.trim() !== "") {
            msg.content = newText;
            wcSaveData();
            wcRenderMessages(wcState.activeChatId);
        }
    }
    wcHideContextMenu();
}

function wcHandleDelete() {
    if (confirm("确定删除这条消息吗？")) {
        wcState.chats[wcState.activeChatId] = wcState.chats[wcState.activeChatId].filter(m => m.id !== wcState.selectedMsgId);
        wcSaveData();
        wcRenderMessages(wcState.activeChatId);
    }
    wcHideContextMenu();
}

function wcHandleMultiSelect() {
    wcState.isMultiSelectMode = true;
    wcState.multiSelectedIds = [wcState.selectedMsgId];
    wcHideContextMenu();
    wcRenderMessages(wcState.activeChatId);
    document.getElementById('wc-multi-select-footer').style.display = 'flex';
    document.getElementById('wc-chat-footer').style.display = 'none';
}

function wcToggleMultiSelectMsg(msgId) {
    if (wcState.multiSelectedIds.includes(msgId)) {
        wcState.multiSelectedIds = wcState.multiSelectedIds.filter(id => id !== msgId);
    } else {
        wcState.multiSelectedIds.push(msgId);
    }
    wcRenderMessages(wcState.activeChatId);
}

function wcHandleMultiDeleteAction() {
    if (wcState.multiSelectedIds.length === 0) return;
    if (confirm(`确定删除选中的 ${wcState.multiSelectedIds.length} 条消息吗？`)) {
        wcState.chats[wcState.activeChatId] = wcState.chats[wcState.activeChatId].filter(m => !wcState.multiSelectedIds.includes(m.id));
        wcSaveData();
        wcExitMultiSelectMode();
    }
}

function wcExitMultiSelectMode() {
    wcState.isMultiSelectMode = false;
    wcState.multiSelectedIds = [];
    document.getElementById('wc-multi-select-footer').style.display = 'none';
    document.getElementById('wc-chat-footer').style.display = 'flex';
    wcRenderMessages(wcState.activeChatId);
}

function wcHandleEnter(e) {
    if (e.key === 'Enter') {
        if (!e.shiftKey) {
            e.preventDefault();
            wcSendMsg();
        }
    }
}

function wcSendMsg() {
    const input = document.getElementById('wc-chat-input');
    const text = input.value.trim();
    if (!text) return;

    let extra = {};
    if (wcState.replyingToMsgId) {
        const msgs = wcState.chats[wcState.activeChatId];
        const replyMsg = msgs.find(m => m.id === wcState.replyingToMsgId);
        if (replyMsg) {
            let replyText = replyMsg.content;
            if (replyMsg.type !== 'text') replyText = `[${replyMsg.type}]`;
            extra.quote = `${replyMsg.sender === 'me' ? wcState.user.name : wcState.characters.find(c=>c.id===wcState.activeChatId).name}: ${replyText}`;
        }
        wcCancelQuote();
    }

    wcAddMessage(wcState.activeChatId, 'me', 'text', text, extra);
    input.value = '';
}

// --- WeChat AI & API Logic ---
async function wcTriggerAI() {
    const charId = wcState.activeChatId;
    const char = wcState.characters.find(c => c.id === charId);
    if (!char) return;

    const apiConfig = await idb.get('ios_theme_api_config');
    if (!apiConfig || !apiConfig.baseUrl || !apiConfig.key || !apiConfig.model) {
        alert("请先在系统设置中配置 API 地址、密钥并选择模型！");
        return;
    }

    const titleEl = document.getElementById('wc-nav-title');
    const originalTitle = titleEl.innerText;
    titleEl.innerText = "对方正在输入...";

    try {
        const config = char.chatConfig || {};
        
        // 获取当前系统时间
        const now = new Date();
        const timeString = now.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', hour12: false });
        const dayString = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'][now.getDay()];
        const currentTimeInfo = `【当前系统时间】\n现实时间：${timeString} ${dayString}\n\n`;

        // 1. 构建系统提示词 (System Prompt)
        let systemPrompt = `你正在参与一个沉浸式的微信聊天模拟。严格扮演你的角色，不要破坏沉浸感。\n`;
        systemPrompt += currentTimeInfo;
        
        systemPrompt += `【时间感知模块（Time Awareness Protocol）】
1. 你不能自行假设时间流逝。任何“经过了多久”的判断，必须依据现实时间或由我明确告知的时间信息。
2. 每次回复前，请读取“当前系统时间”，并基于此判断间隔。
3. 如果我未提供新的时间信息，请保持默认状态，不可生成“已过1小时”“天亮了”等推测性内容。
4. 在回复中涉及时间时，请体现逻辑一致性。
5. 允许我在任何时刻通过提示语更新时间，你需即时根据最新时间修正自己的表述。
6. 若我使用「现在」一词，请视为现实当前时间（即系统当前时间），不要提前或延迟。
7. 你可以记录上次对话中的时间节点，并在下次对话时主动比对。如果我没有更新时间，也不要自行虚构时间变化。

【时间行为逻辑】
你具有准确的时间意识。不会凭空判断时间流逝，而是基于现实时间或对方提供的时间数据进行逻辑判断。
在每次互动时，根据时间差计算具体分钟数，并用自然的语气表现出“确实过了多久”。\n\n`;

        systemPrompt += `【重要回复规则】
1. 必须模拟即时通讯软件聊天风格，口语化、碎片化。
2. 严禁长篇大论，严禁小说体。
3. 频繁使用换行符，每一句对话独占一行。
4. 将长段话拆分成多条短消息发送（用换行分隔）。
5. 不要使用书面语，像用手机打字一样。
6. 严禁使用逗号将多个独立的句子强行连接成一句长句。\n\n`;

        systemPrompt += `【你的角色设定】\n名字：${char.name}\n人设：${char.prompt || '无'}\n\n`;
        systemPrompt += `【对方(用户)设定】\n名字：${config.userName || wcState.user.name}\n人设：${config.userPersona || '无'}\n\n`;

        // 2. 注入世界书 (多选支持)
        if (config.worldbookEntries && config.worldbookEntries.length > 0) {
            const selectedEntries = worldbookEntries.filter(e => config.worldbookEntries.includes(e.id.toString()));
            if (selectedEntries.length > 0) {
                systemPrompt += `【世界观/背景设定】\n`;
                selectedEntries.forEach(e => { systemPrompt += `- ${e.title} (${e.keys}): ${e.desc}\n`; });
                systemPrompt += `\n`;
            }
        }

        // 3. 注入记忆 (读取条数限制)
        if (char.memories && char.memories.length > 0) {
            const readCount = config.aiMemoryCount || 5;
            const recentMemories = char.memories.slice(0, readCount);
            systemPrompt += `【关于聊天的记忆/总结】\n`;
            recentMemories.forEach(m => { systemPrompt += `- ${m.content}\n`; });
            systemPrompt += `\n`;
        }

        // 4. 注入表情包能力 (多选支持)
        let availableStickers = [];
        if (config.stickerGroupIds && config.stickerGroupIds.length > 0) {
            config.stickerGroupIds.forEach(groupId => {
                const group = wcState.stickerCategories[groupId];
                if (group && group.list) {
                    group.list.forEach(s => availableStickers.push(s.desc));
                }
            });
        }
        
        if (availableStickers.length > 0) {
            // 限制表情包描述数量，防止 Token 溢出
            const limitedStickers = availableStickers.slice(0, 50); 
            systemPrompt += `【可用表情包】\n你可以发送表情包，当前可用的表情包描述有：${limitedStickers.join(', ')}。\n`;
        }

        // 5. 注入朋友圈上下文 (AI Moments) - 增强版
        const recentMoments = wcState.moments.slice(0, 5); 
        if (recentMoments.length > 0) {
            systemPrompt += `【朋友圈动态 (Moments) - 这是一个社交网络环境】\n`;
            systemPrompt += `你可以看到用户(User)和其他人发布的朋友圈。如果用户发了新内容，你可以点赞或评论。\n`;
            recentMoments.forEach(m => {
                // 格式化评论列表
                const commentsStr = m.comments ? m.comments.map(c => `${c.name}: ${c.text}`).join(' | ') : '无';
                const likesStr = m.likes ? m.likes.join(', ') : '无';
                
                systemPrompt += `[ID:${m.id}] 发帖人:${m.name} | 内容:${m.text} | 图片:${m.imageDesc || '无'} | 点赞:${likesStr} | 评论:[${commentsStr}]\n`;
            });
            systemPrompt += `\n`;
        }

        // 6. 注入动作指令说明 (包括朋友圈)
        systemPrompt += `【特殊动作指令】
除了发送普通文本，你可以使用以下标签触发特殊动作（必须严格按格式输出，不要加多余的空格）：
1. 发送语音：[语音]你想说的话[/语音]
2. 发送转账：[转账:金额:备注] (例如 [转账:50.50:请你喝奶茶])
3. 收取用户的转账：[收款] (当用户刚刚给你发了转账时，你可以输出这个标签来收款)
4. 退还用户的转账：[退款] (拒绝用户的转账)
5. 发布朋友圈：[动态:文本内容:图片描述] (例如 [动态:今天天气真好:蓝天白云的照片])
6. 评论朋友圈：[评论:动态ID:内容] (例如 [评论:1700000000:哈哈真有趣])
7. 回复朋友圈评论：[回复:动态ID:目标人名:内容] (例如 [回复:1700000000:User:谢谢夸奖])
8. 点赞朋友圈：[点赞:动态ID] (例如 [点赞:1700000000])
`;
        if (availableStickers.length > 0) {
            systemPrompt += `9. 发送表情包：[表情包:描述] (描述必须在上述【可用表情包】列表中)\n`;
        }
        systemPrompt += `\n请根据上下文自然地回复。你可以混合使用文本和特殊指令。如果当前聊天氛围适合发朋友圈，或者你想评论对方的朋友圈，请使用相应的指令。`;

        // 7. 构建上下文消息 (上下文限制)
        let limit = config.contextLimit > 0 ? config.contextLimit : 30;
        const msgs = wcState.chats[charId] || [];
        const recentMsgs = msgs.slice(-limit);
        
        const messages = [{ role: "system", content: systemPrompt }];
        
        recentMsgs.forEach(m => {
            // 隐形系统消息逻辑：即使 hidden=true，也要发送给 AI，让 AI 知道发生了什么
            if (m.type === 'system') {
                // 如果是系统消息，作为 system role 发送，或者 user role 的提示
                messages.push({
                    role: "system",
                    content: `[系统提示]: ${m.content}`
                });
                return;
            }

            let content = m.content;
            if (m.type === 'sticker') content = `[发送了一个表情包]`;
            if (m.type === 'image') content = `[发送了一张图片]`;
            if (m.type === 'voice') content = `[语音] ${m.content}`;
            if (m.type === 'transfer') content = `[转账: ${m.amount}元, 备注: ${m.note}, 状态: ${m.status}]`;
            
            messages.push({
                role: m.sender === 'me' ? 'user' : 'assistant',
                content: content
            });
        });

        // 8. 发送 API 请求
        const response = await fetch(`${apiConfig.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiConfig.key}`
            },
            body: JSON.stringify({
                model: apiConfig.model,
                messages: messages,
                temperature: parseFloat(apiConfig.temp) || 0.7
            })
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        let replyText = data.choices[0].message.content;

        // 9. 解析 AI 的动作标签
        wcParseAIResponse(charId, replyText, config.stickerGroupIds);

    } catch (error) {
        console.error("API 请求失败:", error);
        wcAddMessage(charId, 'system', 'system', `API 请求失败: ${error.message}`, { style: 'transparent' });
    } finally {
        titleEl.innerText = originalTitle;
    }
}

// 解析 AI 回复中的特殊标签
function wcParseAIResponse(charId, text, stickerGroupIds) {
    let remainingText = text;

    // 1. 处理收款/退款
    if (remainingText.includes('[收款]')) {
        wcAIHandleTransfer(charId, 'received');
        remainingText = remainingText.replace(/\[收款\]/g, '');
    }
    if (remainingText.includes('[退款]')) {
        wcAIHandleTransfer(charId, 'rejected');
        remainingText = remainingText.replace(/\[退款\]/g, '');
    }

    // 2. 处理转账 [转账:金额:备注]
    const transferRegex = /\[转账:([\d.]+):(.*?)\]/g;
    let match;
    while ((match = transferRegex.exec(remainingText)) !== null) {
        const amount = parseFloat(match[1]).toFixed(2);
        const note = match[2];
        if (!isNaN(amount)) {
            wcAddMessage(charId, 'them', 'transfer', '转账', { amount: amount, note: note, status: 'pending' });
        }
    }
    remainingText = remainingText.replace(transferRegex, '');

    // 3. 处理语音 [语音]内容[/语音]
    const voiceRegex = /\[语音\](.*?)\[\/语音\]/g;
    while ((match = voiceRegex.exec(remainingText)) !== null) {
        wcAddMessage(charId, 'them', 'voice', match[1].trim());
    }
    remainingText = remainingText.replace(voiceRegex, '');

    // 4. 处理表情包 [表情包:描述]
    const stickerRegex = /\[表情包:(.*?)\]/g;
    while ((match = stickerRegex.exec(remainingText)) !== null) {
        const desc = match[1].trim();
        const url = wcFindStickerUrlMulti(stickerGroupIds, desc);
        if (url) {
            wcAddMessage(charId, 'them', 'sticker', url);
        } else {
            remainingText += `\n*(发送了一个表情: ${desc})*`;
        }
    }
    remainingText = remainingText.replace(stickerRegex, '');

    // 5. 处理发布朋友圈 [动态:文本:图片描述]
    const momentRegex = /\[动态:(.*?):(.*?)]/g;
    while ((match = momentRegex.exec(remainingText)) !== null) {
        wcAIHandleMomentPost(charId, match[1], match[2]);
    }
    remainingText = remainingText.replace(momentRegex, '');

    // 6. 处理评论朋友圈 [评论:ID:内容]
    const commentRegex = /\[评论:(\d+):(.*?)]/g;
    while ((match = commentRegex.exec(remainingText)) !== null) {
        wcAIHandleComment(charId, match[1], match[2]);
    }
    remainingText = remainingText.replace(commentRegex, '');

    // 7. 处理回复评论 [回复:ID:人名:内容]
    const replyRegex = /\[回复:(\d+):(.*?):(.*?)]/g;
    while ((match = replyRegex.exec(remainingText)) !== null) {
        wcAIHandleReply(charId, match[1], match[2], match[3]);
    }
    remainingText = remainingText.replace(replyRegex, '');

    // 8. 处理点赞朋友圈 [点赞:ID]
    const likeRegex = /\[点赞:(\d+)\]/g;
    while ((match = likeRegex.exec(remainingText)) !== null) {
        wcAIHandleLike(charId, match[1]);
    }
    remainingText = remainingText.replace(likeRegex, '');

    // 9. 发送剩余的纯文本
    remainingText = remainingText.trim();
    if (remainingText) {
        const lines = remainingText.split('\n');
        lines.forEach(line => {
            if (line.trim()) {
                wcAddMessage(charId, 'them', 'text', line.trim());
            }
        });
    }
}

// AI 发布朋友圈
function wcAIHandleMomentPost(charId, text, imageDesc) {
    const char = wcState.characters.find(c => c.id === charId);
    if (!char) return;
    
    const newMoment = {
        id: Date.now(),
        name: char.name, // 使用角色名
        avatar: char.avatar, // 使用角色头像
        text: text,
        image: null,
        imageDesc: imageDesc,
        time: Date.now(),
        likes: [],
        comments: []
    };
    
    wcState.moments.unshift(newMoment);
    wcSaveData();
    wcRenderMoments();
    // 可选：在聊天中提示
    // wcAddMessage(charId, 'system', 'system', `${char.name} 发布了一条朋友圈`, { style: 'transparent' });
}

// AI 评论朋友圈
function wcAIHandleComment(charId, momentId, text) {
    const char = wcState.characters.find(c => c.id === charId);
    const moment = wcState.moments.find(m => m.id == momentId);
    if (!char || !moment) return;

    if (!moment.comments) moment.comments = [];
    moment.comments.push({ name: char.name, text: text });
    wcSaveData();
    wcRenderMoments();
}

// AI 回复评论
function wcAIHandleReply(charId, momentId, targetName, text) {
    const char = wcState.characters.find(c => c.id === charId);
    const moment = wcState.moments.find(m => m.id == momentId);
    if (!char || !moment) return;

    if (!moment.comments) moment.comments = [];
    moment.comments.push({ name: char.name, text: `回复 ${targetName}: ${text}` });
    wcSaveData();
    wcRenderMoments();
}

// AI 点赞朋友圈
function wcAIHandleLike(charId, momentId) {
    const char = wcState.characters.find(c => c.id === charId);
    const moment = wcState.moments.find(m => m.id == momentId);
    if (!char || !moment) return;
    
    if (!moment.likes) moment.likes = [];
    if (!moment.likes.includes(char.name)) {
        moment.likes.push(char.name);
        wcSaveData();
        wcRenderMoments();
    }
}

// 辅助函数：AI 处理用户的转账
function wcAIHandleTransfer(charId, status) {
    const msgs = wcState.chats[charId] || [];
    // 倒序查找最后一个我发出的、状态为 pending 的转账
    for (let i = msgs.length - 1; i >= 0; i--) {
        const m = msgs[i];
        if (m.type === 'transfer' && m.sender === 'me' && m.status === 'pending') {
            m.status = status;
            if (status === 'rejected') {
                // 退款，钱回到钱包
                const amount = parseFloat(m.amount);
                wcState.wallet.balance += amount;
                wcState.wallet.transactions.push({
                    id: Date.now(), type: 'income', amount: amount, note: `转账退还`, time: Date.now()
                });
                wcAddMessage(charId, 'them', 'system', `对方已退还你的转账`, { style: 'transparent' });
            } else if (status === 'received') {
                wcAddMessage(charId, 'them', 'system', `对方已收款`, { style: 'transparent' });
            }
            wcSaveData();
            wcRenderMessages(charId);
            break;
        }
    }
}

// 辅助函数：根据描述查找表情包 URL (多选支持)
function wcFindStickerUrlMulti(groupIds, desc) {
    if (!groupIds || groupIds.length === 0) return null;
    for (const groupId of groupIds) {
        const group = wcState.stickerCategories[groupId];
        if (group && group.list) {
            const sticker = group.list.find(s => s.desc === desc);
            if (sticker) return sticker.url;
        }
    }
    return null;
}

function wcAddMessage(charId, sender, type, content, extra = {}) {
    if (!wcState.chats[charId]) wcState.chats[charId] = [];
    const msg = { 
        id: Date.now() + Math.random(),
        sender, type, content, time: Date.now(), ...extra
    };
    wcState.chats[charId].push(msg);
    
    // --- 自动总结检查 ---
    const char = wcState.characters.find(c => c.id === charId);
    if (char && char.chatConfig && char.chatConfig.summaryTrigger > 0) {
        const triggerCount = char.chatConfig.summaryTrigger;
        const totalMsgs = wcState.chats[charId].length;
        
        // 如果消息数量是触发数的倍数 (例如设置20，在第20, 40, 60条触发)
        if (totalMsgs % triggerCount === 0) {
            // 自动触发总结：总结最近的 triggerCount 条
            const start = totalMsgs - triggerCount;
            const end = totalMsgs - 1;
            // 异步调用，不阻塞 UI
            wcAutoGenerateSummary(charId, start, end);
        }
    }
    // -------------------

    wcSaveData();
    if (wcState.activeChatId === charId) {
        wcRenderMessages(charId);
        wcScrollToBottom();
    }
}

// 自动总结函数 (简化版 wcGenerateSummary，不弹窗)
async function wcAutoGenerateSummary(charId, start, end) {
    const char = wcState.characters.find(c => c.id === charId);
    const msgs = wcState.chats[charId] || [];
    const sliceMsgs = msgs.slice(start, end + 1);
    const apiConfig = await idb.get('ios_theme_api_config');
    
    if (!apiConfig || !apiConfig.key) return; // 静默失败

    try {
        let prompt = `请自动总结以下对话片段 (${start}-${end})，提取关键信息。\n`;
        
        // 注入总结专用世界书
        if (char.chatConfig && char.chatConfig.summaryWorldbookEntries) {
            prompt += `\n【参考背景】\n`;
            char.chatConfig.summaryWorldbookEntries.forEach(id => {
                const entry = worldbookEntries.find(e => e.id.toString() === id.toString());
                if (entry) prompt += `- ${entry.title}: ${entry.desc}\n`;
            });
        }

        prompt += `\n【对话】\n`;
        sliceMsgs.forEach(m => {
            const sender = m.sender === 'me' ? '用户' : char.name;
            let content = m.content;
            if (m.type !== 'text') content = `[${m.type}]`;
            prompt += `${sender}: ${content}\n`;
        });

        const response = await fetch(`${apiConfig.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiConfig.key}` },
            body: JSON.stringify({
                model: apiConfig.model,
                messages: [{ role: "user", content: prompt }],
                temperature: 0.5
            })
        });

        const data = await response.json();
        const summary = data.choices[0].message.content;

        if (!char.memories) char.memories = [];
        char.memories.unshift({
            id: Date.now(),
            type: 'summary',
            content: `[自动总结 ${start}-${end}] ${summary}`,
            time: Date.now()
        });
        wcSaveData();
        // 如果当前在回忆页，刷新列表
        if (document.getElementById('wc-view-memory').classList.contains('active')) {
            wcRenderMemories();
        }
        console.log("自动总结完成");

    } catch (e) {
        console.error("自动总结失败", e);
    }
}

// --- WeChat Panels ---
function wcToggleStickerPanel() {
    if (wcState.isStickerPanelOpen) {
        wcCloseAllPanels();
    } else {
        wcState.isMorePanelOpen = false;
        wcState.isStickerPanelOpen = true;
        wcUpdatePanelUI();
    }
}

function wcToggleMorePanel() {
    if (wcState.isMorePanelOpen) {
        wcCloseAllPanels();
    } else {
        wcState.isStickerPanelOpen = false;
        wcState.isMorePanelOpen = true;
        wcUpdatePanelUI();
    }
}

function wcCloseAllPanels() {
    wcState.isStickerPanelOpen = false;
    wcState.isMorePanelOpen = false;
    wcState.isStickerDeleteMode = false;
    wcUpdatePanelUI();
}

function wcUpdatePanelUI() {
    const stickerPanel = document.getElementById('wc-sticker-panel');
    const morePanel = document.getElementById('wc-more-panel');
    const footer = document.getElementById('wc-chat-footer');
    const scrollArea = document.getElementById('wc-chat-messages');

    stickerPanel.classList.remove('active');
    morePanel.classList.remove('active');
    footer.classList.remove('panel-active');
    scrollArea.classList.remove('panel-open');

    if (wcState.isStickerPanelOpen) {
        stickerPanel.classList.add('active');
        footer.classList.add('panel-active');
        scrollArea.classList.add('panel-open');
        wcRenderStickerPanel();
    } else if (wcState.isMorePanelOpen) {
        morePanel.classList.add('active');
        footer.classList.add('panel-active');
        scrollArea.classList.add('panel-open');
    }
    wcScrollToBottom();
}

// --- WeChat Stickers ---
function wcRenderStickerPanel() {
    const container = document.getElementById('wc-sticker-tabs');
    container.innerHTML = '';
    wcState.stickerCategories.forEach((cat, index) => {
        const tab = document.createElement('div');
        tab.className = `wc-sticker-tab-item ${index === wcState.activeStickerCategoryIndex ? 'active' : ''}`;
        tab.innerText = cat.name;
        tab.onclick = () => { wcState.activeStickerCategoryIndex = index; wcRenderStickerPanel(); };
        container.appendChild(tab);
    });

    const grid = document.getElementById('wc-sticker-grid');
    grid.innerHTML = '';
    const currentCat = wcState.stickerCategories[wcState.activeStickerCategoryIndex];
    if (!currentCat || !currentCat.list) return;

    currentCat.list.forEach((sticker, index) => {
        const item = document.createElement('div');
        item.className = `wc-sticker-item ${wcState.isStickerDeleteMode ? 'shake' : ''}`;
        
        // 修复：强制使用 Flex 布局确保 50x50 和文字居中
        item.style.display = 'flex';
        item.style.flexDirection = 'column';
        item.style.alignItems = 'center';
        item.style.justifyContent = 'center';
        item.style.padding = '5px';
        
        const img = document.createElement('img');
        img.src = sticker.url;
        // 修复：强制图片大小为 50x50px
        img.style.width = '50px';
        img.style.height = '50px';
        img.style.objectFit = 'contain';
        item.appendChild(img);

        // 修复：添加表情包描述文字
        const desc = document.createElement('div');
        desc.style.fontSize = '10px';
        desc.style.color = '#888';
        desc.style.textAlign = 'center';
        desc.style.marginTop = '4px';
        desc.style.overflow = 'hidden';
        desc.style.textOverflow = 'ellipsis';
        desc.style.whiteSpace = 'nowrap';
        desc.style.width = '100%';
        desc.style.maxWidth = '60px'; // 防止文字过长撑开容器
        desc.innerText = sticker.desc;
        item.appendChild(desc);

        if (wcState.isStickerDeleteMode) {
            const badge = document.createElement('div');
            badge.className = 'wc-sticker-delete-badge';
            badge.innerText = '×';
            badge.onclick = (e) => { 
                e.stopPropagation(); 
                currentCat.list.splice(index, 1); 
                wcSaveData(); 
                wcRenderStickerPanel(); 
            };
            item.appendChild(badge);
        } else {
            // 修复：阻止冒泡，防止触发其他点击事件
            item.onclick = (e) => {
                e.stopPropagation();
                wcAddMessage(wcState.activeChatId, 'me', 'sticker', sticker.url);
            };
        }
        grid.appendChild(item);
    });
}

function wcOpenStickerOptions(e) {
    if(e) e.stopPropagation(); // 阻止冒泡，防止触发其他点击事件
    const btnText = document.getElementById('wc-btn-sticker-manage-text');
    btnText.innerText = wcState.isStickerDeleteMode ? "退出管理模式" : "管理表情 (删除)";
    btnText.style.color = wcState.isStickerDeleteMode ? "#000" : "#007AFF";
    wcOpenModal('wc-sticker-options-modal');
}

function wcToggleStickerDeleteMode() {
    wcState.isStickerDeleteMode = !wcState.isStickerDeleteMode;
    wcRenderStickerPanel();
}

function wcImportStickers() {
    const catName = document.getElementById('wc-sticker-category-name').value.trim();
    const data = document.getElementById('wc-sticker-import-text').value;
    if (!catName || !data) return alert('请填写完整');
    const lines = data.split('\n');
    const newStickers = [];
    lines.forEach(line => {
        const match = line.match(/^([^:：]+)[:：](.+)$/);
        if (match) newStickers.push({ desc: match[1].trim(), url: match[2].trim() });
    });
    if (newStickers.length === 0) return alert('格式错误');
    
    wcState.stickerCategories.push({ name: catName, list: newStickers });
    wcState.stickerCategories[0].list.push(...newStickers);
    
    wcSaveData();
    wcCloseModal('wc-import-sticker-modal');
    wcState.activeStickerCategoryIndex = wcState.stickerCategories.length - 1;
    wcRenderStickerPanel();
}

function wcOpenDeleteCategoriesModal() {
    const list = document.getElementById('wc-sticker-delete-cats-list');
    list.innerHTML = '';
    wcState.stickerCategories.forEach((cat, index) => {
        if (index === 0) return; 
        const div = document.createElement('div');
        div.className = 'wc-list-item';
        div.style.background = 'white';
        div.innerHTML = `<div class="wc-item-content"><div class="wc-item-title">${cat.name}</div></div><input type="checkbox" class="wc-delete-cat-checkbox" value="${index}">`;
        list.appendChild(div);
    });
    wcOpenModal('wc-sticker-delete-cats-modal');
}

function wcConfirmDeleteCategories() {
    const checkboxes = document.querySelectorAll('.wc-delete-cat-checkbox:checked');
    const indices = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a,b)=>b-a);
    indices.forEach(i => wcState.stickerCategories.splice(i, 1));
    
    const allStickers = [];
    for (let i = 1; i < wcState.stickerCategories.length; i++) {
        allStickers.push(...wcState.stickerCategories[i].list);
    }
    wcState.stickerCategories[0].list = allStickers;

    wcState.activeStickerCategoryIndex = 0;
    wcSaveData();
    wcCloseModal('wc-sticker-delete-cats-modal');
    wcRenderStickerPanel();
}

// --- WeChat More Actions ---
function wcActionRoll() {
    const msgs = wcState.chats[wcState.activeChatId];
    if (!msgs || msgs.length === 0) return;

    // 修复：寻找最后一条由 'me' (用户) 发送的消息的索引
    let lastMeIndex = -1;
    for (let i = msgs.length - 1; i >= 0; i--) {
        if (msgs[i].sender === 'me') {
            lastMeIndex = i;
            break;
        }
    }

    if (lastMeIndex !== -1) {
        // 保留到最后一条 'me' 的消息，删除之后所有的 'them' 消息
        wcState.chats[wcState.activeChatId] = msgs.slice(0, lastMeIndex + 1);
    } else {
        // 如果没有 'me' 的消息，说明全是 AI 发的，直接清空
        wcState.chats[wcState.activeChatId] = [];
    }

    wcSaveData();
    wcRenderMessages(wcState.activeChatId);
    wcTriggerAI(); // 重新触发 AI
    wcCloseAllPanels();
}

function wcActionVoice() {
    wcCloseAllPanels();
    wcOpenGeneralInput("输入语音内容", (text) => {
        if (text) wcAddMessage(wcState.activeChatId, 'me', 'voice', text);
    });
}

function wcToggleVoiceText(msgId) {
    const msgs = wcState.chats[wcState.activeChatId];
    const msg = msgs.find(m => m.id === msgId);
    if (msg) {
        msg.showText = !msg.showText;
        wcRenderMessages(wcState.activeChatId);
    }
}

function wcActionImageDesc() {
    const desc = prompt("请输入图片描述：");
    if (desc) wcAddMessage(wcState.activeChatId, 'me', 'text', `[图片描述] ${desc}`);
}

// --- WeChat Memory ---
function wcActionMemory() {
    wcCloseAllPanels();
    wcOpenMemoryPage();
}

function wcOpenMemoryPage() {
    document.getElementById('wc-view-chat-detail').classList.remove('active');
    document.getElementById('wc-view-memory').classList.add('active');
    document.getElementById('wc-nav-title').innerText = '回忆总结';
    
    const rightContainer = document.getElementById('wc-nav-right-container');
    rightContainer.innerHTML = '';
    
    // 设置按钮：关联世界书 & 自动总结条数
    const btnSettings = document.createElement('button');
    btnSettings.className = 'wc-nav-btn';
    btnSettings.innerHTML = '<svg class="wc-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>';
    btnSettings.onclick = () => wcOpenMemorySettingsModal();
    rightContainer.appendChild(btnSettings);

    // 更多操作：手动添加/生成
    const btn = document.createElement('button');
    btn.className = 'wc-nav-btn';
    btn.innerHTML = '<svg class="wc-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>';
    btn.onclick = () => wcOpenModal('wc-modal-memory-actions');
    rightContainer.appendChild(btn);

    wcRenderMemories();
}

function wcCloseMemoryPage() {
    document.getElementById('wc-view-memory').classList.remove('active');
    document.getElementById('wc-view-chat-detail').classList.add('active');
    const char = wcState.characters.find(c => c.id === wcState.activeChatId);
    document.getElementById('wc-nav-title').innerText = char.note || char.name;
    
    const rightContainer = document.getElementById('wc-nav-right-container');
    rightContainer.innerHTML = '';
    const btn = document.createElement('button');
    btn.className = 'wc-nav-btn';
    btn.innerHTML = '<svg class="wc-icon" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>';
    btn.onclick = () => wcOpenChatSettings();
    rightContainer.appendChild(btn);
}

function wcRenderMemories() {
    const container = document.getElementById('wc-memory-list-container');
    container.innerHTML = '';
    const char = wcState.characters.find(c => c.id === wcState.activeChatId);
    if (!char.memories) char.memories = [];

    if (char.memories.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #8E8E93; padding-top: 50px;">暂无回忆</div>';
        return;
    }

    char.memories.forEach((mem, index) => {
        const div = document.createElement('div');
        div.className = 'wc-memory-card';
        div.innerHTML = `
            <div class="wc-memory-header">
                <span>${new Date(mem.time).toLocaleString()}</span>
                <span>${mem.type === 'summary' ? '自动总结' : '手动添加'}</span>
            </div>
            <div class="wc-memory-content">${mem.content}</div>
            <div class="wc-memory-delete-btn" onclick="wcDeleteMemory(${index})">删除</div>
        `;
        container.appendChild(div);
    });
}

function wcDeleteMemory(index) {
    if (confirm("确定删除这条记忆吗？")) {
        const char = wcState.characters.find(c => c.id === wcState.activeChatId);
        char.memories.splice(index, 1);
        wcSaveData();
        wcRenderMemories();
    }
}

function wcOpenMemorySummaryModal() {
    const msgs = wcState.chats[wcState.activeChatId] || [];
    document.getElementById('wc-mem-total-count-label').innerText = `当前聊天总层数: ${msgs.length}`;
    wcOpenModal('wc-modal-memory-summary');
}

// --- Memory Settings Logic ---

function wcOpenMemorySettingsModal() {
    const char = wcState.characters.find(c => c.id === wcState.activeChatId);
    if (!char) return;
    if (!char.chatConfig) char.chatConfig = {};

    // 1. 设置自动触发输入框的值
    document.getElementById('wc-mem-setting-trigger').value = char.chatConfig.summaryTrigger || 0;

    // 2. 渲染总结专用世界书列表
    const list = document.getElementById('wc-mem-setting-wb-list');
    list.innerHTML = '';
    
    // 确保 summaryWorldbookEntries 数组存在
    if (!char.chatConfig.summaryWorldbookEntries) char.chatConfig.summaryWorldbookEntries = [];

    if (worldbookEntries.length === 0) {
        list.innerHTML = '<div style="color:#999; font-size:13px;">暂无世界书条目</div>';
    } else {
        worldbookEntries.forEach(entry => {
            const div = document.createElement('div');
            div.className = 'wc-checkbox-item';
            // 检查是否已选中
            const isChecked = char.chatConfig.summaryWorldbookEntries.includes(entry.id.toString());
            
            div.innerHTML = `<input type="checkbox" value="${entry.id}" ${isChecked ? 'checked' : ''}><span>${entry.title} (${entry.type})</span>`;
            list.appendChild(div);
        });
    }

    wcOpenModal('wc-modal-memory-settings');
}

function wcSaveMemorySettings() {
    const char = wcState.characters.find(c => c.id === wcState.activeChatId);
    if (!char) return;
    if (!char.chatConfig) char.chatConfig = {};

    // 保存自动触发条数
    const triggerCount = parseInt(document.getElementById('wc-mem-setting-trigger').value) || 0;
    char.chatConfig.summaryTrigger = triggerCount;

    // 保存选中的世界书 ID
    const checkboxes = document.querySelectorAll('#wc-mem-setting-wb-list input[type="checkbox"]:checked');
    char.chatConfig.summaryWorldbookEntries = Array.from(checkboxes).map(cb => cb.value);

    wcSaveData();
    wcCloseModal('wc-modal-memory-settings');
    alert("回忆设置已保存");
}

// 打开总结专用世界书选择弹窗 (旧版，保留兼容性，但主要使用 wcOpenMemorySettingsModal)
function wcOpenSummaryWbSelect() {
    const list = document.getElementById('wc-summary-wb-list');
    list.innerHTML = '';
    if (worldbookEntries.length === 0) {
        list.innerHTML = '<div style="color:#999; font-size:13px;">暂无世界书条目</div>';
    } else {
        worldbookEntries.forEach(entry => {
            const div = document.createElement('div');
            div.className = 'wc-checkbox-item';
            const isChecked = tempSummaryWbIds.includes(entry.id);
            div.innerHTML = `<input type="checkbox" value="${entry.id}" ${isChecked ? 'checked' : ''}><span>${entry.title} (${entry.type})</span>`;
            div.querySelector('input').onchange = (e) => {
                if (e.target.checked) tempSummaryWbIds.push(entry.id);
                else tempSummaryWbIds = tempSummaryWbIds.filter(id => id !== entry.id);
            };
            list.appendChild(div);
        });
    }
    wcOpenModal('wc-modal-summary-wb-select');
}

// 真实调用 API 生成总结 (包含世界书)
async function wcGenerateSummary() {
    const start = parseInt(document.getElementById('wc-mem-start-idx').value);
    const end = parseInt(document.getElementById('wc-mem-end-idx').value);
    
    if (isNaN(start) || isNaN(end) || start > end) {
        alert("请输入有效的起始和结束层数");
        return;
    }

    const char = wcState.characters.find(c => c.id === wcState.activeChatId);
    const msgs = wcState.chats[wcState.activeChatId] || [];
    
    const sliceMsgs = msgs.slice(start, end + 1);
    if (sliceMsgs.length === 0) {
        alert("该范围内没有消息");
        return;
    }

    const apiConfig = await idb.get('ios_theme_api_config');
    if (!apiConfig || !apiConfig.baseUrl || !apiConfig.key || !apiConfig.model) {
        alert("请先配置 API");
        return;
    }

    const btn = document.getElementById('wc-btn-generate-summary');
    const originalText = btn.innerText;
    btn.innerText = "正在生成总结...";
    btn.disabled = true;

    try {
        let prompt = `请总结以下对话的主要内容，提取关键信息和情感变化，字数控制在200字以内。\n`;
        
        // 注入选中的世界书 (优先使用设置里的，其次使用临时选择的)
        let wbIds = [];
        if (char.chatConfig && char.chatConfig.summaryWorldbookEntries && char.chatConfig.summaryWorldbookEntries.length > 0) {
            wbIds = char.chatConfig.summaryWorldbookEntries;
        } else {
            wbIds = tempSummaryWbIds;
        }

        if (wbIds.length > 0) {
            prompt += `\n【参考背景资料】\n`;
            wbIds.forEach(id => {
                const entry = worldbookEntries.find(e => e.id.toString() === id.toString());
                if (entry) prompt += `- ${entry.title}: ${entry.desc}\n`;
            });
        }

        prompt += `\n【对话内容】\n`;
        sliceMsgs.forEach(m => {
            const sender = m.sender === 'me' ? '用户' : char.name;
            let content = m.content;
            if (m.type !== 'text') content = `[${m.type}]`;
            prompt += `${sender}: ${content}\n`;
        });

        const response = await fetch(`${apiConfig.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiConfig.key}`
            },
            body: JSON.stringify({
                model: apiConfig.model,
                messages: [{ role: "user", content: prompt }],
                temperature: 0.5
            })
        });

        if (!response.ok) throw new Error("API Error");
        const data = await response.json();
        const summary = data.choices[0].message.content;

        if (!char.memories) char.memories = [];
        char.memories.unshift({
            id: Date.now(),
            type: 'summary',
            content: `[总结 ${start}-${end}] ${summary}`,
            time: Date.now()
        });
        wcSaveData();
        wcRenderMemories();
        wcCloseModal('wc-modal-memory-summary');
        alert("总结生成成功！");

    } catch (e) {
        alert("生成失败: " + e.message);
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
}

function wcAddManualMemory() {
    const text = document.getElementById('wc-mem-manual-text').value;
    if (!text) return;
    const char = wcState.characters.find(c => c.id === wcState.activeChatId);
    if (!char.memories) char.memories = [];
    
    char.memories.unshift({
        id: Date.now(),
        type: 'manual',
        content: text,
        time: Date.now()
    });
    wcSaveData();
    wcRenderMemories();
    document.getElementById('wc-mem-manual-text').value = '';
    wcCloseModal('wc-modal-memory-add');
}

function wcSaveAiMemoryCount() {
    const count = document.getElementById('wc-mem-ai-read-count').value;
    const char = wcState.characters.find(c => c.id === wcState.activeChatId);
    if (!char.chatConfig) char.chatConfig = {};
    char.chatConfig.aiMemoryCount = parseInt(count) || 5;
    wcSaveData();
    wcCloseModal('wc-modal-memory-ai-count');
    alert(`已设置发送给AI的记忆条数为: ${char.chatConfig.aiMemoryCount}`);
}

// --- WeChat General Input ---
function wcOpenGeneralInput(title, callback, isPassword = false) {
    document.getElementById('wc-general-input-title').innerText = title;
    const input = document.getElementById('wc-general-input-field');
    input.value = '';
    input.type = isPassword ? 'password' : 'text';
    wcState.generalInputCallback = callback;
    wcOpenModal('wc-modal-general-input');
    input.focus();
}

// --- WeChat Transfer ---
function wcOpenTransferModal() {
    document.getElementById('wc-transfer-amount').value = '';
    document.getElementById('wc-transfer-note').value = '';
    wcOpenModal('wc-modal-transfer-input');
    wcCloseAllPanels();
}

function wcSubmitTransferDetails() {
    const amount = document.getElementById('wc-transfer-amount').value;
    const note = document.getElementById('wc-transfer-note').value;
    if (!amount || parseFloat(amount) <= 0) return alert("请输入有效金额");
    
    wcState.tempTransfer = { amount, note };
    wcCloseModal('wc-modal-transfer-input');
    
    wcOpenGeneralInput("请输入支付密码", (pass) => {
        wcCheckPassword(pass);
    }, true);
}

function wcCheckPassword(val) {
    if (val !== wcState.wallet.password) {
        alert("密码错误！");
        return;
    }
    const amount = parseFloat(wcState.tempTransfer.amount);
    if (wcState.wallet.balance < amount) {
        alert("余额不足！请先充值。");
        return;
    }
    wcState.wallet.balance -= amount;
    wcState.wallet.transactions.push({
        id: Date.now(), type: 'payment', amount: amount,
        note: `转账给 ${document.getElementById('wc-nav-title').innerText}`, time: Date.now()
    });
    wcSaveData();
    wcAddMessage(wcState.activeChatId, 'me', 'transfer', '转账', {
        amount: wcState.tempTransfer.amount,
        note: wcState.tempTransfer.note,
        status: 'pending'
    });
}

function wcHandleTransferClick(msgId) {
    const msgs = wcState.chats[wcState.activeChatId];
    const msg = msgs.find(m => m.id === msgId);
    if (!msg) return;
    if (msg.status !== 'pending') return;

    if (msg.sender === 'me') {
        alert("等待对方收款");
    } else {
        wcState.activeTransferMsgId = msgId;
        wcOpenModal('wc-modal-transfer-action');
    }
}

function wcConfirmTransferReceive() { wcUpdateTransferStatus('received'); }
function wcConfirmTransferReject() { wcUpdateTransferStatus('rejected'); }

function wcUpdateTransferStatus(status) {
    const msgs = wcState.chats[wcState.activeChatId];
    const msg = msgs.find(m => m.id === wcState.activeTransferMsgId);
    if (msg) {
        msg.status = status;
        if (status === 'received') {
            const amount = parseFloat(msg.amount);
            wcState.wallet.balance += amount;
            wcState.wallet.transactions.push({
                id: Date.now(), type: 'income', amount: amount, note: `收到转账`, time: Date.now()
            });
            wcAddMessage(wcState.activeChatId, 'me', 'system', `已收款，资金已存入零钱`, { style: 'transparent' });
        } else if (status === 'rejected') {
            wcAddMessage(wcState.activeChatId, 'me', 'system', `已退还转账`, { style: 'transparent' });
        }
        wcSaveData();
        wcRenderMessages(wcState.activeChatId);
    }
    wcCloseModal('wc-modal-transfer-action');
}

// --- WeChat Wallet ---
function wcOpenWallet() {
    document.getElementById('wc-view-user').classList.remove('active');
    document.getElementById('wc-view-wallet').classList.add('active');
    
    // 隐藏 TabBar
    document.getElementById('wc-main-tabbar').style.display = 'none';
    
    // 关键修复：强制隐藏退出按钮，显示返回按钮
    document.getElementById('wc-btn-exit').style.display = 'none';
    document.getElementById('wc-btn-back').style.display = 'flex';
    
    // 重写返回按钮逻辑，使其只关闭钱包
    document.getElementById('wc-btn-back').onclick = wcCloseWallet;
    
    document.getElementById('wc-nav-title').innerText = '钱包';
    
    const rightContainer = document.getElementById('wc-nav-right-container');
    rightContainer.innerHTML = '';
    const btn = document.createElement('button');
    btn.className = 'wc-nav-btn';
    btn.innerText = '设置'; 
    btn.onclick = () => wcOpenModal('wc-modal-wallet-settings');
    rightContainer.appendChild(btn);

    wcRenderWallet();
}

function wcCloseWallet() {
    document.getElementById('wc-view-wallet').classList.remove('active');
    wcSwitchTab('user'); // 返回用户页
    
    // 恢复导航栏状态
    document.getElementById('wc-main-tabbar').style.display = 'flex';
    document.getElementById('wc-btn-back').style.display = 'none';
    document.getElementById('wc-btn-exit').style.display = 'flex';
    
    // 恢复返回按钮的默认行为
    document.getElementById('wc-btn-back').onclick = wcHandleBack;
}

function wcRenderWallet() {
    document.getElementById('wc-wallet-balance-display').innerText = parseFloat(wcState.wallet.balance).toFixed(2);
    const list = document.getElementById('wc-wallet-history-list');
    list.innerHTML = '';
    const sortedTrans = [...wcState.wallet.transactions].sort((a, b) => b.time - a.time);

    if (sortedTrans.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: #8E8E93;">暂无交易记录</div>';
        return;
    }

    sortedTrans.forEach(t => {
        const div = document.createElement('div');
        div.className = 'wc-transaction-item';
        const isIncome = t.type === 'income' || t.type === 'recharge';
        const sign = isIncome ? '+' : '-';
        const colorClass = isIncome ? 'wc-amount-in' : 'wc-amount-out';
        div.innerHTML = `
            <div class="wc-trans-info">
                <div class="wc-trans-title">${t.note}</div>
                <div class="wc-trans-time">${new Date(t.time).toLocaleString()}</div>
            </div>
            <div class="wc-trans-amount ${colorClass}">${sign}${parseFloat(t.amount).toFixed(2)}</div>
        `;
        list.appendChild(div);
    });
}

function wcOpenRechargeModal() {
    document.getElementById('wc-recharge-amount').value = '';
    wcOpenModal('wc-modal-recharge');
}

function wcConfirmRecharge() {
    const amount = parseFloat(document.getElementById('wc-recharge-amount').value);
    if (!amount || amount <= 0) return alert("请输入有效金额");
    wcState.wallet.balance += amount;
    wcState.wallet.transactions.push({
        id: Date.now(), type: 'recharge', amount: amount, note: '余额充值', time: Date.now()
    });
    wcSaveData();
    wcRenderWallet();
    wcCloseModal('wc-modal-recharge');
    alert(`充值成功 +${amount.toFixed(2)}`);
}

function wcOpenSetPasswordModal() {
    wcOpenGeneralInput("设置新支付密码 (6位数字)", (newPass) => {
        if (newPass && newPass.length === 6 && !isNaN(newPass)) {
            wcState.wallet.password = newPass;
            wcSaveData();
            alert("密码设置成功");
        } else if (newPass) {
            alert("密码格式错误，必须为6位数字");
        }
    }, true);
}

function wcClearTransactionHistory() {
    if (confirm("确定清空所有交易记录吗？余额不会改变。")) {
        wcState.wallet.transactions = [];
        wcSaveData();
        wcRenderWallet();
    }
}

// --- WeChat Render All ---
function wcRenderAll() { wcRenderContacts(); wcRenderChats(); wcRenderMoments(); wcRenderUser(); }

function wcRenderContacts() {
    const list = document.getElementById('wc-contacts-list');
    list.innerHTML = '';
    wcState.characters.forEach(char => {
        const div = document.createElement('div');
        div.className = 'wc-swipe-container';
        div.innerHTML = `<div class="wc-swipe-actions" onclick="wcDeleteCharacter(${char.id})">删除</div><div class="wc-swipe-content" onclick="wcShowCharDetail(${char.id})" ontouchstart="wcHandleTouchStartSwipe(event)" ontouchmove="wcHandleTouchMoveSwipe(event)" ontouchend="wcHandleTouchEndSwipe(event)"><img src="${char.avatar}" class="wc-avatar"><div class="wc-item-content"><div class="wc-item-title">${char.name}</div><div class="wc-item-subtitle">${char.note}</div></div></div>`;
        list.appendChild(div);
    });
}

function wcRenderChats() {
    const list = document.getElementById('wc-chat-list');
    list.innerHTML = '';
    const pinnedChars = wcState.characters.filter(c => c.isPinned);
    const otherChars = wcState.characters.filter(c => !c.isPinned).sort((a, b) => {
        const msgsA = wcState.chats[a.id] || [];
        const msgsB = wcState.chats[b.id] || [];
        const timeA = msgsA.length > 0 ? msgsA[msgsA.length - 1].time : 0;
        const timeB = msgsB.length > 0 ? msgsB[msgsB.length - 1].time : 0;
        return timeB - timeA;
    });

    const createChatItem = (char) => {
        const msgs = wcState.chats[char.id] || [];
        const lastMsg = msgs.length > 0 ? msgs[msgs.length - 1] : null;
        let subtitle = '点击开始聊天...';
        let timeStr = '';
        if (lastMsg) {
            if (lastMsg.type === 'sticker') subtitle = '[表情包]';
            else if (lastMsg.type === 'image') subtitle = '[图片]';
            else if (lastMsg.type === 'voice') subtitle = '[语音]';
            else if (lastMsg.type === 'transfer') subtitle = '[转账]';
            else if (lastMsg.type === 'system') subtitle = '[系统消息]';
            else subtitle = lastMsg.content;
            timeStr = new Date(lastMsg.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        const div = document.createElement('div');
        div.className = 'wc-chat-swipe-container';
        const pinText = char.isPinned ? "取消置顶" : "置顶";
        const pinClass = char.isPinned ? "wc-pinned-chat" : "";
        
        div.innerHTML = `
            <div class="wc-chat-swipe-actions">
                <div class="wc-chat-action-btn wc-btn-pin" onclick="wcTogglePin(${char.id})">${pinText}</div>
            </div>
            <div class="wc-chat-swipe-content ${pinClass}" onclick="wcOpenChat(${char.id})" ontouchstart="wcHandleTouchStartSwipe(event)" ontouchmove="wcHandleTouchMoveSwipe(event)" ontouchend="wcHandleTouchEndSwipe(event)">
                <img src="${char.avatar}" class="wc-avatar">
                <div class="wc-item-content">
                    <div class="wc-item-title">${char.note || char.name}</div>
                    <div class="wc-item-subtitle">${subtitle}</div>
                </div>
                <div style="font-size: 12px; color: #C7C7CC;">${timeStr}</div>
            </div>
        `;
        return div;
    };

    pinnedChars.forEach(char => list.appendChild(createChatItem(char)));
    if (pinnedChars.length > 0 && otherChars.length > 0) {
        const sep = document.createElement('div');
        sep.className = 'wc-list-separator';
        sep.innerText = 'ovo';
        list.appendChild(sep);
    }
    otherChars.forEach(char => list.appendChild(createChatItem(char)));
}

function wcRenderMoments() {
    const feed = document.getElementById('wc-moments-feed');
    feed.innerHTML = '';
    if (wcState.user.cover) document.getElementById('wc-moments-cover').src = wcState.user.cover;
    if (wcState.user.avatar) document.getElementById('wc-moments-user-avatar').src = wcState.user.avatar;
    
    wcState.moments.forEach(moment => {
        let mediaHtml = '';
        if (moment.image) mediaHtml = `<img src="${moment.image}" class="wc-moment-image">`;
        else if (moment.imageDesc) mediaHtml = `<div class="wc-moment-image-placeholder"><svg class="wc-icon" style="margin-bottom: 4px;" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg><div>[图片] ${moment.imageDesc}</div></div>`;
        
        let likesHtml = '';
        if (moment.likes && moment.likes.length > 0) likesHtml = `<div class="wc-moment-like-row"><svg class="wc-icon wc-icon-fill" style="width:14px; height:14px; margin-right:4px;" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>${moment.likes.join(', ')}</div>`;
        
        let commentsHtml = '';
        if (moment.comments && moment.comments.length > 0) {
            moment.comments.forEach((c, cIdx) => { 
                // 允许点击评论进行回复
                commentsHtml += `<div class="wc-moment-comment-row" onclick="wcPrepareReply(${moment.id}, ${cIdx}, '${c.name}')"><span class="wc-moment-comment-name">${c.name}:</span> ${c.text}</div>`; 
            });
        }
        
        const interactionArea = (likesHtml || commentsHtml) ? `<div class="wc-moment-likes-comments">${likesHtml}${commentsHtml}</div>` : '';
        
        const div = document.createElement('div');
        div.className = 'wc-moment-card';
        div.innerHTML = `
            <img src="${moment.avatar || wcState.user.avatar}" class="wc-avatar" style="width: 40px; height: 40px; border-radius: 4px;">
            <div class="wc-moment-content">
                <div class="wc-moment-name">${moment.name || wcState.user.name}</div>
                <div class="wc-moment-text">${moment.text}</div>
                ${mediaHtml}
                <div class="wc-moment-actions">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 12px; color: #8E8E93;">${new Date(moment.time).toLocaleTimeString()}</span>
                        <span style="font-size: 12px; color: #576B95; cursor: pointer;" onclick="wcDeleteMoment(${moment.id})">删除</span>
                    </div>
                    <div style="display: flex; gap: 16px;">
                        <div onclick="wcToggleLike(${moment.id})"><svg class="wc-icon" style="width:20px; height:20px; color: #576B95;" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></div>
                        <div onclick="wcToggleCommentBox(${moment.id})"><svg class="wc-icon" style="width:20px; height:20px; color: #576B95;" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></div>
                    </div>
                </div>
                ${interactionArea}
                <div id="wc-comment-box-${moment.id}" class="wc-comment-input-box" style="display: none;">
                    <input type="text" id="wc-input-comment-${moment.id}" class="wc-comment-input" placeholder="评论...">
                    <button class="wc-moment-action-btn" onclick="wcAddComment(${moment.id})">发送</button>
                </div>
            </div>
        `;
        feed.prepend(div);
    });
}

function wcRenderUser() { 
    if (wcState.user.avatar) document.getElementById('wc-user-center-avatar').src = wcState.user.avatar; 
    document.getElementById('wc-user-name-display').innerText = wcState.user.name; 
}

// --- WeChat Character & User Management ---
function wcTriggerUpload(type) { document.getElementById(`wc-file-input-${type}`).click(); }

async function wcHandleFileSelect(event, type) {
    const file = event.target.files[0];
    if (!file) return;
    try {
        const base64 = await wcCompressImage(file);
        wcState.tempImage = base64;
        wcState.tempImageType = type; 

        if (type === 'char') {
            document.getElementById('wc-preview-char-avatar').src = base64;
            document.getElementById('wc-preview-char-avatar').style.display = 'block';
            document.getElementById('wc-icon-char-upload').style.display = 'none';
        } else if (type === 'edit-char') {
            document.getElementById('wc-edit-char-avatar').src = base64;
        } else if (type === 'user') {
            wcState.user.avatar = base64;
            wcSaveData();
            wcRenderUser();
        } else if (type === 'cover') {
            wcState.user.cover = base64;
            wcSaveData();
            wcRenderMoments();
        } else if (type === 'moment') {
            document.getElementById('wc-preview-moment-img').src = base64;
            document.getElementById('wc-preview-moment-img').style.display = 'block';
            document.getElementById('wc-icon-moment-upload').style.display = 'none';
        } else if (type === 'mask') {
            document.getElementById('wc-preview-mask-avatar').src = base64;
        } else if (type === 'chat-img') {
            wcAddMessage(wcState.activeChatId, 'me', 'image', base64);
            wcCloseAllPanels();
        } else if (type === 'setting-char') {
            document.getElementById('wc-setting-char-avatar').src = base64;
        } else if (type === 'setting-user') {
            document.getElementById('wc-setting-user-avatar').src = base64;
        } else if (type === 'setting-bg') {
            document.getElementById('wc-setting-bg-preview').src = base64;
            document.getElementById('wc-setting-bg-preview').style.display = 'block';
            document.getElementById('wc-setting-bg-text').style.display = 'none';
        } else if (type === 'phone-bg') {
            document.getElementById('wc-preview-phone-bg').src = base64;
            document.getElementById('wc-preview-phone-bg').style.display = 'block';
            document.getElementById('wc-text-phone-bg').style.display = 'none';
            wcState.tempPhoneConfig.wallpaper = base64;
        } else if (type.startsWith('icon-')) {
            const iconKey = type.replace('icon-', '');
            document.getElementById(`wc-preview-icon-${iconKey}`).src = base64;
            document.getElementById(`wc-preview-icon-${iconKey}`).style.display = 'block';
            if(!wcState.tempPhoneConfig.icons) wcState.tempPhoneConfig.icons = {};
            wcState.tempPhoneConfig.icons[iconKey] = base64;
        }
    } catch (err) {
        alert("图片处理失败");
    }
}

function wcSaveCharacter() {
    const name = document.getElementById('wc-input-char-name').value;
    const note = document.getElementById('wc-input-char-note').value;
    const prompt = document.getElementById('wc-input-char-prompt').value;
    if (!name) return alert('请输入角色名称');
    
    const defaultAvatarSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="#8E8E93"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="white" font-size="40">${name[0]}</text></svg>`;
    const defaultAvatar = 'data:image/svg+xml;base64,' + window.btoa(unescape(encodeURIComponent(defaultAvatarSvg)));

    const newChar = {
        id: Date.now(), name: name, note: note, prompt: prompt,
        avatar: wcState.tempImage || defaultAvatar, isPinned: false
    };
    wcState.characters.push(newChar);
    wcSaveData();
    wcCloseModal('wc-modal-add-char');
    wcRenderAll();
}

function wcDeleteCharacter(id) {
    if(confirm('确定删除该角色吗？')) {
        wcState.characters = wcState.characters.filter(c => c.id !== id);
        delete wcState.chats[id];
        wcDb.delete('chats', id);
        wcDb.delete('characters', id);
        wcSaveData();
        wcRenderAll();
    }
}

function wcTogglePin(id) {
    const char = wcState.characters.find(c => c.id === id);
    if (char) {
        char.isPinned = !char.isPinned;
        wcSaveData();
        wcRenderChats();
    }
}

function wcShowCharDetail(id) {
    const char = wcState.characters.find(c => c.id === id);
    if (!char) return;
    wcState.editingCharId = id;
    document.getElementById('wc-detail-char-avatar').src = char.avatar;
    document.getElementById('wc-detail-char-name').innerText = char.name;
    document.getElementById('wc-detail-char-note').innerText = char.note || "暂无备注";
    wcOpenModal('wc-modal-char-detail');
}

function wcCheckPhoneAction() {
    wcCloseModal('wc-modal-char-detail');
    wcOpenPhoneSim();
}

function wcOpenEditCharSettings() {
    const char = wcState.characters.find(c => c.id === wcState.editingCharId);
    if (!char) return;
    wcState.tempImage = '';
    document.getElementById('wc-edit-char-avatar').src = char.avatar;
    document.getElementById('wc-edit-char-name').value = char.name;
    document.getElementById('wc-edit-char-note').value = char.note;
    document.getElementById('wc-edit-char-prompt').value = char.prompt;
    wcOpenModal('wc-modal-edit-char-settings');
}

function wcUpdateCharacter() {
    const char = wcState.characters.find(c => c.id === wcState.editingCharId);
    if (!char) return;
    char.name = document.getElementById('wc-edit-char-name').value;
    char.note = document.getElementById('wc-edit-char-note').value;
    char.prompt = document.getElementById('wc-edit-char-prompt').value;
    if (wcState.tempImage && wcState.tempImageType === 'edit-char') char.avatar = wcState.tempImage;
    wcSaveData();
    wcCloseModal('wc-modal-edit-char-settings');
    document.getElementById('wc-detail-char-avatar').src = char.avatar;
    document.getElementById('wc-detail-char-name').innerText = char.name;
    document.getElementById('wc-detail-char-note').innerText = char.note || "暂无备注";
    wcRenderAll();
}

// --- WeChat Phone Sim ---
function wcOpenPhoneSim() {
    const char = wcState.characters.find(c => c.id === wcState.editingCharId);
    if (!char) return;
    const sim = document.getElementById('wc-view-phone-sim');
    sim.classList.add('active');
    const screenBg = document.getElementById('wc-phone-screen-bg');
    if (char.phoneConfig && char.phoneConfig.wallpaper) {
        screenBg.style.backgroundImage = `url(${char.phoneConfig.wallpaper})`;
    } else {
        screenBg.style.backgroundImage = 'none';
    }
    const icons = char.phoneConfig && char.phoneConfig.icons ? char.phoneConfig.icons : {};
    ['msg', 'browser', 'cart', 'settings'].forEach(id => {
        const iconEl = document.getElementById(`wc-icon-${id === 'msg' ? 'message' : id}`);
        if (icons[id]) iconEl.innerHTML = `<img src="${icons[id]}">`;
    });
    wcStartPhoneClock();
}

function wcClosePhoneSim() {
    document.getElementById('wc-view-phone-sim').classList.remove('active');
    document.getElementById('wc-phone-app-message').style.display = 'none';
    wcStopPhoneClock();
}

function wcStartPhoneClock() {
    wcUpdatePhoneClock();
    wcState.phoneClockInterval = setInterval(wcUpdatePhoneClock, 1000);
}

function wcStopPhoneClock() {
    if (wcState.phoneClockInterval) clearInterval(wcState.phoneClockInterval);
}

function wcUpdatePhoneClock() {
    const now = new Date();
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    document.getElementById('wc-sim-clock-time').innerText = `${hours}:${minutes}`;
    const days = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
    document.getElementById('wc-sim-clock-date').innerText = `${now.getMonth() + 1}月${now.getDate()}日 ${days[now.getDay()]}`;
}

function wcOpenPhoneSettings() {
    wcState.tempPhoneConfig = {};
    document.getElementById('wc-preview-phone-bg').style.display = 'none';
    document.getElementById('wc-text-phone-bg').style.display = 'block';
    ['msg', 'browser', 'cart', 'settings'].forEach(id => {
        document.getElementById(`wc-preview-icon-${id}`).style.display = 'none';
    });
    wcOpenModal('wc-modal-phone-settings');
}

function wcSavePhoneSettings() {
    const char = wcState.characters.find(c => c.id === wcState.editingCharId);
    if (!char) return;
    if (!char.phoneConfig) char.phoneConfig = {};
    if (wcState.tempPhoneConfig.wallpaper) char.phoneConfig.wallpaper = wcState.tempPhoneConfig.wallpaper;
    if (wcState.tempPhoneConfig.icons) {
        if (!char.phoneConfig.icons) char.phoneConfig.icons = {};
        Object.assign(char.phoneConfig.icons, wcState.tempPhoneConfig.icons);
    }
    wcSaveData();
    wcCloseModal('wc-modal-phone-settings');
    const screenBg = document.getElementById('wc-phone-screen-bg');
    if (char.phoneConfig.wallpaper) screenBg.style.backgroundImage = `url(${char.phoneConfig.wallpaper})`;
    const icons = char.phoneConfig.icons || {};
    ['msg', 'browser', 'cart', 'settings'].forEach(id => {
        if (icons[id]) document.getElementById(`wc-icon-${id === 'msg' ? 'message' : id}`).innerHTML = `<img src="${icons[id]}">`;
    });
}

function wcOpenPhoneApp(appName) {
    if (appName === 'message') {
        document.getElementById('wc-phone-app-message').style.display = 'flex';
        wcSwitchPhoneTab('chat');
    }
}

function wcClosePhoneApp() {
    document.getElementById('wc-phone-app-message').style.display = 'none';
}

// --- Phone App Navigation ---

function wcSwitchPhoneTab(tab) {
    wcState.phoneAppTab = tab;
    
    // 更新 Tab 样式
    document.querySelectorAll('.wc-phone-tab-item').forEach(t => t.classList.remove('active'));
    document.getElementById(`wc-phone-tab-${tab}`).classList.add('active');

    const headerLeft = document.getElementById('wc-phone-header-left');
    const headerTitle = document.getElementById('wc-phone-header-title');
    const content = document.getElementById('wc-phone-app-content');
    
    content.innerHTML = ''; // 清空内容

    if (tab === 'chat') {
        headerTitle.innerText = '微信';
        // 左上角：刷新/生成聊天 SVG
        headerLeft.innerHTML = `<div onclick="wcConfirmGenerateChats()" style="cursor: pointer; display: flex; align-items: center;"><svg class="wc-icon" style="width: 20px; height: 20px;" viewBox="0 0 24 24"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg></div>`;
        wcRenderPhoneChats(); // 渲染已保存的聊天
    } else if (tab === 'contacts') {
        headerTitle.innerText = '通讯录';
        // 左上角：生成通讯录 SVG (加号)
        headerLeft.innerHTML = `<div onclick="wcOpenPhoneContactsGenModal()" style="cursor: pointer; display: flex; align-items: center;"><svg class="wc-icon" style="width: 22px; height: 22px;" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg></div>`;
        wcRenderPhoneContacts(); // 渲染已保存的通讯录
    } else if (tab === 'me') {
        headerTitle.innerText = '我';
        headerLeft.innerHTML = '';
        wcRenderPhoneMe();
    }
}

function wcRenderPhoneMe() {
    const char = wcState.characters.find(c => c.id === wcState.editingCharId);
    const content = document.getElementById('wc-phone-app-content');
    if (char) {
        content.innerHTML = `
            <div style="background:white; padding: 30px 20px; display:flex; align-items:center; margin-bottom:10px;">
                <img src="${char.avatar}" style="width:60px; height:60px; border-radius:6px; margin-right:15px;">
                <div>
                    <div style="font-size:18px; font-weight:600; margin-bottom:5px;">${char.name}</div>
                    <div style="font-size:14px; color:#8E8E93;">微信号: wxid_${char.id}</div>
                </div>
            </div>
            <div class="wc-list-group" style="border-radius:0;">
                <div class="wc-list-item" style="background:white;"><div class="wc-item-content">支付</div></div>
                <div class="wc-list-item" style="background:white;"><div class="wc-item-content">收藏</div></div>
                <div class="wc-list-item" style="background:white;"><div class="wc-item-content">朋友圈</div></div>
                <div class="wc-list-item" style="background:white;"><div class="wc-item-content">设置</div></div>
            </div>
        `;
    }
}

// --- Phone Message Logic ---

function wcConfirmGenerateChats() {
    if (confirm("重新生成聊天列表将覆盖当前手机内的所有模拟对话记录，确定要继续吗？")) {
        wcGeneratePhoneChats();
    }
}

async function wcGeneratePhoneChats() {
    const char = wcState.characters.find(c => c.id === wcState.editingCharId);
    if (!char) return;
    
    // 依赖检查：必须先有通讯录
    if (!char.phoneData || !char.phoneData.contacts || char.phoneData.contacts.length === 0) {
        alert("请先生成通讯录！聊天记录需要基于通讯录好友生成。");
        return;
    }

    const apiConfig = await idb.get('ios_theme_api_config');
    if (!apiConfig || !apiConfig.key) return alert("请先配置 API");

    const contentDiv = document.getElementById('wc-phone-app-content');
    contentDiv.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">正在连接网络生成对话数据...<br>(可能需要几十秒，请耐心等待)</div>';

    try {
        // 获取最近的聊天上下文
        const msgs = wcState.chats[char.id] || [];
        const recentMsgs = msgs.slice(-20).map(m => `${m.sender==='me'?'User':char.name}: ${m.content}`).join('\n');
        
        // 获取现有通讯录名单
        const contactNames = char.phoneData.contacts.map(c => `${c.name} (${c.desc})`).join(', ');

        // 构建 Prompt：一次性生成列表和历史
        let prompt = `你扮演角色：${char.name}。\n`;
        prompt += `人设：${char.prompt}\n`;
        prompt += `请生成你的微信消息列表。除了和用户(User)的对话外，还需要生成 3-5 个其他对话。\n`;
        prompt += `【重要】：必须基于现有的通讯录好友生成对话，不要凭空捏造新人物。\n`;
        prompt += `【通讯录名单】：${contactNames}\n`;
        prompt += `【要求】：对于每个对话，必须生成最近的 3-5 条具体聊天记录(history)。\n`;
        prompt += `【格式要求】：返回一个纯 JSON 数组，不要 Markdown。格式如下：\n`;
        prompt += `[
  {
    "id": 1,
    "name": "User",
    "lastMsg": "最后一条消息内容",
    "time": "12:00",
    "isGroup": false,
    "history": [ {"sender": "them", "content": "你好"}, {"sender": "me", "content": "你好呀"} ]
  },
  {
    "id": 2,
    "name": "通讯录中的某人",
    "lastMsg": "明天集合",
    "time": "11:30",
    "isGroup": false,
    "history": [ {"sender": "them", "content": "明天几点？"}, {"sender": "me", "content": "早上8点"} ]
  }
]\n`;
        prompt += `注意：history 中的 sender 为 "me" 代表你(${char.name})，"them" 代表对方。\n`;
        prompt += `【最近与User的聊天参考】：\n${recentMsgs}`;

        const response = await fetch(`${apiConfig.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiConfig.key}` },
            body: JSON.stringify({
                model: apiConfig.model,
                messages: [{ role: "user", content: prompt }],
                temperature: 0.7
            })
        });

        const data = await response.json();
        let content = data.choices[0].message.content;
        content = content.replace(/```json/g, '').replace(/```/g, '').trim();
        const chatList = JSON.parse(content);

        // 保存数据到 char.phoneData
        if (!char.phoneData) char.phoneData = {};
        char.phoneData.chats = chatList;
        wcSaveData();

        wcRenderPhoneChats();

    } catch (e) {
        console.error(e);
        contentDiv.innerHTML = '<div style="padding:20px;text-align:center;color:red;">生成失败，请重试。</div>';
    }
}

function wcRenderPhoneChats() {
    const char = wcState.characters.find(c => c.id === wcState.editingCharId);
    const contentDiv = document.getElementById('wc-phone-app-content');
    contentDiv.innerHTML = '';

    if (!char || !char.phoneData || !char.phoneData.chats || char.phoneData.chats.length === 0) {
        contentDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #999; font-size: 13px;">点击左上角刷新按钮<br>生成 AI 视角的聊天列表</div>';
        return;
    }

    char.phoneData.chats.forEach(chat => {
        const div = document.createElement('div');
        div.className = 'wc-list-item';
        div.style.background = 'white';
        div.style.borderBottom = '0.5px solid #E5E5EA';
        
        const isUser = chat.name === 'User';
        let imgHtml = '';
        if (isUser) {
            imgHtml = `<img src="${wcState.user.avatar}" class="wc-avatar" style="width:40px;height:40px;border-radius:4px;">`;
        } else {
            // 随机颜色头像
            const color = '#' + ((chat.name.length * 1234567) % 16777215).toString(16).padStart(6, '0');
            imgHtml = `<div style="width:40px;height:40px;border-radius:4px;background:${color};display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:16px;">${chat.name[0]}</div>`;
        }

        div.innerHTML = `
            ${imgHtml}
            <div class="wc-item-content" style="margin-left:10px;">
                <div style="display:flex;justify-content:space-between;">
                    <div class="wc-item-title" style="font-size:15px;font-weight:500;">${chat.name}</div>
                    <div style="font-size:11px;color:#B2B2B2;">${chat.time}</div>
                </div>
                <div class="wc-item-subtitle" style="font-size:13px;color:#8E8E93;">${chat.lastMsg}</div>
            </div>
        `;
        
        div.onclick = () => wcOpenSimChatDetailSaved(chat);
        contentDiv.appendChild(div);
    });
}

function wcOpenSimChatDetailSaved(chatItem) {
    wcActiveSimChatId = chatItem.id; // 记录当前 ID
    const detailView = document.getElementById('wc-phone-sim-chat-detail');
    const titleEl = document.getElementById('wc-sim-chat-title');
    const footer = document.getElementById('wc-sim-chat-footer');
    
    detailView.style.display = 'flex';
    titleEl.innerText = chatItem.name;
    
    // 如果是 User，隐藏底部输入框（因为这是真实聊天，不应该在这里模拟）
    if (chatItem.name === 'User') {
        if(footer) footer.style.display = 'none';
        const char = wcState.characters.find(c => c.id === wcState.editingCharId);
        const realMsgs = wcState.chats[char.id] || [];
        // 转换真实消息格式
        const realHistory = realMsgs.slice(-15).map(m => ({
            sender: m.sender === 'me' ? 'them' : 'me', 
            content: m.content
        }));
        renderSimHistory(realHistory);
    } else {
        if(footer) footer.style.display = 'flex';
        renderSimHistory(chatItem.history || []);
    }
}

function wcCloseSimChatDetail() {
    document.getElementById('wc-phone-sim-chat-detail').style.display = 'none';
    wcActiveSimChatId = null;
}

// 1. 替身发送消息 (用户扮演 Char 发送给 NPC)
function wcSimSendMsg() {
    const input = document.getElementById('wc-sim-chat-input');
    const text = input.value.trim();
    if (!text) return;
    
    const char = wcState.characters.find(c => c.id === wcState.editingCharId);
    if (!char || !char.phoneData || !char.phoneData.chats) return;
    
    const chat = char.phoneData.chats.find(c => c.id === wcActiveSimChatId);
    if (!chat) return;
    
    if (!chat.history) chat.history = [];
    
    // 在模拟器里，'me' 是 Char (手机主人)
    chat.history.push({ sender: 'me', content: text });
    chat.lastMsg = text;
    chat.time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    wcSaveData();
    renderSimHistory(chat.history);
    wcRenderPhoneChats(); // 更新列表预览
    input.value = '';
}

// 2. 触发 NPC 回复 (AI 扮演 NPC 回复 Char)
async function wcSimTriggerAI() {
    const char = wcState.characters.find(c => c.id === wcState.editingCharId);
    if (!char || !char.phoneData || !char.phoneData.chats) return;
    
    const chat = char.phoneData.chats.find(c => c.id === wcActiveSimChatId);
    if (!chat) return;

    const apiConfig = await idb.get('ios_theme_api_config');
    if (!apiConfig || !apiConfig.key) return alert("请配置 API");

    const btn = document.querySelector('#wc-sim-chat-footer button:last-child');
    const originalText = btn.innerText;
    btn.innerText = "...";
    btn.disabled = true;

    try {
        // 构建 Prompt
        // 这里的逻辑反转了：AI 扮演 NPC，User 扮演 Char
        let prompt = `你现在扮演角色：${chat.name}。\n`;
        prompt += `背景/关系：${chat.desc || '普通朋友'}\n`;
        prompt += `你正在和 ${char.name} (由用户扮演) 进行微信聊天。\n`;
        prompt += `请根据聊天记录回复 ${char.name} 的消息。\n`;
        
        // 注入严格的回复格式要求
        prompt += `【回复格式严格要求】：
1. 必须模拟即时通讯软件的聊天风格。
2. 保持回复简短有力，禁止长篇大论的小说体。
3. 强制要求：频繁使用换行符。绝对禁止将所有对话合并在同一段落中。
4. 结构：每一句对话必须独占一行。
5. 禁止发送长文本或小说式的段落。
6. 必须模拟真实人类的打字习惯：将一长段话拆分成多条短消息发送。
7. 严禁使用逗号将多个独立的句子强行连接成一句长句。
8. 风格：口语化、碎片化，像是在用手机打字。\n`;

        prompt += `【聊天记录】：\n`;
        
        const recentHistory = (chat.history || []).slice(-10);
        recentHistory.forEach(h => {
            const speaker = h.sender === 'me' ? char.name : chat.name;
            prompt += `${speaker}: ${h.content}\n`;
        });
        
        prompt += `${chat.name}:`; // 引导补全

        const response = await fetch(`${apiConfig.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiConfig.key}` },
            body: JSON.stringify({
                model: apiConfig.model,
                messages: [{ role: "user", content: prompt }],
                temperature: 0.8
            })
        });

        const data = await response.json();
        const reply = data.choices[0].message.content.trim();

        // 在模拟器里，'them' 是 NPC
        if (!chat.history) chat.history = [];
        chat.history.push({ sender: 'them', content: reply });
        chat.lastMsg = reply;
        chat.time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        wcSaveData();
        renderSimHistory(chat.history);
        wcRenderPhoneChats();

    } catch (e) {
        console.error(e);
        alert("AI 回复失败");
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
}

function renderSimHistory(history) {
    const container = document.getElementById('wc-sim-chat-history');
    container.innerHTML = '';
    
    history.forEach(msg => {
        // 在对方手机里：sender='me' 是对方(Char)，显示在右边(绿色)
        // sender='them' 是别人，显示在左边(白色)
        const isMe = msg.sender === 'me'; 
        
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.flexDirection = isMe ? 'row-reverse' : 'row';
        row.style.marginBottom = '10px';
        row.style.alignItems = 'flex-start';

        const bubble = document.createElement('div');
        bubble.style.maxWidth = '70%';
        bubble.style.padding = '8px 12px';
        bubble.style.borderRadius = '8px';
        bubble.style.fontSize = '14px';
        bubble.style.lineHeight = '1.4';
        bubble.style.wordBreak = 'break-word';
        
        if (isMe) {
            bubble.style.background = '#95EC69';
            bubble.style.color = 'black';
            bubble.style.marginRight = '5px';
        } else {
            bubble.style.background = 'white';
            bubble.style.color = 'black';
            bubble.style.marginLeft = '5px';
        }
        
        bubble.innerText = msg.content;
        
        const avatar = document.createElement('div');
        avatar.style.width = '30px';
        avatar.style.height = '30px';
        avatar.style.borderRadius = '4px';
        avatar.style.background = isMe ? '#ddd' : '#ccc';
        avatar.style.flexShrink = '0';
        
        row.appendChild(avatar);
        row.appendChild(bubble);
        container.appendChild(row);
    });
    setTimeout(() => { container.scrollTop = container.scrollHeight; }, 50);
}

// --- Phone Contacts Logic ---

function wcOpenPhoneContactsGenModal() {
    wcOpenModal('wc-modal-gen-contacts');
}

async function wcGeneratePhoneContacts() {
    const min = parseInt(document.getElementById('wc-gen-contact-min').value) || 3;
    const max = parseInt(document.getElementById('wc-gen-contact-max').value) || 8;
    const char = wcState.characters.find(c => c.id === wcState.editingCharId);
    if (!char) return;

    const apiConfig = await idb.get('ios_theme_api_config');
    if (!apiConfig || !apiConfig.key) return alert("请先配置 API");

    const btn = document.querySelector('#wc-modal-gen-contacts .wc-btn-primary');
    const originalText = btn.innerText;
    btn.innerText = "生成中...";
    btn.disabled = true;

    try {
        // 获取用户在当前聊天中的设定
        const chatConfig = char.chatConfig || {};
        const userName = chatConfig.userName || wcState.user.name;
        const userPersona = chatConfig.userPersona || wcState.user.persona || "无";

        let wbInfo = "";
        if (worldbookEntries.length > 0) {
            wbInfo = "【世界观参考】:\n" + worldbookEntries.slice(0, 10).map(e => `${e.title}: ${e.desc}`).join('\n');
        }

        let prompt = `你扮演角色：${char.name}。\n`;
        prompt += `人设：${char.prompt}\n${wbInfo}\n`;
        prompt += `【重要：用户身份】\n用户(User)的名字是：${userName}。\n用户在你的生活中的角色/人设是：${userPersona}。\n`;
        prompt += `【严重警告】：用户(User)也是通讯录的一部分。如果用户的设定是“恋人”，绝对不要再生成另一个“恋人/男(女)朋友/老公/老婆”！\n`;
        prompt += `【绝对禁令】：\n1. 严禁生成与用户(User)角色冲突的NPC。\n2. 如果用户是你的亲人，不要生成重复的亲人角色。\n`;
        
        prompt += `请生成你的微信通讯录数据。总人数在 ${min} 到 ${max} 之间。\n`;
        prompt += `【要求】：\n`;
        prompt += `1. 生成两部分数据：'contacts'(已添加的好友/群) 和 'requests'(待验证的好友请求)。\n`;
        prompt += `2. 'requests' 应该有 1-2 个，或者没有。\n`;
        prompt += `3. 每个人物必须包含 'desc' (一句话概括来历/关系)。\n`;
        prompt += `4. 返回纯 JSON 对象，格式如下：\n`;
        prompt += `{
  "contacts": [
    {"name": "张三", "type": "friend", "desc": "童年玩伴"},
    {"name": "冒险团", "type": "group", "desc": "工作群"}
  ],
  "requests": [
    {"name": "神秘人", "desc": "在酒馆遇到的陌生人"}
  ]
}\n`;

        const response = await fetch(`${apiConfig.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiConfig.key}` },
            body: JSON.stringify({
                model: apiConfig.model,
                messages: [{ role: "user", content: prompt }],
                temperature: 0.8
            })
        });

        const data = await response.json();
        let content = data.choices[0].message.content;
        content = content.replace(/```json/g, '').replace(/```/g, '').trim();
        const result = JSON.parse(content);

        // 初始化数据结构
        if (!char.phoneData) char.phoneData = {};
        
        // 为新数据添加 ID
        const newContacts = (result.contacts || []).map(c => ({ ...c, id: Date.now() + Math.random() }));
        const newRequests = (result.requests || []).map(r => ({ ...r, id: Date.now() + Math.random(), status: 'pending' }));

        // 合并或覆盖 (这里选择覆盖旧的生成数据，保留 User)
        char.phoneData.contacts = newContacts;
        char.phoneData.friendRequests = newRequests;

        wcSaveData();
        wcCloseModal('wc-modal-gen-contacts');
        wcRenderPhoneContacts();

    } catch (e) {
        console.error(e);
        alert("生成失败，请检查 API 配置");
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
}

function wcRenderPhoneContacts() {
    const char = wcState.characters.find(c => c.id === wcState.editingCharId);
    const contentDiv = document.getElementById('wc-phone-app-content');
    contentDiv.innerHTML = '';

    if (!char || !char.phoneData) {
        contentDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #999; font-size: 13px;">点击左上角 + 号<br>生成通讯录</div>';
        return;
    }

    // 1. 渲染新的朋友 (Requests)
    if (char.phoneData.friendRequests && char.phoneData.friendRequests.length > 0) {
        const header = document.createElement('div');
        header.className = 'wc-list-group-title';
        header.innerText = '新的朋友';
        contentDiv.appendChild(header);

        char.phoneData.friendRequests.forEach(req => {
            const div = document.createElement('div');
            div.className = 'wc-list-item';
            div.style.background = 'white';
            
            const color = '#' + ((req.name.length * 99999) % 16777215).toString(16).padStart(6, '0');
            
            div.innerHTML = `
                <div style="width:36px;height:36px;border-radius:4px;background:${color};display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;">${req.name[0]}</div>
                <div class="wc-item-content" style="margin-left:10px;">
                    <div class="wc-item-title">${req.name}</div>
                    <div class="wc-item-subtitle" style="font-size:12px;">${req.desc}</div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="wc-btn-mini" style="background:#07C160; color:white; border:none; padding:4px 8px; border-radius:4px; font-size:12px;" onclick="wcHandleFriendRequest('${req.id}', 'accept')">接受</button>
                    <button class="wc-btn-mini" style="background:#FA5151; color:white; border:none; padding:4px 8px; border-radius:4px; font-size:12px;" onclick="wcHandleFriendRequest('${req.id}', 'reject')">拒绝</button>
                </div>
            `;
            contentDiv.appendChild(div);
        });
    }

    // 2. 渲染联系人列表
    const header2 = document.createElement('div');
    header2.className = 'wc-list-group-title';
    header2.innerText = '联系人';
    contentDiv.appendChild(header2);

    const contacts = char.phoneData.contacts || [];
    contacts.forEach(contact => {
        const div = document.createElement('div');
        div.className = 'wc-list-item';
        div.style.background = 'white';
        div.style.borderBottom = '0.5px solid #E5E5EA';
        
        const color = '#' + ((contact.name.length * 12345) % 16777215).toString(16).padStart(6, '0');
        
        div.innerHTML = `
            <div style="width:36px;height:36px;border-radius:4px;background:${color};display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;">${contact.name[0]}</div>
            <div class="wc-item-content" style="margin-left:10px;">
                <div class="wc-item-title">${contact.name}</div>
                <div class="wc-item-subtitle" style="font-size:12px; color:#999;">${contact.type === 'group' ? '[群聊]' : ''} ${contact.desc}</div>
            </div>
        `;
        div.onclick = () => wcShowPhoneContactDetail(contact);
        contentDiv.appendChild(div);
    });
}

// 处理好友请求
function wcHandleFriendRequest(reqId, action) {
    const char = wcState.characters.find(c => c.id === wcState.editingCharId);
    if (!char) return;

    const reqIndex = char.phoneData.friendRequests.findIndex(r => r.id == reqId);
    if (reqIndex === -1) return;
    const req = char.phoneData.friendRequests[reqIndex];

    if (action === 'accept') {
        // 移入联系人
        if (!char.phoneData.contacts) char.phoneData.contacts = [];
        char.phoneData.contacts.push({
            id: req.id,
            name: req.name,
            desc: req.desc,
            type: 'friend'
        });
        // 插入隐形系统提示到主聊天 (hidden: true)
        wcAddMessage(char.id, 'system', 'system', `[系统提示] 你(User)操作了对方的手机，通过了 "${req.name}" 的好友请求。`, { style: 'transparent', hidden: true });
    } else {
        wcAddMessage(char.id, 'system', 'system', `[系统提示] 你(User)操作了对方的手机，拒绝了 "${req.name}" 的好友请求。`, { style: 'transparent', hidden: true });
    }

    // 移除请求
    char.phoneData.friendRequests.splice(reqIndex, 1);
    wcSaveData();
    wcRenderPhoneContacts();
}

// 显示联系人详情卡片
function wcShowPhoneContactDetail(contact) {
    currentPhoneContact = contact;
    document.getElementById('wc-card-contact-name').innerText = contact.name;
    document.getElementById('wc-card-contact-desc').innerText = contact.desc || "暂无介绍";
    
    const color = '#' + ((contact.name.length * 12345) % 16777215).toString(16).padStart(6, '0');
    const avatarEl = document.getElementById('wc-card-contact-avatar');
    avatarEl.style.background = color;
    avatarEl.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:white;font-size:32px;font-weight:bold;">${contact.name[0]}</div>`;
    
    // 强制显示为 Flex 居中 (防止被之前的样式覆盖)
    const modal = document.getElementById('wc-modal-phone-contact-card');
    modal.style.display = 'flex'; 
    wcOpenModal('wc-modal-phone-contact-card');
}

// 删除联系人
function wcDeletePhoneContact() {
    if (!currentPhoneContact) return;
    if (confirm(`确定要删除好友 "${currentPhoneContact.name}" 吗？`)) {
        const char = wcState.characters.find(c => c.id === wcState.editingCharId);
        char.phoneData.contacts = char.phoneData.contacts.filter(c => c.id !== currentPhoneContact.id);
        
        // 隐形系统消息
        wcAddMessage(char.id, 'system', 'system', `[系统提示] 你(User)操作了对方的手机，删除了好友 "${currentPhoneContact.name}"。`, { style: 'transparent', hidden: true });
        
        wcSaveData();
        wcCloseModal('wc-modal-phone-contact-card');
        wcRenderPhoneContacts();
    }
}

// 分享联系人到主列表 (实体化)
function wcShareContactToMain() {
    if (!currentPhoneContact) return;
    
    const name = currentPhoneContact.name;
    const desc = currentPhoneContact.desc;
    
    // 生成默认头像
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="#576B95"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="white" font-size="40">${name[0]}</text></svg>`;
    const avatar = 'data:image/svg+xml;base64,' + window.btoa(unescape(encodeURIComponent(svg)));

    const newChar = {
        id: Date.now(),
        name: name,
        note: name,
        prompt: `你扮演 ${name}。背景设定：${desc}。`,
        avatar: avatar,
        isPinned: false
    };
    
    wcState.characters.push(newChar);
    wcSaveData();
    
    const char = wcState.characters.find(c => c.id === wcState.editingCharId);
    // 隐形系统消息
    wcAddMessage(char.id, 'system', 'system', `[系统提示] 你将 "${name}" 添加到了你的联系人列表。`, { style: 'transparent', hidden: true });
    
    wcCloseModal('wc-modal-phone-contact-card');
    alert(`已将 ${name} 添加到主聊天列表！`);
    
    // 刷新主列表 (虽然现在在手机视图里看不到，但退出后会看到)
    wcRenderAll();
}

// 打开分享选择弹窗
function wcOpenShareCardModal() {
    const list = document.getElementById('wc-share-card-list');
    list.innerHTML = '';
    
    // 列出主列表中的所有角色 (除了当前正在编辑的角色自己)
    const targets = wcState.characters.filter(c => c.id !== wcState.editingCharId);
    
    if (targets.length === 0) {
        list.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">没有其他好友可分享</div>';
    } else {
        targets.forEach(t => {
            const div = document.createElement('div');
            div.className = 'wc-list-item';
            div.style.background = 'white';
            div.innerHTML = `
                <img src="${t.avatar}" class="wc-avatar" style="width:36px;height:36px;">
                <div class="wc-item-content"><div class="wc-item-title">${t.name}</div></div>
                <button class="wc-btn-mini" style="background:#07C160; color:white; border:none; padding:6px 12px; border-radius:4px;" onclick="wcConfirmShareCard(${t.id})">发送</button>
            `;
            list.appendChild(div);
        });
    }
    
    wcOpenModal('wc-modal-share-card-select');
}

// 确认分享名片
function wcConfirmShareCard(targetCharId) {
    if (!currentPhoneContact) return;
    
    const targetChar = wcState.characters.find(c => c.id === targetCharId);
    
    if (targetChar) {
        // 构建名片消息内容
        const cardContent = `[名片] 姓名: ${currentPhoneContact.name} | 介绍: ${currentPhoneContact.desc}`;
        
        wcAddMessage(targetCharId, 'me', 'text', cardContent);
        
        alert(`已将 ${currentPhoneContact.name} 的名片发送给 ${targetChar.name}`);
        wcCloseModal('wc-modal-share-card-select');
    }
}

// --- WeChat Chat Settings ---
function wcOpenChatSettings() {
    const char = wcState.characters.find(c => c.id === wcState.activeChatId);
    if (!char) return;
    if (!char.chatConfig) char.chatConfig = { userAvatar: wcState.user.avatar, userName: wcState.user.name, userPersona: wcState.user.persona, contextLimit: 0, summaryTrigger: 0, stickerGroupIds: [], backgroundImage: "", customCss: "", worldbookEntries: [] };
    
    document.getElementById('wc-setting-char-avatar').src = char.avatar;
    document.getElementById('wc-setting-char-name').value = char.name;
    document.getElementById('wc-setting-char-note').value = char.note || "";
    document.getElementById('wc-setting-char-prompt').value = char.prompt || "";
    document.getElementById('wc-setting-user-avatar').src = char.chatConfig.userAvatar || wcState.user.avatar;
    document.getElementById('wc-setting-user-name').value = char.chatConfig.userName || wcState.user.name;
    document.getElementById('wc-setting-user-prompt').value = char.chatConfig.userPersona || wcState.user.persona;
    
    const maskSelect = document.getElementById('wc-setting-user-mask-select');
    maskSelect.innerHTML = '<option value="">选择面具...</option>';
    wcState.masks.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.innerText = m.name;
        maskSelect.appendChild(opt);
    });

    document.getElementById('wc-setting-context-limit').value = char.chatConfig.contextLimit || 0;
    document.getElementById('wc-setting-summary-trigger').value = char.chatConfig.summaryTrigger || 0;
    
    // 渲染世界书多选列表
    const wbList = document.getElementById('wc-setting-worldbook-list');
    wbList.innerHTML = '';
    if (worldbookEntries.length === 0) {
        wbList.innerHTML = '<div style="color:#999; font-size:13px;">暂无世界书条目</div>';
    } else {
        worldbookEntries.forEach(entry => {
            const div = document.createElement('div');
            div.className = 'wc-checkbox-item';
            const isChecked = char.chatConfig.worldbookEntries && char.chatConfig.worldbookEntries.includes(entry.id.toString());
            div.innerHTML = `<input type="checkbox" value="${entry.id}" ${isChecked ? 'checked' : ''}><span>${entry.title} (${entry.type})</span>`;
            wbList.appendChild(div);
        });
    }

    // 渲染表情包多选列表
    const stickerList = document.getElementById('wc-setting-sticker-group-list');
    stickerList.innerHTML = '';
    wcState.stickerCategories.forEach((cat, idx) => {
        const div = document.createElement('div');
        div.className = 'wc-checkbox-item';
        const isChecked = char.chatConfig.stickerGroupIds && char.chatConfig.stickerGroupIds.includes(idx);
        div.innerHTML = `<input type="checkbox" value="${idx}" ${isChecked ? 'checked' : ''}><span>${cat.name}</span>`;
        stickerList.appendChild(div);
    });

    const bgPreview = document.getElementById('wc-setting-bg-preview');
    if (char.chatConfig.backgroundImage) {
        bgPreview.src = char.chatConfig.backgroundImage;
        bgPreview.style.display = 'block';
        document.getElementById('wc-setting-bg-text').style.display = 'none';
    } else {
        bgPreview.style.display = 'none';
        document.getElementById('wc-setting-bg-text').style.display = 'block';
    }
    document.getElementById('wc-setting-custom-css').value = char.chatConfig.customCss || "";
    wcUpdateCssPresetSelect();
    wcState.tempImage = '';
    wcOpenModal('wc-modal-chat-settings');
}

function wcImportMaskToChat(maskId) {
    if (!maskId) return;
    const mask = wcState.masks.find(m => m.id == maskId);
    if (mask) {
        document.getElementById('wc-setting-user-name').value = mask.name;
        document.getElementById('wc-setting-user-prompt').value = mask.prompt;
        document.getElementById('wc-setting-user-avatar').src = mask.avatar;
    }
}

function wcClearChatBackground() {
    document.getElementById('wc-setting-bg-preview').src = "";
    document.getElementById('wc-setting-bg-preview').style.display = 'none';
    document.getElementById('wc-setting-bg-text').style.display = 'block';
    wcState.tempBgCleared = true;
}

function wcSaveChatSettings() {
    const char = wcState.characters.find(c => c.id === wcState.activeChatId);
    if (!char) return;
    char.name = document.getElementById('wc-setting-char-name').value;
    char.note = document.getElementById('wc-setting-char-note').value;
    char.prompt = document.getElementById('wc-setting-char-prompt').value;
    if (wcState.tempImage && wcState.tempImageType === 'setting-char') char.avatar = wcState.tempImage;

    if (!char.chatConfig) char.chatConfig = {};
    char.chatConfig.userName = document.getElementById('wc-setting-user-name').value;
    char.chatConfig.userPersona = document.getElementById('wc-setting-user-prompt').value;
    if (wcState.tempImage && wcState.tempImageType === 'setting-user') char.chatConfig.userAvatar = wcState.tempImage;
    else if (document.getElementById('wc-setting-user-avatar').src.startsWith('data:')) char.chatConfig.userAvatar = document.getElementById('wc-setting-user-avatar').src;

    char.chatConfig.contextLimit = parseInt(document.getElementById('wc-setting-context-limit').value) || 0;
    char.chatConfig.summaryTrigger = parseInt(document.getElementById('wc-setting-summary-trigger').value) || 0;
    
    // 保存世界书多选
    const wbCheckboxes = document.querySelectorAll('#wc-setting-worldbook-list input[type="checkbox"]:checked');
    char.chatConfig.worldbookEntries = Array.from(wbCheckboxes).map(cb => cb.value);

    // 保存表情包多选
    const stickerCheckboxes = document.querySelectorAll('#wc-setting-sticker-group-list input[type="checkbox"]:checked');
    char.chatConfig.stickerGroupIds = Array.from(stickerCheckboxes).map(cb => parseInt(cb.value));

    if (wcState.tempImage && wcState.tempImageType === 'setting-bg') char.chatConfig.backgroundImage = wcState.tempImage;
    else if (wcState.tempBgCleared) char.chatConfig.backgroundImage = "";
    wcState.tempBgCleared = false;

    char.chatConfig.customCss = document.getElementById('wc-setting-custom-css').value;
    wcSaveData();
    document.getElementById('wc-nav-title').innerText = char.note || char.name;
    wcApplyChatConfig(char);
    wcRenderMessages(char.id);
    
    // 刷新表情包面板 (如果当前选中的分组不在新配置中，重置为0)
    if (char.chatConfig.stickerGroupIds.length > 0 && !char.chatConfig.stickerGroupIds.includes(wcState.activeStickerCategoryIndex)) {
        wcState.activeStickerCategoryIndex = char.chatConfig.stickerGroupIds[0];
    } else if (char.chatConfig.stickerGroupIds.length === 0) {
        wcState.activeStickerCategoryIndex = 0;
    }
    
    wcRenderStickerPanel();
    wcCloseModal('wc-modal-chat-settings');
}

function wcClearChatHistory() {
    if (confirm("确定清空与该角色的所有聊天记录吗？此操作不可恢复。")) {
        wcState.chats[wcState.activeChatId] = [];
        wcSaveData();
        wcRenderMessages(wcState.activeChatId);
        wcCloseModal('wc-modal-chat-settings');
    }
}

// --- WeChat CSS Presets ---
function wcUpdateCssPresetSelect() {
    const select = document.getElementById('wc-setting-css-preset-select');
    select.innerHTML = '<option value="">选择预设...</option>';
    wcState.cssPresets.forEach((p, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.innerText = p.name;
        select.appendChild(opt);
    });
}

function wcSaveCssPreset() {
    const css = document.getElementById('wc-setting-custom-css').value;
    if (!css) return alert("CSS 内容为空");
    const name = prompt("请输入预设名称：");
    if (name) {
        wcState.cssPresets.push({ name, css });
        wcSaveData();
        wcUpdateCssPresetSelect();
        alert("预设已保存");
    }
}

function wcApplyCssPreset(idx) {
    if (idx === "") return;
    const preset = wcState.cssPresets[idx];
    if (preset) document.getElementById('wc-setting-custom-css').value = preset.css;
}

// --- WeChat Masks ---
function wcOpenMasksModal() { wcOpenModal('wc-modal-masks'); wcRenderMasks(); }
function wcRenderMasks() {
    const list = document.getElementById('wc-masks-list');
    list.innerHTML = '';
    wcState.masks.forEach(mask => {
        const div = document.createElement('div');
        div.className = 'wc-list-item';
        div.innerHTML = `<img src="${mask.avatar}" class="wc-avatar"><div class="wc-item-content"><div class="wc-item-title">${mask.name}</div><div class="wc-item-subtitle">${mask.prompt.substring(0, 20)}...</div></div><button class="wc-nav-btn" style="margin-right:10px" onclick="wcApplyMask(${mask.id})">使用</button><button class="wc-nav-btn" style="color:red" onclick="wcDeleteMask(${mask.id})">删除</button>`;
        div.onclick = (e) => { if(e.target.tagName !== 'BUTTON') wcOpenEditMask(mask.id); };
        list.appendChild(div);
    });
}
function wcOpenEditMask(id = null) {
    wcState.editingMaskId = id;
    wcState.tempImage = '';
    if (id) {
        const mask = wcState.masks.find(m => m.id === id);
        document.getElementById('wc-mask-modal-title').innerText = '编辑面具';
        document.getElementById('wc-input-mask-name').value = mask.name;
        document.getElementById('wc-input-mask-prompt').value = mask.prompt;
        document.getElementById('wc-preview-mask-avatar').src = mask.avatar;
    } else {
        document.getElementById('wc-mask-modal-title').innerText = '新建面具';
        document.getElementById('wc-input-mask-name').value = '';
        document.getElementById('wc-input-mask-prompt').value = '';
        document.getElementById('wc-preview-mask-avatar').src = '';
    }
    wcOpenModal('wc-modal-edit-mask');
}
function wcSaveMask() {
    const name = document.getElementById('wc-input-mask-name').value;
    const prompt = document.getElementById('wc-input-mask-prompt').value;
    const avatar = wcState.tempImage || (wcState.editingMaskId ? wcState.masks.find(m=>m.id===wcState.editingMaskId).avatar : wcState.user.avatar);
    if (!name) return alert('请输入名称');
    if (wcState.editingMaskId) {
        const mask = wcState.masks.find(m => m.id === wcState.editingMaskId);
        mask.name = name; mask.prompt = prompt; mask.avatar = avatar;
    } else {
        wcState.masks.push({ id: Date.now(), name, prompt, avatar });
    }
    wcSaveData();
    wcCloseModal('wc-modal-edit-mask');
    wcRenderMasks();
}
function wcDeleteMask(id) {
    if(confirm('删除此面具？')) { wcState.masks = wcState.masks.filter(m => m.id !== id); wcSaveData(); wcRenderMasks(); }
}
function wcApplyMask(id) {
    const mask = wcState.masks.find(m => m.id === id);
    if (mask) {
        wcState.user.name = mask.name; wcState.user.avatar = mask.avatar; wcState.user.persona = mask.prompt;
        wcSaveData(); wcRenderUser(); wcCloseModal('wc-modal-masks'); alert(`已切换身份为：${mask.name}`);
    }
}

// --- WeChat Modals ---
function wcOpenModal(id) {
    const modal = document.getElementById(id);
    modal.classList.remove('hidden');
    modal.classList.add('active'); 
    wcState.tempImage = ''; 
    if(id === 'wc-modal-add-char') {
        document.getElementById('wc-preview-char-avatar').style.display = 'none';
        document.getElementById('wc-icon-char-upload').style.display = 'block';
    }
}

function wcCloseModal(id) {
    const modal = document.getElementById(id);
    modal.classList.add('hidden');
    modal.classList.remove('active');
}

function wcToggleMomentType(type) {
    wcState.momentType = type;
    document.getElementById('wc-seg-local').className = type === 'local' ? 'wc-segment-btn active' : 'wc-segment-btn';
    document.getElementById('wc-seg-desc').className = type === 'desc' ? 'wc-segment-btn active' : 'wc-segment-btn';
    document.getElementById('wc-area-local-img').style.display = type === 'local' ? 'block' : 'none';
    document.getElementById('wc-area-desc-img').style.display = type === 'desc' ? 'block' : 'none';
}

function wcSaveMoment() {
    const text = document.getElementById('wc-input-moment-text').value;
    let image = null; let imageDesc = null;
    if (wcState.momentType === 'local') image = wcState.tempImage; else imageDesc = document.getElementById('wc-input-moment-desc').value;
    if (!text && !image && !imageDesc) return alert('请输入内容');
    wcState.moments.unshift({ id: Date.now(), name: wcState.user.name, avatar: wcState.user.avatar, text: text, image: image, imageDesc: imageDesc, time: Date.now(), likes: [], comments: [] });
    wcSaveData();
    document.getElementById('wc-input-moment-text').value = ''; document.getElementById('wc-input-moment-desc').value = ''; wcState.tempImage = '';
    wcCloseModal('wc-modal-post-moment'); wcRenderMoments();
}

function wcDeleteMoment(id) { if(confirm('删除？')) { wcState.moments = wcState.moments.filter(m => m.id !== id); wcDb.delete('moments', id); wcSaveData(); wcRenderMoments(); } }

function wcToggleLike(id) {
    const moment = wcState.moments.find(m => m.id === id); 
    if (!moment) return;
    
    if (!moment.likes) moment.likes = [];
    const userName = wcState.user.name;
    
    if (moment.likes.includes(userName)) {
        moment.likes = moment.likes.filter(n => n !== userName); 
    } else {
        moment.likes.push(userName);
    }
    
    wcSaveData(); 
    wcRenderMoments();
}

function wcToggleCommentBox(id) { 
    const box = document.getElementById(`wc-comment-box-${id}`); 
    box.style.display = box.style.display === 'none' ? 'flex' : 'none'; 
    // 重置回复状态
    wcState.replyingToComment = null;
    const input = document.getElementById(`wc-input-comment-${id}`);
    if(input) input.placeholder = "评论...";
}

// 准备回复某人的评论
function wcPrepareReply(momentId, commentIndex, name) {
    wcState.replyingToComment = { momentId, commentIndex, name };
    const box = document.getElementById(`wc-comment-box-${momentId}`);
    box.style.display = 'flex';
    const input = document.getElementById(`wc-input-comment-${momentId}`);
    if(input) {
        input.placeholder = `回复 ${name}...`;
        input.focus();
    }
}

function wcAddComment(id) {
    const input = document.getElementById(`wc-input-comment-${id}`); 
    const text = input.value; 
    if (!text) return;
    
    const moment = wcState.moments.find(m => m.id === id); 
    if (!moment) return;
    if (!moment.comments) moment.comments = [];
    
    let commentText = text;
    // 如果是回复状态，且回复的是当前动态
    if (wcState.replyingToComment && wcState.replyingToComment.momentId === id) {
        commentText = `回复 ${wcState.replyingToComment.name}: ${text}`;
    }
    
    moment.comments.push({ name: wcState.user.name, text: commentText });
    wcSaveData(); 
    wcRenderMoments();
    
    // 重置状态
    wcState.replyingToComment = null;
    input.value = ''; // 清空输入框
}

// Swipe Logic for WeChat
let wcXDown = null; let wcYDown = null; let wcCurrentSwipeElement = null;
function wcHandleTouchStartSwipe(evt) { wcXDown = evt.touches[0].clientX; wcYDown = evt.touches[0].clientY; wcCurrentSwipeElement = evt.currentTarget; }
function wcHandleTouchMoveSwipe(evt) {
    if (!wcXDown || !wcYDown) return;
    let xUp = evt.touches[0].clientX; let yUp = evt.touches[0].clientY;
    let xDiff = wcXDown - xUp; let yDiff = wcYDown - yUp;
    if (Math.abs(xDiff) > Math.abs(yDiff)) { 
        if (xDiff > 0) {
            const offset = -80; 
            wcCurrentSwipeElement.style.transform = `translateX(${offset}px)`; 
        } else {
            wcCurrentSwipeElement.style.transform = 'translateX(0px)'; 
        }
    }
}
function wcHandleTouchEndSwipe(evt) { wcXDown = null; wcYDown = null; }
</script>
</body>
</html>
