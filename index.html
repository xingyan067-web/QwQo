<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>iOS Theme Studio</title>
    
    <!-- 强力禁止浏览器缓存 Meta 标签 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Theme Studio">
    
    <!-- 引入 Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- 设置应用图标 -->
    <link rel="apple-touch-icon" href="https://i.postimg.cc/yYrDHvG5/mmexport1766982633245.jpg">
    <link rel="icon" type="image/jpeg" href="https://i.postimg.cc/yYrDHvG5/mmexport1766982633245.jpg">

    <!-- 【关键修改】引入样式表，添加版本号 ?v=3.0 强制刷新 -->
    <link rel="stylesheet" href="style.css?v=3.0">
</head>
<body>

    <!-- 隐藏的文件输入框 -->
    <input type="file" id="widgetBgInput" class="hidden-file-input" accept="image/*" onchange="handleWidgetBgUpload(this)">
    <input type="file" id="widgetAvatarInput" class="hidden-file-input" accept="image/*" onchange="handleWidgetAvatarUpload(this)">
    <input type="file" id="appleAvatarInput" class="hidden-file-input" accept="image/*" onchange="handleAppleAvatarUpload(this)">
    
    <!-- 备份导入输入框 -->
    <input type="file" id="backupImportInput" class="hidden-file-input" accept=".json" onchange="importAllData(this)">
    <input type="file" id="themeImportInput" class="hidden-file-input" accept=".json" onchange="importThemeOnly(this)">
    <input type="file" id="wcBackupImportInput" class="hidden-file-input" accept=".json" onchange="wcImportData(this)">

    <!-- iOS 顶部通知容器 -->
    <div id="ios-notification-container"></div>

    <!-- 主屏幕 -->
    <div class="screen" id="mainScreen">
        <div class="status-bar-placeholder"></div>

        <!-- 桌面区域 -->
        <div class="home-grid" id="homeGrid">
            <!-- 小组件 -->
            <div class="widget-item" id="mainWidget" onclick="triggerWidgetBgUpload()">
                <div class="widget-overlay"></div>
                <div class="widget-left">
                    <div class="widget-avatar" id="widgetAvatar" onclick="event.stopPropagation(); triggerAvatarUpload()"></div>
                    <div class="widget-text" id="widgetText" onclick="event.stopPropagation(); editWidgetText()">点击编辑文本</div>
                </div>
                <div class="widget-right">
                    <div class="widget-time" id="widgetTime">12:00</div>
                    <div class="widget-date" id="widgetDate">2026/02/14</div>
                </div>
            </div>
            <!-- JS 生成剩余格子 -->
        </div>

        <!-- Dock 区域 -->
        <div class="dock-container">
            <div class="dock">
                <!-- App 4: Theme Studio -->
                <div class="app-item" id="app-4" onclick="openSettings()">
                    <div class="app-icon" id="icon-4">
                        <svg class="default-icon-svg" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
                    </div>
                    <div class="app-name" id="name-4" style="display:none">Theme</div>
                </div>
                
                <!-- App 5: iOS Settings -->
                <div class="app-item" id="app-5" onclick="openIOSSettings()">
                    <div class="app-icon" id="icon-5">
                        <svg class="default-icon-svg" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                    </div>
                    <div class="app-name" id="name-5" style="display:none">Settings</div>
                </div>

                <!-- App 6: Worldbook -->
                <div class="app-item" id="app-6" onclick="openWorldbook()">
                    <div class="app-icon" id="icon-6">
                        <svg class="default-icon-svg" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                    </div>
                    <div class="app-name" id="name-6" style="display:none">世界书</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Theme Studio 设置面板 -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-header">
            <div class="header-left">
                <button class="nav-btn" onclick="closeSettings()">
                    <svg class="back-svg" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </button>
            </div>
            <div class="header-title" id="headerTitle">壁纸设置</div>
            <div class="header-right">
                <button class="nav-btn" onclick="closeSettings()">完成</button>
            </div>
        </div>
        
        <div class="settings-content">
            <!-- Tab 1: 壁纸 -->
            <div id="tab-wallpaper" class="tab-content active">
                <div class="settings-title">更换壁纸</div>
                <div class="settings-group">
                    <div class="settings-row">
                        <div class="row-label">图片 URL</div>
                        <input type="text" id="bgUrlInput" placeholder="https://example.com/image.jpg">
                        <button class="action-btn" onclick="setWallpaperFromUrl()">应用并保存</button>
                    </div>
                    <div class="settings-row">
                        <div class="row-label">本地相册</div>
                        <input type="file" id="bgFileInput" accept="image/*" style="display:none">
                        <button class="action-btn secondary" onclick="document.getElementById('bgFileInput').click()">选择图片...</button>
                    </div>
                    <div class="settings-row">
                        <button class="action-btn destructive" onclick="resetWallpaper()">恢复默认壁纸</button>
                    </div>
                </div>
                <div class="settings-title">壁纸库 (点击应用)</div>
                <div class="settings-group">
                    <div class="settings-row">
                        <div class="wallpaper-grid" id="wallpaperGrid">
                            <div style="color:#999; font-size:13px; grid-column:span 3; text-align:center; padding:20px;">暂无保存的壁纸</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: 图标 -->
            <div id="tab-icons" class="tab-content">
                <div class="settings-title">图标方案管理</div>
                <div class="settings-group">
                    <div class="settings-row">
                        <button class="action-btn" type="button" onclick="openNameModal('icon')">保存当前所有图标为预设</button>
                    </div>
                    <div class="settings-row">
                        <div class="row-label">已保存方案</div>
                        <div class="preset-list" id="iconPresetList">
                            <div style="color:#999; font-size:13px; padding:5px;">暂无预设</div>
                        </div>
                    </div>
                    <div class="settings-row">
                        <button class="action-btn destructive" onclick="resetIcons()">恢复默认图标</button>
                    </div>
                </div>
                <div class="settings-title">编辑单个 APP (点击图标上传 或 输入URL)</div>
                <div class="settings-group" id="appEditorList"></div>
            </div>

            <!-- Tab 3: 字体 -->
            <div id="tab-fonts" class="tab-content">
                <div class="settings-title">全局字体设置</div>
                <div class="settings-group">
                    <div class="settings-row">
                        <div class="row-label" style="display:flex; justify-content:space-between;">
                            <span>字体大小</span>
                            <span id="fontSizeDisplay" style="color:#888; font-weight:normal;">11px</span>
                        </div>
                        <input type="range" id="fontSizeSlider" min="9" max="16" step="0.5" value="11" oninput="changeFontSize(this.value)">
                    </div>
                    <div class="settings-row">
                        <div class="row-label">字体 URL (WOFF/TTF)</div>
                        <input type="text" id="fontUrlInput" placeholder="https://.../font.woff2">
                        <button class="action-btn" onclick="applyFont()">应用字体</button>
                        <button class="action-btn secondary" onclick="openNameModal('font')">保存为预设</button>
                    </div>
                    <div class="settings-row">
                        <button class="action-btn destructive" onclick="resetFonts()">恢复默认字体</button>
                    </div>
                    <div class="settings-row" id="fontPresetsContainer" style="display:none;">
                        <div class="row-label">字体预设</div>
                        <div class="preset-list" id="fontPresetList"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-tab-bar">
            <div class="tab-item active" onclick="switchTab('wallpaper', this)">壁纸</div>
            <div class="tab-item" onclick="switchTab('icons', this)">图标</div>
            <div class="tab-item" onclick="switchTab('fonts', this)">字体</div>
        </div>
    </div>

    <!-- iOS 仿真设置页面 -->
    <div class="settings-modal" id="iosSettingsModal">
        <div class="settings-header">
            <div class="header-left">
                <button class="nav-btn" onclick="closeIOSSettings()">
                    <svg class="back-svg" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    <span>设置</span>
                </button>
            </div>
            <div class="header-title">设置</div>
            <div class="header-right"></div>
        </div>

        <div class="settings-content ios-settings-content">
            <div class="ios-search-bar">
                <input type="text" class="ios-search-input" placeholder="搜索" readonly>
            </div>

            <div class="ios-profile-card" onclick="openAppleIdSettings()">
                <div class="ios-profile-avatar" id="appleIdAvatar">A</div>
                <div class="ios-profile-info">
                    <h3 id="appleIdName">Apple ID</h3>
                    <p id="appleIdSubtext">Apple ID、iCloud、媒体与购买项目</p>
                </div>
                <svg class="chevron-right" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            </div>
             <div class="ios-list-group">
                <div class="ios-list-item" onclick="openApiSettings()">
                    <div class="ios-icon-box" style="background:#007aff"><svg viewBox="0 0 24 24"><path d="M12.01 21.49L23.64 7c-.45-.34-4.93-4-11.64-4C5.28 3 .81 6.66.36 7l11.63 14.49.01.01.01-.01z"/></svg></div>
                    <div class="ios-item-content">
                        <span class="ios-item-label">Wi-Fi</span>
                        <div class="ios-item-right">API 配置<svg class="chevron-right" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Apple ID 详细设置页面 -->
    <div class="settings-modal sub-page" id="appleIdSettingsModal">
        <div class="settings-header">
            <div class="header-left">
                <button class="nav-btn" onclick="closeAppleIdSettings()">
                    <svg class="back-svg" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    <span>设置</span>
                </button>
            </div>
            <div class="header-title">Apple ID</div>
            <div class="header-right"></div>
        </div>
        <div class="settings-content ios-settings-content">
            <div class="profile-header">
                <div class="profile-header-avatar" id="appleIdDetailAvatar" onclick="triggerAppleAvatarUpload()">
                    A
                    <div class="profile-edit-badge">编辑</div>
                </div>
                <div class="profile-header-name" id="appleIdDetailName" onclick="editAppleIdText()">Apple ID</div>
                <div class="profile-header-email">name@example.com</div>
            </div>
            <div class="settings-title">存储空间</div>
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="openStorageAnalysis()">
                    <div class="ios-item-content">
                        <span class="ios-item-label">iCloud 存储空间</span>
                        <div class="ios-item-right"><svg class="chevron-right" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></div>
                    </div>
                </div>
            </div>
            
            <!-- 新增：桌面美化备份 -->
            <div class="settings-title">桌面美化 (仅外观)</div>
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="exportThemeOnly()">
                    <div class="ios-item-content">
                        <span class="ios-item-label" style="color:var(--blue)">备份桌面美化</span>
                    </div>
                </div>
                <div class="ios-list-item" onclick="document.getElementById('themeImportInput').click()">
                    <div class="ios-item-content">
                        <span class="ios-item-label" style="color:var(--blue)">恢复桌面美化 (导入)</span>
                    </div>
                </div>
            </div>

            <div class="settings-title">完整数据管理</div>
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="exportAllData()">
                    <div class="ios-item-content">
                        <span class="ios-item-label" style="color:var(--blue)">一键备份所有数据 (含WeChat)</span>
                    </div>
                </div>
                <div class="ios-list-item" onclick="document.getElementById('backupImportInput').click()">
                    <div class="ios-item-content">
                        <span class="ios-item-label" style="color:var(--blue)">恢复所有数据 (导入)</span>
                    </div>
                </div>
            </div>
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="clearAllData()">
                    <div class="ios-item-content" style="justify-content: center;">
                        <span class="ios-item-label" style="color:var(--red); font-weight:600;">清空所有数据</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API 设置页面 -->
    <div class="settings-modal sub-page" id="apiSettingsModal">
        <div class="settings-header">
            <div class="header-left">
                <button class="nav-btn" onclick="closeApiSettings()">
                    <svg class="back-svg" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    <span>设置</span>
                </button>
            </div>
            <div class="header-title">API 配置</div>
            <div class="header-right">
                <button class="nav-btn" onclick="saveApiConfig()">保存</button>
            </div>
        </div>
        <div class="settings-content ios-settings-content">
            <div class="settings-title" style="margin-top:20px;">配置预设</div>
            <div class="ios-list-group" style="padding:10px;">
                <div class="preset-list" id="apiPresetList">
                    <div style="color:#999; font-size:13px; padding:5px;">暂无预设</div>
                </div>
                <button class="action-btn secondary" onclick="openNameModal('api')" style="margin-top:10px;">保存当前配置为预设</button>
            </div>
            <div class="settings-title">连接设置</div>
            <div class="ios-list-group" style="padding: 0 16px;">
                <div class="settings-row">
                    <div class="row-label">API 地址 (Base URL)</div>
                    <input type="text" id="apiBaseUrl" placeholder="https://api.openai.com/v1">
                    <div style="font-size:11px; color:#888; margin-top:4px;">请确保反代服务器支持 CORS (跨域访问)</div>
                </div>
                <div class="settings-row">
                    <div class="row-label">API 密钥 (Key)</div>
                    <input type="password" id="apiKey" placeholder="sk-...">
                </div>
            </div>
            <div class="settings-title">模型选择</div>
            <div class="ios-list-group" style="padding: 0 16px;">
                <div class="settings-row">
                    <button class="action-btn" onclick="fetchModels()" id="fetchBtn">拉取模型列表</button>
                </div>
                <div class="settings-row">
                    <div class="row-label">选择模型</div>
                    <select id="modelSelect" class="ios-select">
                        <option value="" disabled selected>请先拉取模型</option>
                    </select>
                </div>
            </div>
            <div class="settings-title">参数设置</div>
            <div class="ios-list-group" style="padding: 0 16px;">
                <div class="settings-row">
                    <div class="row-label" style="display:flex; justify-content:space-between;">
                        <span>温度 (Temperature)</span>
                        <span id="tempDisplay" style="color:#888;">0.7</span>
                    </div>
                    <input type="range" id="tempSlider" min="0" max="2" step="0.1" value="0.7" oninput="document.getElementById('tempDisplay').innerText = this.value">
                </div>
            </div>
        </div>
    </div>

    <!-- 世界书 (Worldbook) 主页面 -->
    <div class="settings-modal" id="worldbookModal">
        <div class="settings-header">
            <div class="header-left">
                <button class="nav-btn" onclick="closeWorldbook()">
                    <svg class="back-svg" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    <span>返回</span>
                </button>
            </div>
            <div class="header-title" id="wbHeaderTitle">所有条目</div>
            <div class="header-right">
                <button class="nav-btn" onclick="openWorldbookEditor()">
                    <svg class="svg-icon" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                </button>
            </div>
        </div>
        <div class="settings-content ios-settings-content" style="padding-bottom: 60px; overflow: hidden;">
            <div class="ios-search-bar">
                <input type="text" class="ios-search-input" placeholder="搜索条目" oninput="filterWorldbook(this.value)">
            </div>
            <div class="wb-view-container" id="wbViewContainer">
                <div class="wb-view-page" id="wbViewAll">
                    <div class="wb-list-container" id="worldbookList">
                        <div style="padding: 20px; text-align: center; color: #999;">暂无条目，点击右上角添加</div>
                    </div>
                </div>
                <div class="wb-view-page" id="wbViewGroup">
                    <div class="wb-list-container" id="worldbookGroupList"></div>
                    <div class="wb-add-group-btn" onclick="addNewGroup()">+ 添加分组</div>
                </div>
            </div>
        </div>
        <div class="settings-tab-bar">
            <div class="tab-item active" id="tab-wb-all" onclick="switchWorldbookView('all')">
                <svg class="tab-icon" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                <span class="tab-label">所有条目</span>
            </div>
            <div class="tab-item" id="tab-wb-group" onclick="switchWorldbookView('group')">
                <svg class="tab-icon" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
                <span class="tab-label">分组视图</span>
            </div>
        </div>
    </div>

    <!-- 世界书编辑器 -->
    <div class="settings-modal sub-page" id="worldbookEditorModal">
        <div class="settings-header">
            <div class="header-left">
                <button class="nav-btn" onclick="closeWorldbookEditor()">取消</button>
            </div>
            <div class="header-title" id="wbEditorTitle">新建条目</div>
            <div class="header-right">
                <button class="nav-btn" onclick="saveWorldbookEntry()">保存</button>
            </div>
        </div>
        <div class="settings-content ios-settings-content">
            <div class="settings-title">基本信息</div>
            <div class="ios-list-group" style="padding: 0 16px;">
                <div class="settings-row">
                    <div class="row-label">Title (名称)</div>
                    <input type="text" id="wbTitleInput" placeholder="例如：艾莉丝">
                </div>
                <div class="settings-row">
                    <div class="row-label">Type (分组)</div>
                    <select id="wbTypeInput" class="ios-select"></select>
                </div>
            </div>
            <div class="settings-title">触发条件</div>
            <div class="ios-list-group" style="padding: 0 16px;">
                <div class="settings-row">
                    <div class="row-label">Key (触发词，逗号分隔)</div>
                    <input type="text" id="wbKeyInput" placeholder="例如：Alice, 艾莉丝, 女主">
                </div>
            </div>
            <div class="settings-title">详细设定</div>
            <div class="ios-list-group" style="padding: 0 16px;">
                <div class="settings-row">
                    <textarea id="wbDescInput" class="ios-textarea" placeholder="在此输入详细描述..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- 通用弹窗 -->
    <div class="custom-modal-overlay" id="modalOverlay">
        <div class="custom-modal">
            <div class="modal-title" id="modalTitle">标题</div>
            <div class="modal-desc" id="modalDesc">描述文本</div>
            <div class="modal-input-container" id="modalInputContainer">
                <input type="text" id="modalInput" placeholder="请输入...">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeModal()">取消</button>
                <button class="modal-btn" id="modalConfirmBtn" onclick="">确定</button>
            </div>
        </div>
    </div>

    <!-- 存储分析弹窗 -->
    <div class="custom-modal-overlay" id="storageModalOverlay">
        <div class="custom-modal" style="width: 320px; padding-bottom: 0;">
            <div class="modal-title">存储空间</div>
            <div class="storage-chart-container">
                <div class="chart-wrapper">
                    <canvas id="storageChart" class="chart-canvas" width="360" height="360"></canvas>
                    <div class="chart-center-text">
                        <div class="chart-total" id="storageTotal">0 KB</div>
                        <div class="chart-label">已使用</div>
                    </div>
                </div>
                <div class="chart-legend" id="storageLegend"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeStorageModal()" style="font-weight: 600;">关闭</button>
            </div>
        </div>
    </div>

    <!-- iOS 系统级加载通知 -->
    <div id="wc-ios-loading-overlay" class="wc-ios-loading-overlay hidden">
        <div class="wc-ios-loading-box">
            <div class="wc-ios-spinner" id="wc-loading-spinner"></div>
            <svg class="wc-ios-success-icon hidden" id="wc-loading-success" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
            <svg class="wc-ios-error-icon hidden" id="wc-loading-error" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            <div class="wc-ios-loading-text" id="wc-loading-text">正在生成内容...</div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- WeChat App 容器 (App 1) -->
    <!-- ========================================== -->
    <div class="settings-modal" id="wechatModal" style="padding: 0; z-index: 3000; background: #F2F2F7;">
        <div id="wechat-root">
            <!-- Navbar -->
            <nav class="wc-navbar">
                <div class="wc-nav-left">
                    <button class="wc-nav-btn" id="wc-btn-exit" onclick="closeWechat()">
                        <svg class="wc-icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        退出
                    </button>
                    <button class="wc-nav-btn" id="wc-btn-back" onclick="wcHandleBack()" style="display: none;">
                        <svg class="wc-icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        返回
                    </button>
                </div>
                <div class="wc-nav-title" id="wc-nav-title">Chat</div>
                <div class="wc-nav-right" id="wc-nav-right-container">
                    <!-- Dynamic Buttons -->
                </div>
            </nav>

            <!-- Main Content -->
            <main class="wc-main-content">
                
                <!-- Chat List Page -->
                <div id="wc-view-chat" class="wc-page active">
                    <div class="wc-list-group" id="wc-chat-list" style="background: transparent;"></div>
                </div>

                <!-- Chat Detail Page (WeChat Style) -->
                <div id="wc-view-chat-detail">
                    <div id="wc-chat-background-layer" class="wc-chat-background"></div>
                    <div class="wc-chat-scroll-area" id="wc-chat-messages">
                        <!-- Messages injected here -->
                    </div>
                    
                    <!-- Context Menu (Long Press) -->
                    <div id="wc-context-menu">
                        <div class="wc-ctx-item" onclick="wcHandleReply()">引用</div>
                        <div class="wc-ctx-item" onclick="wcHandleEdit()">编辑</div>
                        <div class="wc-ctx-item" onclick="wcHandleDelete()">删除</div>
                        <div class="wc-ctx-item" onclick="wcHandleMultiSelect()">多选</div>
                    </div>

                    <!-- Sticker Panel Container -->
                    <div id="wc-sticker-panel" class="wc-panel-container">
                        <div class="wc-sticker-grid-area" id="wc-sticker-grid">
                            <!-- Stickers injected via JS -->
                        </div>
                        <div class="wc-sticker-tab-bar">
                            <div class="wc-sticker-add-btn" onclick="wcOpenStickerOptions(event)">
                                <svg class="wc-icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            </div>
                            <div class="wc-sticker-tabs-scroll" id="wc-sticker-tabs">
                                <!-- Tabs injected via JS -->
                            </div>
                        </div>
                    </div>

                    <!-- More Actions Panel -->
                    <div id="wc-more-panel" class="wc-panel-container">
                        <div class="wc-more-grid">
                            <div class="wc-more-item" onclick="wcActionRoll()">
                                <div class="wc-more-icon-box">
                                    <svg class="wc-icon" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                                </div>
                                <span class="wc-more-label">重Roll</span>
                            </div>
                            <div class="wc-more-item" onclick="wcActionVoice()">
                                <div class="wc-more-icon-box">
                                    <svg class="wc-icon" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                                </div>
                                <span class="wc-more-label">语音</span>
                            </div>
                            <div class="wc-more-item" onclick="wcOpenModal('wc-modal-image-type')">
                                <div class="wc-more-icon-box">
                                    <svg class="wc-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                                </div>
                                <span class="wc-more-label">图片</span>
                            </div>
                            <div class="wc-more-item" onclick="wcOpenTransferModal()">
                                <div class="wc-more-icon-box">
                                    <svg class="wc-icon" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                                </div>
                                <span class="wc-more-label">转账</span>
                            </div>
                            <div class="wc-more-item" onclick="wcActionMemory()">
                                <div class="wc-more-icon-box">
                                    <svg class="wc-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                </div>
                                <span class="wc-more-label">回忆总结</span>
                            </div>                           
                        </div>
                    </div>

                    <!-- Chat Footer -->
                    <div class="wc-chat-footer" id="wc-chat-footer">
                        <!-- Quote Preview -->
                        <div id="wc-quote-preview-area">
                            <span id="wc-quote-text-content">引用内容...</span>
                            <span onclick="wcCancelQuote()" style="color: #007AFF; cursor: pointer;">&times;</span>
                        </div>

                        <!-- More Icon -->
                        <svg class="wc-icon wc-footer-icon" onclick="wcToggleMorePanel()" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                        
                        <textarea id="wc-chat-input" class="wc-chat-input" placeholder="" onkeydown="wcHandleEnter(event)" onfocus="wcCloseAllPanels()" rows="1"></textarea>
                        
                        <!-- Sticker Icon -->
                        <svg class="wc-icon wc-footer-icon" onclick="wcToggleStickerPanel()" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                        
                        <!-- AI Reply Button (Paper Plane) -->
                        <button class="wc-btn-ai-reply" onclick="wcTriggerAI()">
                            <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </div>

                    <!-- Multi-select Footer -->
                    <div id="wc-multi-select-footer">
                        <button class="wc-ios-btn-block wc-btn-secondary" style="width: 40%;" onclick="wcExitMultiSelectMode()">取消</button>
                        <button class="wc-ios-btn-block" style="width: 40%; background: var(--wc-danger-red);" onclick="wcHandleMultiDeleteAction()">删除选中</button>
                    </div>
                </div>

                <!-- Contacts Page -->
                <div id="wc-view-contacts" class="wc-page">
                    <div class="wc-list-group" id="wc-contacts-list"></div>
                </div>

                <!-- Moments Page -->
                <div id="wc-view-moments" class="wc-page" style="padding: 0;">
                    <div class="wc-moments-header">
                        <img id="wc-moments-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="wc-moments-cover" onclick="wcTriggerUpload('cover')">
                        <img id="wc-moments-user-avatar" src="" class="wc-moments-user-avatar">
                    </div>
                    <div id="wc-moments-feed"></div>
                </div>

                <!-- User Page -->
                <div id="wc-view-user" class="wc-page">
                    <div class="wc-user-header">
                        <img id="wc-user-center-avatar" src="" class="wc-user-avatar-lg" onclick="wcTriggerUpload('user')">
                        <h2 id="wc-user-name-display">User</h2>
                    </div>
                    
                    <div class="wc-list-group">
                        <div class="wc-list-item" onclick="wcOpenWallet()">
                            <svg class="wc-icon" style="margin-right: 10px;" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                            <div class="wc-item-content">
                                <div class="wc-item-title">钱包</div>
                            </div>
                            <svg class="wc-icon" style="color: #C7C7CC; width: 20px;" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                        <div class="wc-list-item" onclick="wcOpenMasksModal()">
                            <svg class="wc-icon" style="margin-right: 10px;" viewBox="0 0 24 24"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            <div class="wc-item-content">
                                <div class="wc-item-title">面具 (Masks)</div>
                                <div class="wc-item-subtitle">切换身份与人设</div>
                            </div>
                            <svg class="wc-icon" style="color: #C7C7CC; width: 20px;" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                        <div class="wc-list-item" onclick="wcOpenWechatSettings()">
                            <svg class="wc-icon" style="margin-right: 10px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                            <div class="wc-item-content">
                                <div class="wc-item-title">设置</div>
                                <div class="wc-item-subtitle">数据备份与管理</div>
                            </div>
                            <svg class="wc-icon" style="color: #C7C7CC; width: 20px;" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                    </div>
                </div>

                <!-- Wallet Page -->
                <div id="wc-view-wallet" class="wc-page" style="padding: 0;">
                    <div class="wc-wallet-header">
                        <svg class="wc-icon wc-wallet-icon-lg" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                        <div class="wc-wallet-balance-label">当前余额 (元)</div>
                        <div class="wc-wallet-balance-num" id="wc-wallet-balance-display">0.00</div>
                        <div class="wc-wallet-btn-row">
                            <button class="wc-ios-btn-block" style="background: var(--wc-accent-green);" onclick="wcOpenRechargeModal()">充值</button>
                        </div>
                    </div>
                    <div class="wc-list-group-title" style="padding: 0 16px 8px; color: var(--wc-text-secondary); font-size: 13px;">交易记录</div>
                    <div id="wc-wallet-history-list" style="background: #fff;">
                        <!-- Transactions injected here -->
                    </div>
                </div>

                <!-- Memory Full Page (New Full Screen) -->
                <div id="wc-view-memory">
                    <div class="wc-navbar">
                        <div class="wc-nav-left">
                            <button class="wc-nav-btn" onclick="wcCloseMemoryPage()">
                                <svg class="wc-icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
                                返回
                            </button>
                        </div>
                        <div class="wc-nav-title">回忆总结</div>
                        <div class="wc-nav-right">
                            <!-- 设置按钮：关联世界书 & 自动总结条数 -->
                            <button class="wc-nav-btn" onclick="wcOpenMemorySettingsModal()">
                                <svg class="wc-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                            </button>
                            <!-- 更多操作：手动添加/生成 -->
                            <button class="wc-nav-btn" onclick="wcOpenModal('wc-modal-memory-actions')">
                                <svg class="wc-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                            </button>
                        </div>
                    </div>
                    <div class="wc-main-content" style="padding-top: 64px; background: #F2F2F7;">
                        <div id="wc-memory-list-container" style="padding: 16px;">
                            <!-- Memories injected here -->
                        </div>
                    </div>
                </div>

                <!-- Phone Simulator View -->
                <div id="wc-view-phone-sim">
                    <div class="wc-phone-bezel">
                        <!-- 刘海已删除 -->
                        
                        <div class="wc-phone-screen" id="wc-phone-screen-bg">
                            <div class="wc-phone-sim-navbar">
                                <div style="width: 40px;"></div>
                                <div style="width: 40px;"></div>
                            </div>

                            <!-- iOS Desktop -->
                            <div class="wc-ios-desktop">
                                <!-- 右上角便利贴 (Sticky Note) - 移入 Desktop 内部 -->
                                <div id="wc-phone-sticky-note" class="wc-phone-sticky-note" onclick="wcOpenPhoneSettings()">
                                    <div class="wc-sticky-note-content" id="wc-sticky-note-bg"></div>
                                </div>

                                <!-- Row 1 & 2: Clock Widget -->
                                <div class="wc-ios-widget-clock">
                                    <div class="wc-ios-clock-time" id="wc-sim-clock-time">12:00</div>
                                    <div class="wc-ios-clock-date" id="wc-sim-clock-date">10月24日 星期二</div>
                                </div>
                                
                                <!-- Row 3: Apps -->
                                <div class="wc-ios-app-item" onclick="wcOpenPhoneApp('message')">
                                    <div class="wc-ios-app-icon" id="wc-icon-message">
                                        <svg class="wc-icon" viewBox="0 0 24 24" style="color: #34C759; width: 32px; height: 32px;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                                    </div>
                                    <div class="wc-ios-app-name">微信</div>
                                </div>
                                <div class="wc-ios-app-item" onclick="alert('Browser App')">
                                    <div class="wc-ios-app-icon" id="wc-icon-browser">
                                        <svg class="wc-icon" viewBox="0 0 24 24" style="color: #007AFF; width: 32px; height: 32px;"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1 4-10z"></path></svg>
                                    </div>
                                    <div class="wc-ios-app-name">Browser</div>
                                </div>
                                <div class="wc-ios-app-item" onclick="alert('Cart App')">
                                    <div class="wc-ios-app-icon" id="wc-icon-cart">
                                        <svg class="wc-icon" viewBox="0 0 24 24" style="color: #FF9500; width: 32px; height: 32px;"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                                    </div>
                                    <div class="wc-ios-app-name">Cart</div>
                                </div>
                                <div class="wc-ios-app-item" onclick="wcOpenPhoneApp('settings')">
                                    <div class="wc-ios-app-icon" id="wc-icon-settings">
                                        <svg class="wc-icon" viewBox="0 0 24 24" style="color: #8E8E93; width: 32px; height: 32px;"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                                    </div>
                                    <div class="wc-ios-app-name">Settings</div>
                                </div>
                            </div>

                            <!-- Phone App: Message (微信内部) -->
                            <div id="wc-phone-app-message" class="wc-phone-app-view" style="display: none; flex-direction: column;">
                                <!-- 动态 Header -->
                                <div class="wc-phone-sim-navbar" id="wc-phone-app-header" style="background: #F7F7F7; color: #000; border-bottom: 0.5px solid #C6C6C8; justify-content: space-between; padding: 0 10px; flex-shrink: 0;">
                                    <!-- 左侧按钮 (JS 动态注入) -->
                                    <div id="wc-phone-header-left"></div>
                                    <!-- 标题 -->
                                    <div style="font-weight: 600;" id="wc-phone-header-title">微信</div>
                                    <!-- 右侧关闭 -->
                                    <div onclick="wcClosePhoneApp()" style="cursor: pointer; font-size: 14px;">关闭</div>
                                </div>
                                
                                <!-- 内容区域 -->
                                <div class="wc-phone-app-content" id="wc-phone-app-content" style="background: #fff;"></div>

                                <!-- 底部 Tab -->
                                <div class="wc-phone-app-tabbar">
                                    <div class="wc-phone-tab-item active" id="wc-phone-tab-chat" onclick="wcSwitchPhoneTab('chat')">
                                        <svg class="wc-icon" style="width: 20px; height: 20px;" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                                        <span>微信</span>
                                    </div>
                                    <div class="wc-phone-tab-item" id="wc-phone-tab-contacts" onclick="wcSwitchPhoneTab('contacts')">
                                        <svg class="wc-icon" style="width: 20px; height: 20px;" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                                        <span>通讯录</span>
                                    </div>
                                    <div class="wc-phone-tab-item" id="wc-phone-tab-me" onclick="wcSwitchPhoneTab('me')">
                                        <svg class="wc-icon" style="width: 20px; height: 20px;" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                        <span>我</span>
                                    </div>
                                </div>
                                
                                <!-- 模拟聊天详情页 -->
                                <div id="wc-phone-sim-chat-detail" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #F2F2F7; z-index: 200; display: none; flex-direction: column; overflow: hidden;">
                                    <div class="wc-phone-sim-navbar" style="background: #F7F7F7; border-bottom: 0.5px solid #C6C6C8; flex-shrink: 0;">
                                        <div onclick="wcCloseSimChatDetail()" style="cursor: pointer; font-size: 14px; display:flex; align-items:center;">
                                            <svg class="wc-icon" viewBox="0 0 24 24" style="width:20px;height:20px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
                                            微信
                                        </div>
                                        <div style="font-weight: 600;" id="wc-sim-chat-title">Name</div>
                                        <div style="width: 40px;"></div> <!-- 占位 -->
                                    </div>
                                    
                                    <div id="wc-sim-chat-history" style="flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column;"></div>
                                    
                                    <!-- 底部输入框 -->
                                    <div id="wc-sim-chat-footer" style="padding: 8px 10px; background: #F7F7F7; border-top: 0.5px solid #C6C6C8; display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                                        <input type="text" id="wc-sim-chat-input" style="flex: 1; height: 36px; border-radius: 4px; border: 1px solid #ddd; padding: 0 8px; font-size: 14px;" placeholder="替 TA 回复...">
                                        <button onclick="wcSimSendMsg()" style="background: #07C160; color: white; border: none; border-radius: 4px; padding: 0 12px; height: 36px; font-size: 14px;">发送</button>
                                        <button onclick="wcSimTriggerAI()" style="background: transparent; color: #000; border: none; padding: 0 8px; height: 36px; display: flex; align-items: center; justify-content: center;">
                                            <svg class="wc-icon" viewBox="0 0 24 24" style="width: 24px; height: 24px; color: #576B95;"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                                        </button>
                                    </div>
                                </div>

                                <!-- 模拟钱包详情页 -->
                                <div id="wc-phone-app-wallet" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #F2F2F7; z-index: 200; display: none; flex-direction: column;">
                                    <div class="wc-phone-sim-navbar" style="background: #EDEDED; border-bottom: 0.5px solid #C6C6C8; flex-shrink: 0; color: #000;">
                                        <div onclick="wcClosePhoneWallet()" style="cursor: pointer; font-size: 14px; display:flex; align-items:center;">
                                            <svg class="wc-icon" viewBox="0 0 24 24" style="width:20px;height:20px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
                                            我
                                        </div>
                                        <div style="font-weight: 600;">钱包</div>
                                        <div onclick="wcGenerateCharWallet()" style="cursor: pointer; font-size: 14px;">刷新账单</div>
                                    </div>
                                    <div id="wc-phone-wallet-content" style="flex: 1; overflow-y: auto;"></div>
                                </div>
                            </div>

                            <!-- Phone App: Settings (新增) -->
                            <div id="wc-phone-app-settings" class="wc-phone-app-view" style="display: none;">
                                <div class="wc-phone-sim-navbar" style="background: #F2F2F7; color: #000; border-bottom: 0.5px solid #C6C6C8; justify-content: space-between; padding: 0 10px;">
                                    <div onclick="wcGeneratePhoneSettings()" style="cursor: pointer; font-size: 14px; color: #007AFF;">刷新状态</div>
                                    <div style="font-weight: 600;">设置</div>
                                    <div onclick="wcClosePhoneApp()" style="cursor: pointer; font-size: 14px;">关闭</div>
                                </div>
                                <div id="wc-phone-settings-content" style="flex: 1; overflow-y: auto; padding: 20px;">
                                    <!-- Settings Content Injected Here -->
                                </div>
                            </div>

                        </div>
                        
                        <!-- 指纹退出键 (仅在桌面显示) -->
                        <div id="wc-phone-fingerprint-btn" class="wc-phone-fingerprint" onclick="wcClosePhoneSim()">
                            <svg viewBox="0 0 24 24" style="width:100%;height:100%;fill:none;stroke:rgba(255,255,255,0.8);stroke-width:2;"><path d="M12 2a5 5 0 0 1 5 5v1h-2V7a3 3 0 0 0-6 0v1H7V7a5 5 0 0 1 5-5z"/><rect x="5" y="8" width="14" height="14" rx="2"/></svg>
                        </div>
                    </div>
                </div>

            </main>

            <!-- TabBar -->
            <div class="wc-tabbar-container" id="wc-main-tabbar">
                <div class="wc-tabbar">
                    <div class="wc-tab-item active" onclick="wcSwitchTab('chat')">
                        <svg class="wc-icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        <span>Chat</span>
                    </div>
                    <div class="wc-tab-item" onclick="wcSwitchTab('contacts')">
                        <svg class="wc-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        <span>Contacts</span>
                    </div>
                    <div class="wc-tab-item" onclick="wcSwitchTab('moments')">
                        <svg class="wc-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="14.31" y1="8" x2="20.05" y2="17.94"></line><line x1="9.69" y1="8" x2="21.17" y2="8"></line><line x1="7.38" y1="12" x2="13.12" y2="2.06"></line><line x1="9.69" y1="16" x2="3.95" y2="6.06"></line><line x1="14.31" y1="16" x2="2.83" y2="16"></line><line x1="16.62" y1="12" x2="10.88" y2="21.94"></line></svg>
                        <span>Moments</span>
                    </div>
                    <div class="wc-tab-item" onclick="wcSwitchTab('user')">
                        <svg class="wc-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        <span>User</span>
                    </div>
                </div>
            </div>

            <!-- WeChat Settings Modal (New) -->
            <div id="wc-modal-wechat-settings" class="wc-modal hidden" style="z-index: 3500; align-items: flex-end;">
                <div class="wc-modal-content" style="height: auto; border-radius: 12px 12px 0 0; width: 100%; max-width: 100%; background-color: transparent;">
                    <div class="wc-ios-list-group" style="margin: 0 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcExportData(); wcCloseModal('wc-modal-wechat-settings');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">备份 WeChat 数据 (导出)</span>
                        </div>
                        <div class="wc-list-item center-content" onclick="document.getElementById('wcBackupImportInput').click(); wcCloseModal('wc-modal-wechat-settings');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">恢复 WeChat 数据 (导入)</span>
                        </div>
                        <div class="wc-list-item center-content" onclick="wcClearData(); wcCloseModal('wc-modal-wechat-settings');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #FF3B30;">清空 WeChat 数据</span>
                        </div>
                    </div>
                    <div class="wc-ios-list-group" style="margin: 10px 10px 20px 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcCloseModal('wc-modal-wechat-settings')" style="background: white; height: 56px;">
                            <span style="font-size: 18px; font-weight: bold; color: #007AFF;">取消</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ... (其他模态框保持不变，确保 ID 唯一且结构正确) ... -->
            <!-- Add Character Modal -->
            <div id="wc-modal-add-char" class="wc-modal-overlay">
                <div class="wc-modal-content">
                    <div class="wc-modal-header">
                        <h3>添加新角色</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-add-char')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-upload-placeholder" onclick="wcTriggerUpload('char')">
                            <img id="wc-preview-char-avatar" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                            <svg id="wc-icon-char-upload" class="wc-icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">名称</label>
                            <input type="text" id="wc-input-char-name" class="wc-form-input" placeholder="角色名字">
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">备注</label>
                            <input type="text" id="wc-input-char-note" class="wc-form-input" placeholder="在列表中显示的名称">
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">人设 (System Prompt)</label>
                            <textarea id="wc-input-char-prompt" class="wc-form-textarea" placeholder="你是一个..."></textarea>
                        </div>
                        <button class="wc-btn-primary" onclick="wcSaveCharacter()">保存</button>
                    </div>
                </div>
            </div>

            <!-- Character Detail Card -->
            <div id="wc-modal-char-detail" class="wc-modal-overlay">
                <div class="wc-modal-content">
                    <div class="wc-contact-card-header">
                        <img id="wc-detail-char-avatar" src="" class="wc-contact-card-img">
                        <div class="wc-contact-card-close-btn" onclick="wcCloseModal('wc-modal-char-detail')">
                            <svg class="wc-icon" style="width: 20px; height: 20px;" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </div>
                        <div class="wc-contact-card-edit-btn" onclick="wcOpenEditCharSettings()">
                            <svg class="wc-icon" style="width: 16px; height: 16px;" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </div>
                    </div>
                    <div class="wc-contact-card-info">
                        <div class="wc-contact-card-name" id="wc-detail-char-name">Name</div>
                        <div class="wc-contact-card-note" id="wc-detail-char-note">Note</div>
                        <button class="wc-ios-btn-block" onclick="wcCheckPhoneAction()">查看对方手机</button>
                    </div>
                </div>
            </div>

            <!-- Hidden Edit Modal for Character -->
            <div id="wc-modal-edit-char-settings" class="wc-modal-overlay">
                <div class="wc-modal-content" style="border-radius: 16px 16px 0 0; position: absolute; bottom: 0; width: 100%; max-width: 100%;">
                    <div class="wc-modal-header">
                        <h3>编辑资料</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-edit-char-settings')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-upload-placeholder" onclick="wcTriggerUpload('edit-char')">
                            <img id="wc-edit-char-avatar" src="" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">名称</label>
                            <input type="text" id="wc-edit-char-name" class="wc-form-input">
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">备注</label>
                            <input type="text" id="wc-edit-char-note" class="wc-form-input">
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">人设 (Prompt)</label>
                            <textarea id="wc-edit-char-prompt" class="wc-form-textarea"></textarea>
                        </div>
                        <button class="wc-btn-primary" onclick="wcUpdateCharacter()">保存修改</button>
                    </div>
                </div>
            </div>

            <!-- Phone Settings Modal -->
            <div id="wc-modal-phone-settings" class="wc-modal-overlay">
                <div class="wc-modal-content" style="border-radius: 16px 16px 0 0; position: absolute; bottom: 0; width: 100%; max-width: 100%;">
                    <div class="wc-modal-header">
                        <h3>手机装修</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-phone-settings')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-form-group">
                            <label class="wc-form-label">便利贴图片 (点击上传)</label>
                            <div class="wc-upload-rect-placeholder" style="width: 100px; height: 100px; margin: 0 auto 16px;" onclick="wcTriggerUpload('sticky-note')">
                                <img id="wc-preview-sticky-note" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                <span id="wc-text-sticky-note" style="font-size: 12px;">上传图片</span>
                            </div>
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">桌面壁纸</label>
                            <div class="wc-upload-rect-placeholder" style="width: 100%; height: 150px;" onclick="wcTriggerUpload('phone-bg')">
                                <img id="wc-preview-phone-bg" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                <span id="wc-text-phone-bg">点击上传壁纸</span>
                            </div>
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">APP 图标</label>
                            <div style="display: flex; gap: 10px; justify-content: space-between;">
                                <div class="wc-upload-placeholder" style="width: 60px; height: 60px; margin: 0;" onclick="wcTriggerUpload('icon-msg')">
                                    <img id="wc-preview-icon-msg" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                    <span style="font-size: 10px;">Msg</span>
                                </div>
                                <div class="wc-upload-placeholder" style="width: 60px; height: 60px; margin: 0;" onclick="wcTriggerUpload('icon-browser')">
                                    <img id="wc-preview-icon-browser" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                    <span style="font-size: 10px;">Web</span>
                                </div>
                                <div class="wc-upload-placeholder" style="width: 60px; height: 60px; margin: 0;" onclick="wcTriggerUpload('icon-cart')">
                                    <img id="wc-preview-icon-cart" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                    <span style="font-size: 10px;">Cart</span>
                                </div>
                                <div class="wc-upload-placeholder" style="width: 60px; height: 60px; margin: 0;" onclick="wcTriggerUpload('icon-settings')">
                                    <img id="wc-preview-icon-settings" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                    <span style="font-size: 10px;">Set</span>
                                </div>
                            </div>
                        </div>
                        <button class="wc-btn-primary" onclick="wcSavePhoneSettings()">保存装修</button>
                    </div>
                </div>
            </div>

            <!-- Post Moment Modal -->
            <div id="wc-modal-post-moment" class="wc-modal-overlay">
                <div class="wc-modal-content" style="border-radius: 14px; margin: auto; position: relative; bottom: auto;">
                    <h3>发布动态</h3>
                    <div class="wc-form-group">
                        <textarea id="wc-input-moment-text" class="wc-form-textarea" placeholder="这一刻的想法..."></textarea>
                    </div>
                    <div class="wc-segmented-control">
                        <div class="wc-segment-btn active" id="wc-seg-local" onclick="wcToggleMomentType('local')">本地图片</div>
                        <div class="wc-segment-btn" id="wc-seg-desc" onclick="wcToggleMomentType('desc')">图片描述</div>
                    </div>
                    <div id="wc-area-local-img" class="wc-form-group">
                        <div class="wc-upload-rect-placeholder" onclick="wcTriggerUpload('moment')">
                            <img id="wc-preview-moment-img" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                            <svg id="wc-icon-moment-upload" class="wc-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                        </div>
                        <label class="wc-form-label" style="text-align: center; font-size: 12px;">点击上传 (自动压缩)</label>
                    </div>
                    <div id="wc-area-desc-img" class="wc-form-group" style="display: none;">
                        <input type="text" id="wc-input-moment-desc" class="wc-form-input" placeholder="例如：一张在海边看日落的照片">
                        <label class="wc-form-label" style="text-align: center; font-size: 12px; margin-top: 5px;">将生成图片占位符</label>
                    </div>
                    <button class="wc-btn-primary" onclick="wcSaveMoment()">发布</button>
                    <button class="wc-btn-primary wc-btn-secondary" onclick="wcCloseModal('wc-modal-post-moment')">取消</button>
                </div>
            </div>

            <!-- Masks (Persona) Modal -->
            <div id="wc-modal-masks" class="wc-modal-overlay">
                <div class="wc-modal-content">
                    <div class="wc-modal-header">
                        <h3>我的面具 (Masks)</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-masks')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-list-group" id="wc-masks-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 16px;">
                            <!-- Masks injected here -->
                        </div>
                        <button class="wc-btn-primary" onclick="wcOpenEditMask()">+ 添加新面具</button>
                    </div>
                </div>
            </div>

            <!-- Edit Mask Modal -->
            <div id="wc-modal-edit-mask" class="wc-modal-overlay" style="z-index: 2100;">
                <div class="wc-modal-content">
                    <div class="wc-modal-header">
                        <h3 id="wc-mask-modal-title">编辑面具</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-edit-mask')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-upload-placeholder" onclick="wcTriggerUpload('mask')">
                            <img id="wc-preview-mask-avatar" src="" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">名称</label>
                            <input type="text" id="wc-input-mask-name" class="wc-form-input">
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">人设 (Prompt)</label>
                            <textarea id="wc-input-mask-prompt" class="wc-form-textarea" placeholder="描述这个身份的性格..."></textarea>
                        </div>
                        <button class="wc-btn-primary" onclick="wcSaveMask()">保存面具</button>
                    </div>
                </div>
            </div>

            <!-- Memory Actions Modal -->
            <div id="wc-modal-memory-actions" class="wc-modal hidden" style="z-index: 2200; align-items: flex-end;">
                <div class="wc-modal-content" style="height: auto; border-radius: 12px 12px 0 0; width: 100%; max-width: 100%; background-color: transparent;">
                    <div class="wc-ios-list-group" style="margin: 0 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcOpenMemorySummaryModal(); wcCloseModal('wc-modal-memory-actions');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">自动总结聊天</span>
                        </div>
                        <div class="wc-list-item center-content" onclick="wcOpenModal('wc-modal-memory-add'); wcCloseModal('wc-modal-memory-actions');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">手动添加记忆</span>
                        </div>
                        <div class="wc-list-item center-content" onclick="wcOpenModal('wc-modal-memory-ai-count'); wcCloseModal('wc-modal-memory-actions');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">设置AI读取条数</span>
                        </div>
                    </div>
                    <div class="wc-ios-list-group" style="margin: 10px 10px 20px 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcCloseModal('wc-modal-memory-actions')" style="background: white; height: 56px;">
                            <span style="font-size: 18px; font-weight: bold; color: #007AFF;">取消</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Memory Sub-Modals -->
            <div id="wc-modal-memory-summary" class="wc-modal hidden">
                <div class="wc-modal-content">
                    <div class="wc-modal-header">
                        <h3>生成总结</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-memory-summary')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-form-group"><label class="wc-form-label" id="wc-mem-total-count-label">当前聊天总层数: 0</label></div>
                        <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                            <input type="number" id="wc-mem-start-idx" class="wc-form-input" placeholder="起始层数">
                            <input type="number" id="wc-mem-end-idx" class="wc-form-input" placeholder="结束层数">
                        </div>
                        
                        <div class="wc-form-group">
                            <label class="wc-form-label">关联世界书 (仅用于本次总结)</label>
                            <div id="wc-mem-summary-wb-list" class="wc-checkbox-list" style="max-height: 150px; overflow-y: auto;">
                                <!-- JS 注入 -->
                            </div>
                        </div>

                        <button id="wc-btn-generate-summary" class="wc-btn-primary" onclick="wcGenerateSummary()">开始生成</button>
                    </div>
                </div>
            </div>

            <!-- 新增：回忆设置弹窗 (包含世界书选择和自动触发条数) -->
            <div id="wc-modal-memory-settings" class="wc-modal hidden" style="z-index: 2600;">
                <div class="wc-modal-content">
                    <div class="wc-modal-header">
                        <h3>回忆设置</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-memory-settings')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-form-group">
                            <label class="wc-form-label">自动总结触发条数 (0为关闭)</label>
                            <input type="number" id="wc-mem-setting-trigger" class="wc-form-input" placeholder="例如: 20">
                            <div style="font-size: 11px; color: #888; margin-top: 4px;">每当聊天达到此数量时，自动触发总结。</div>
                        </div>
                        
                        <div class="wc-form-group">
                            <label class="wc-form-label">关联世界书 (仅用于总结)</label>
                            <div id="wc-mem-setting-wb-list" class="wc-checkbox-list" style="max-height: 200px; overflow-y: auto;">
                                <!-- JS 注入 -->
                            </div>
                        </div>
                        
                        <button class="wc-btn-primary" onclick="wcSaveMemorySettings()">保存设置</button>
                    </div>
                </div>
            </div>

            <div id="wc-modal-memory-add" class="wc-modal hidden">
                <div class="wc-modal-content">
                    <div class="wc-modal-header"><h3>添加记忆</h3><button class="wc-close-btn" onclick="wcCloseModal('wc-modal-memory-add')">&times;</button></div>
                    <div class="wc-modal-body">
                        <textarea id="wc-mem-manual-text" class="wc-form-textarea" placeholder="例如：用户喜欢吃苹果..."></textarea>
                        <button class="wc-btn-primary" onclick="wcAddManualMemory()">添加</button>
                    </div>
                </div>
            </div>
            <div id="wc-modal-memory-ai-count" class="wc-modal hidden">
                <div class="wc-modal-content">
                    <div class="wc-modal-header"><h3>AI读取记忆条数</h3><button class="wc-close-btn" onclick="wcCloseModal('wc-modal-memory-ai-count')">&times;</button></div>
                    <div class="wc-modal-body">
                        <div class="wc-form-group"><label class="wc-form-label">发送给AI的最新记忆数量</label><input type="number" id="wc-mem-ai-read-count" class="wc-form-input" placeholder="默认: 5"></div>
                        <button class="wc-btn-primary" onclick="wcSaveAiMemoryCount()">保存</button>
                    </div>
                </div>
            </div>

            <!-- 生成通讯录弹窗 -->
            <div id="wc-modal-gen-contacts" class="wc-modal hidden" style="z-index: 3000;">
                <div class="wc-modal-content">
                    <div class="wc-modal-header">
                        <h3>生成通讯录</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-gen-contacts')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-form-group">
                            <label class="wc-form-label">生成人数范围 (包含群聊)</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="wc-gen-contact-min" class="wc-form-input" placeholder="最小 (如 3)" value="3">
                                <input type="number" id="wc-gen-contact-max" class="wc-form-input" placeholder="最大 (如 8)" value="8">
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #888; margin-bottom: 10px;">
                            将根据人设和世界书生成好友、群聊以及待验证的好友请求。
                        </div>
                        <button class="wc-btn-primary" onclick="wcGeneratePhoneContacts()">开始生成</button>
                    </div>
                </div>
            </div>

            <!-- 通讯录好友详情卡片 -->
            <div id="wc-modal-phone-contact-card" class="wc-modal hidden" style="z-index: 3100; align-items: center; justify-content: center; display: flex;">
                <div class="wc-modal-content" style="width: 280px; height: 360px; padding: 0; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; position: relative;">
                    <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-phone-contact-card')" style="position: absolute; top: 10px; right: 10px; z-index: 10;">&times;</button>
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; background: #fff;">
                        <div id="wc-card-contact-avatar" style="width: 80px; height: 80px; border-radius: 8px; background: #eee; margin-bottom: 15px; overflow: hidden;"></div>
                        <div class="wc-contact-card-name" id="wc-card-contact-name" style="font-size: 22px; font-weight: 600; color: #000;">Name</div>
                        <div id="wc-card-contact-desc" style="font-size: 13px; color: #888; margin-top: 8px; text-align: center; padding: 0 10px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">Desc</div>
                    </div>
                    <div style="padding: 20px; background: #F7F7F7; border-top: 1px solid #eee; display: flex; flex-direction: column; gap: 10px;">
                        <button class="wc-ios-btn-block" style="background: #07C160; color: white; height: 40px; font-size: 14px;" onclick="wcShareContactToMain()">添加至列表</button>
                        <button class="wc-ios-btn-block" style="background: #fff; color: #000; border: 1px solid #ddd; height: 40px; font-size: 14px;" onclick="wcOpenShareCardModal()">分享名片</button>
                        <button class="wc-ios-btn-block" style="background: transparent; color: #FA5151; height: 30px; font-size: 14px; margin-top: 5px;" onclick="wcDeletePhoneContact()">删除好友</button>
                    </div>
                </div>
            </div>

            <!-- 分享名片选择列表弹窗 -->
            <div id="wc-modal-share-card-select" class="wc-modal hidden" style="z-index: 3200;">
                <div class="wc-modal-content">
                    <div class="wc-modal-header">
                        <h3>选择分享对象</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-modal-share-card-select')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div id="wc-share-card-list" style="max-height: 300px; overflow-y: auto;">
                            <!-- JS 注入好友列表 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- General Input Modal -->
            <div id="wc-modal-general-input" class="wc-modal hidden" style="z-index: 2400;">
                <div class="wc-modal-content" style="width: 80%; max-width: 300px; border-radius: 12px;">
                    <div style="padding: 20px;">
                        <h3 style="margin-top: 0; text-align: center;" id="wc-general-input-title">输入</h3>
                        <div class="wc-form-group">
                            <input type="text" id="wc-general-input-field" class="wc-form-input" style="text-align: center;">
                        </div>
                        <button class="wc-btn-primary" id="wc-general-input-confirm">确定</button>
                        <button class="wc-btn-primary wc-btn-secondary" onclick="wcCloseModal('wc-modal-general-input')">取消</button>
                    </div>
                </div>
            </div>

            <!-- Transfer Input Modal -->
            <div id="wc-modal-transfer-input" class="wc-modal hidden" style="z-index: 2300;">
                <div class="wc-modal-content" style="width: 80%; max-width: 300px; border-radius: 12px;">
                    <div style="padding: 20px;">
                        <h3 style="margin-top: 0; text-align: center;">转账</h3>
                        <div class="wc-form-group">
                            <label class="wc-form-label">金额</label>
                            <input type="number" id="wc-transfer-amount" class="wc-form-input" placeholder="0.00" style="font-size: 24px; text-align: center;">
                        </div>
                        <div class="wc-form-group">
                            <label class="wc-form-label">备注</label>
                            <input type="text" id="wc-transfer-note" class="wc-form-input" placeholder="转账说明">
                        </div>
                        <button class="wc-btn-primary" onclick="wcSubmitTransferDetails()">下一步</button>
                        <button class="wc-btn-primary wc-btn-secondary" onclick="wcCloseModal('wc-modal-transfer-input')">取消</button>
                    </div>
                </div>
            </div>

            <!-- Transfer Action Sheet -->
            <div id="wc-modal-transfer-action" class="wc-modal hidden" style="z-index: 2200; align-items: flex-end;">
                <div class="wc-modal-content" style="height: auto; border-radius: 12px 12px 0 0; width: 100%; max-width: 100%; background-color: transparent;">
                    <div class="wc-ios-list-group" style="margin: 0 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcConfirmTransferReceive()" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">确认收款</span>
                        </div>
                        <div class="wc-list-item center-content" onclick="wcConfirmTransferReject()" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #FF3B30;">退还</span>
                        </div>
                    </div>
                    <div class="wc-ios-list-group" style="margin: 10px 10px 20px 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcCloseModal('wc-modal-transfer-action')" style="background: white; height: 56px;">
                            <span style="font-size: 18px; font-weight: bold; color: #007AFF;">取消</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wallet Settings Modal -->
            <div id="wc-modal-wallet-settings" class="wc-modal hidden" style="z-index: 2200; align-items: flex-end;">
                <div class="wc-modal-content" style="height: auto; border-radius: 12px 12px 0 0; width: 100%; max-width: 100%; background-color: transparent;">
                    <div class="wc-ios-list-group" style="margin: 0 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcOpenSetPasswordModal(); wcCloseModal('wc-modal-wallet-settings');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">设置/修改支付密码</span>
                        </div>
                        <div class="wc-list-item center-content" onclick="wcClearTransactionHistory(); wcCloseModal('wc-modal-wallet-settings');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #FF3B30;">清空交易记录</span>
                        </div>
                    </div>
                    <div class="wc-ios-list-group" style="margin: 10px 10px 20px 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcCloseModal('wc-modal-wallet-settings')" style="background: white; height: 56px;">
                            <span style="font-size: 18px; font-weight: bold; color: #007AFF;">取消</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recharge Modal -->
            <div id="wc-modal-recharge" class="wc-modal hidden" style="z-index: 2300;">
                <div class="wc-modal-content" style="width: 80%; max-width: 300px; border-radius: 12px;">
                    <div style="padding: 20px;">
                        <h3 style="margin-top: 0; text-align: center;">充值余额</h3>
                        <div class="wc-form-group">
                            <label class="wc-form-label">金额</label>
                            <input type="number" id="wc-recharge-amount" class="wc-form-input" placeholder="0.00" style="font-size: 24px; text-align: center;">
                        </div>
                        <button class="wc-btn-primary" style="background: var(--wc-accent-green);" onclick="wcConfirmRecharge()">确认充值</button>
                        <button class="wc-btn-primary wc-btn-secondary" onclick="wcCloseModal('wc-modal-recharge')">取消</button>
                    </div>
                </div>
            </div>

            <!-- CHAT SETTINGS MODAL -->
            <div id="wc-modal-chat-settings" class="wc-modal hidden" style="z-index: 2500;">
                <div class="wc-modal-content" style="background: #F2F2F7;">
                    <div class="wc-navbar" style="position: sticky; top: 0;">
                        <div class="wc-nav-left">
                            <button class="wc-nav-btn" onclick="wcCloseModal('wc-modal-chat-settings')">关闭</button>
                        </div>
                        <div class="wc-nav-title">聊天设置</div>
                        <div class="wc-nav-right">
                            <button class="wc-nav-btn" style="color: var(--wc-accent-green); font-weight: 600;" onclick="wcSaveChatSettings()">保存</button>
                        </div>
                    </div>
                    <div class="wc-modal-body" style="padding-top: 10px; max-height: none; flex: 1;">
                        
                        <!-- Character Settings -->
                        <div class="wc-settings-section">
                            <div class="wc-settings-section-title">角色设置 (仅当前聊天)</div>
                            <div class="wc-avatar-row">
                                <img id="wc-setting-char-avatar" src="" class="wc-avatar-edit" onclick="wcTriggerUpload('setting-char')">
                                <div style="flex: 1;">
                                    <label class="wc-form-label">名称</label>
                                    <input type="text" id="wc-setting-char-name" class="wc-form-input" style="background: #F2F2F7;">
                                </div>
                            </div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">备注</label>
                                <input type="text" id="wc-setting-char-note" class="wc-form-input">
                            </div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">人设 (Prompt)</label>
                                <textarea id="wc-setting-char-prompt" class="wc-form-textarea" style="height: 80px;"></textarea>
                            </div>
                        </div>

                        <!-- User Persona Settings -->
                        <div class="wc-settings-section">
                            <div class="wc-settings-section-title">我的身份 (仅当前聊天)</div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">从面具导入</label>
                                <select id="wc-setting-user-mask-select" class="wc-form-input" onchange="wcImportMaskToChat(this.value)">
                                    <option value="">选择面具...</option>
                                </select>
                            </div>
                            <div class="wc-avatar-row">
                                <img id="wc-setting-user-avatar" src="" class="wc-avatar-edit" onclick="wcTriggerUpload('setting-user')">
                                <div style="flex: 1;">
                                    <label class="wc-form-label">名称</label>
                                    <input type="text" id="wc-setting-user-name" class="wc-form-input">
                                </div>
                            </div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">人设 (Prompt)</label>
                                <textarea id="wc-setting-user-prompt" class="wc-form-textarea" style="height: 80px;"></textarea>
                            </div>
                        </div>

                        <!-- Advanced Settings -->
                        <div class="wc-settings-section">
                            <div class="wc-settings-section-title">高级设置</div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">上下文条数限制 (0为不限制)</label>
                                <input type="number" id="wc-setting-context-limit" class="wc-form-input" value="0">
                            </div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">关联世界书条目 (多选)</label>
                                <div id="wc-setting-worldbook-list" class="wc-checkbox-list">
                                    <!-- Checkboxes injected via JS -->
                                </div>
                            </div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">关联表情包分组 (多选)</label>
                                <div id="wc-setting-sticker-group-list" class="wc-checkbox-list">
                                    <!-- Checkboxes injected via JS -->
                                </div>
                            </div>
                        </div>

                        <!-- Appearance -->
                        <div class="wc-settings-section">
                            <div class="wc-settings-section-title">外观与美化</div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">聊天背景图</label>
                                <div class="wc-upload-rect-placeholder" style="width: 100%; height: 120px;" onclick="wcTriggerUpload('setting-bg')">
                                    <img id="wc-setting-bg-preview" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                    <span id="wc-setting-bg-text">点击上传背景</span>
                                </div>
                                <button class="wc-ios-btn-block wc-btn-secondary" style="padding: 8px; font-size: 14px; margin-top: 8px;" onclick="wcClearChatBackground()">清除背景</button>
                            </div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">自定义 CSS</label>
                                <textarea id="wc-setting-custom-css" class="wc-form-textarea" style="height: 150px; font-family: monospace; font-size: 12px;" placeholder="/* 输入 CSS 代码 */"></textarea>
                            </div>
                            <div class="wc-form-group">
                                <label class="wc-form-label">CSS 预设</label>
                                <div style="display: flex; gap: 10px;">
                                    <select id="wc-setting-css-preset-select" class="wc-form-input" style="flex: 1;" onchange="wcApplyCssPreset(this.value)">
                                        <option value="">选择预设...</option>
                                    </select>
                                    <button class="wc-ios-btn-block" style="width: 80px; padding: 0;" onclick="wcSaveCssPreset()">保存</button>
                                </div>
                            </div>
                        </div>

                        <!-- Data Management -->
                        <div class="wc-settings-section">
                            <div class="wc-settings-section-title">数据管理</div>
                            <button class="wc-ios-btn-block" style="background: var(--wc-danger-red);" onclick="wcClearChatHistory()">清空聊天记录</button>
                        </div>

                        <div style="height: 50px;"></div>
                    </div>
                </div>
            </div>

            <!-- 批量导入表情包弹窗 -->
            <div id="wc-import-sticker-modal" class="wc-modal hidden" style="z-index: 3100;">
                <div class="wc-modal-content">
                    <div class="wc-modal-header">
                        <h3>导入表情包</h3>
                        <button class="wc-close-btn" onclick="wcCloseModal('wc-import-sticker-modal')">&times;</button>
                    </div>
                    <div class="wc-modal-body">
                        <div class="wc-setting-group">
                            <label>分类名称</label>
                            <input type="text" id="wc-sticker-category-name" placeholder="例如：猫咪表情">
                        </div>
                        <div class="wc-setting-group">
                            <label>表情包列表 (格式: 描述：URL)</label>
                            <textarea id="wc-sticker-import-text" placeholder="开心：https://example.com/1.jpg&#10;难过：https://example.com/2.jpg" style="height: 200px;"></textarea>
                        </div>
                        <button id="wc-save-sticker-import-btn" class="wc-ios-btn-block" onclick="wcImportStickers()">导入</button>
                    </div>
                </div>
            </div>

            <!-- 表情包选项弹窗 -->
            <div id="wc-sticker-options-modal" class="wc-modal hidden" style="z-index: 3000; align-items: flex-end;">
                <div class="wc-modal-content" style="height: auto; border-radius: 12px 12px 0 0; width: 100%; max-width: 100%; background-color: transparent;">
                    <div class="wc-ios-list-group" style="margin: 0 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcToggleStickerDeleteMode(); wcCloseModal('wc-sticker-options-modal');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;" id="wc-btn-sticker-manage-text">管理表情 (删除)</span>
                        </div>
                        <div class="wc-list-item center-content" onclick="wcOpenModal('wc-import-sticker-modal'); wcCloseModal('wc-sticker-options-modal');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">导入表情</span>
                        </div>
                        <div class="wc-list-item center-content" onclick="wcOpenDeleteCategoriesModal(); wcCloseModal('wc-sticker-options-modal');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #FF3B30;">删除分类</span>
                        </div>
                    </div>
                    <div class="wc-ios-list-group" style="margin: 10px 10px 20px 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcCloseModal('wc-sticker-options-modal')" style="background: white; height: 56px;">
                            <span style="font-size: 18px; font-weight: bold; color: #007AFF;">取消</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 删除表情包分类弹窗 -->
            <div id="wc-sticker-delete-cats-modal" class="wc-modal hidden" style="z-index: 3100; align-items: flex-end;">
                <div class="wc-modal-content" style="height: auto; border-radius: 12px 12px 0 0; width: 100%; max-width: 100%; background-color: transparent;">
                    <div class="wc-ios-list-group" style="margin: 0 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item" style="background: white; padding: 12px 16px; font-weight: 600; justify-content: center;">选择要删除的表情包分类</div>
                        <div id="wc-sticker-delete-cats-list" style="background: #fff; display: flex; flex-direction: column; max-height: 300px; overflow-y: auto;">
                            <!-- Categories injected here -->
                        </div>
                    </div>
                    <div class="wc-ios-list-group" style="margin: 10px 10px 20px 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item" style="background: white; height: 56px; display: flex; gap: 10px; justify-content: center; align-items: center;">
                            <button class="wc-ios-btn-block" style="max-width: 160px; background: var(--wc-danger-red);" onclick="wcConfirmDeleteCategories()">删除所选</button>
                            <button class="wc-ios-btn-block wc-btn-secondary" style="max-width: 120px;" onclick="wcCloseModal('wc-sticker-delete-cats-modal')">取消</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Image Type Modal -->
            <div id="wc-modal-image-type" class="wc-modal hidden" style="z-index: 2200; align-items: flex-end;">
                <div class="wc-modal-content" style="height: auto; border-radius: 12px 12px 0 0; width: 100%; max-width: 100%; background-color: transparent;">
                    <div class="wc-ios-list-group" style="margin: 0 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcTriggerUpload('chat-img'); wcCloseModal('wc-modal-image-type');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">从相册选择</span>
                        </div>
                        <div class="wc-list-item center-content" onclick="wcActionImageDesc(); wcCloseModal('wc-modal-image-type');" style="background: white; height: 56px;">
                            <span style="font-size: 18px; color: #007AFF;">文字描述图片</span>
                        </div>
                    </div>
                    <div class="wc-ios-list-group" style="margin: 10px 10px 20px 10px; border-radius: 12px; overflow: hidden;">
                        <div class="wc-list-item center-content" onclick="wcCloseModal('wc-modal-image-type')" style="background: white; height: 56px;">
                            <span style="font-size: 18px; font-weight: bold; color: #007AFF;">取消</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden Inputs -->
            <input type="file" id="wc-file-input-char" accept="image/*" onchange="wcHandleFileSelect(event, 'char')" style="display:none;">
            <input type="file" id="wc-file-input-edit-char" accept="image/*" onchange="wcHandleFileSelect(event, 'edit-char')" style="display:none;">
            <input type="file" id="wc-file-input-user" accept="image/*" onchange="wcHandleFileSelect(event, 'user')" style="display:none;">
            <input type="file" id="wc-file-input-cover" accept="image/*" onchange="wcHandleFileSelect(event, 'cover')" style="display:none;">
            <input type="file" id="wc-file-input-moment" accept="image/*" onchange="wcHandleFileSelect(event, 'moment')" style="display:none;">
            <input type="file" id="wc-file-input-mask" accept="image/*" onchange="wcHandleFileSelect(event, 'mask')" style="display:none;">
            <input type="file" id="wc-file-input-chat-img" accept="image/*" onchange="wcHandleFileSelect(event, 'chat-img')" style="display:none;">
            
            <!-- Settings Inputs -->
            <input type="file" id="wc-file-input-setting-char" accept="image/*" onchange="wcHandleFileSelect(event, 'setting-char')" style="display:none;">
            <input type="file" id="wc-file-input-setting-user" accept="image/*" onchange="wcHandleFileSelect(event, 'setting-user')" style="display:none;">
            <input type="file" id="wc-file-input-setting-bg" accept="image/*" onchange="wcHandleFileSelect(event, 'setting-bg')" style="display:none;">

            <!-- Phone Sim Inputs -->
            <input type="file" id="wc-file-input-phone-bg" accept="image/*" onchange="wcHandleFileSelect(event, 'phone-bg')" style="display:none;">
            <input type="file" id="wc-file-input-sticky-note" accept="image/*" onchange="wcHandleFileSelect(event, 'sticky-note')" style="display:none;">
            <input type="file" id="wc-file-input-icon-msg" accept="image/*" onchange="wcHandleFileSelect(event, 'icon-msg')" style="display:none;">
            <input type="file" id="wc-file-input-icon-browser" accept="image/*" onchange="wcHandleFileSelect(event, 'icon-browser')" style="display:none;">
            <input type="file" id="wc-file-input-icon-cart" accept="image/*" onchange="wcHandleFileSelect(event, 'icon-cart')" style="display:none;">
            <input type="file" id="wc-file-input-icon-settings" accept="image/*" onchange="wcHandleFileSelect(event, 'icon-settings')" style="display:none;">

            <style id="wc-custom-css-style"></style>
        </div>
    </div>

    <style id="dynamic-font-style"></style>
    <!-- 【关键修改】引入 JS，添加版本号 ?v=3.0 强制刷新 -->
    <script src="script.js?v=3.0"></script>
    <script>
        // 【关键修改】PWA Service Worker 注册，添加版本号 ?v=3.0 强制刷新
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js?v=3.0')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>
